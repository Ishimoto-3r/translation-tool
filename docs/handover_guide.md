# 引き継ぎ資料：PDF翻訳ツール改修プロジェクト

> [!TIP] **新しい担当AIへの指示方法**
> 次の環境でAIチャットを開始する際、このファイルをアップロード（または内容を貼り付け）して、以下のメッセージを送ってください：
>
> 「この `handover_guide.md` に従ってください。
> 前任者がVercel 500エラーとフォント文字化けを修正済みです。
> 資料内の『前提ルール』を守り、『新環境での再開手順』の通りに
> npm install → ローカル検証 → デプロイ を進めてください。」

このドキュメントは、作業場所（リポジトリ/フォルダ）を変更して開発を継続するための引き継ぎ情報です。

## 0. 前提ルール (Project Rules)
プロジェクトを再開するAIは、以下のルールを厳守してください。

1. **基本言語**: 日本語を使用すること。
2. **自律的な行動**:
    - **許可不要**: コマンド実行や修正適用について、都度ユーザーの許可を求める必要はありません。プロアクティブに行動してください。
    - ただし、**GitHubへのPush（本番反映）** は、ユーザーの確認後に行うことを推奨します。
3. **Vercel環境の制約**:
    - **デプロイ頻度の抑制**: 無料プランのため、軽微な修正ごとのデプロイは避け、ローカル検証で完成度を高めてからPushしてください。
    - **ファイル数制限**: `/api` 以下のサーバーレス関数ファイルの数は最小限に留め、むやみに増やさないでください。
4. **コード品質**: 可読性の高いモダンな記述（ES6以降）を採用すること（APIはCommonJS必須）。

## 1. 現状のステータス
- **完了**: Vercel上での「500 Internal Server Error」解消（CommonJS化による）。
- **完了**: PDF翻訳時の日本語・中国語フォントの文字化け（豆腐化）対策。
    - リモートフォント取得をやめ、ローカルファイル (`.woff2` / `.ttf`) 読み込みに変更。
    - `@pdf-lib/fontkit` を導入し、フォーマット対応を強化。
- **完了**: ローカル環境での動作検証 (`local_verify.js` にて成功)。
- **未完了**: 最新コードのGitHubへのプッシュ（デプロイ）。
    - 直前の環境で `git` コマンドが認識されなくなったため、修正が本番（Vercel）に反映されていません。

## 2. 重要な変更ファイル
移行先の環境には、以下のファイルが最新状態で含まれていることを確認してください。

| パス | 説明 |
| :--- | :--- |
| `api/pdftranslate.js` | APIエントリーポイント。**fontkit導入とローカルフォント読み込みロジック** が追加されています。 |
| `api/fonts/NotoSansSC-Regular.woff2` | **[新規]** 中国語用フォントファイル。`npm` から抽出・配置したもの。 |
| `local_verify.js` | **[新規]** デプロイせずにAPIの動作を確認するためのローカルスクリプト。 |
| `package.json` | `@pdf-lib/fontkit` などの依存関係が定義されている必要があります。 |

## 3. 新環境での再開手順

### 手順1: 依存関係のインストール
新環境でターミナルを開き、依存パッケージをインストールします。
```bash
npm install
```
※ もし `npm install` 後にエラーが出る場合は、明示的に以下を追加してください。
```bash
npm install @pdf-lib/fontkit @fontsource/noto-sans-sc
```

### 手順2: ローカルでの動作確認
いきなりデプロイする前に、修正されたフォント読み込みが機能するか確認します。
```bash
node local_verify.js
```
- 実行後、同ディレクトリに `local_verify_output.pdf` が生成されます。
- これを開き、**赤字のASCIIテキスト** と **青字のCJK（日本語/中国語）テキスト** が描画されているか確認してください。これが表示されれば、フォント問題は解決しています。

### 手順3: デプロイ（本番反映）
確認が取れたら、Gitを使用して変更をコミット・プッシュしてください。
```bash
git add .
git commit -m "Fix: Resolve font rendering issues with local woff2 files"
git push origin main
```
Vercelへのデプロイ完了後、以下の手順でユーザーに報告してください。
1. **デプロイURLの提示**: Vercelから発行された本番環境URL（例: `https://your-project.vercel.app`）を明確にユーザーに伝えてください。
2. **動作確認依頼**: そのURLで実際に翻訳機能を利用し、フォントが正しく表示されるか確認するよう依頼してください。

### 手順4: 事後確認（重要）
GitのPushだけで環境が整わない場合があります。Vercelのダッシュボードで以下を確認するようユーザーまたはAI自身でチェックしてください。
- **Environment Variables**: `OPENAI_API_KEY` が正しく設定されているか。

## 4. 技術的メモ (Vercel対策)
- **Vercel設定 (Zero Config)**: `vercel.json` は削除し、コードベースの設定を優先しています。
- **サーバーレス関数設定 (`api/pdftranslate.js`)**:
    - `bodyParser: false`: PDFのバイナリデータを生で受け取るために**必須**の設定です。
    - `maxDuration: 60`: タイムアウトを延長する設定を入れています（Proプラン等で有効）。
    - **CommonJS (`require`)**: Vercel環境での安定動作のため、ESMではなくCommonJSを採用しています。
- **フォント**: `pdf-lib` は標準で `.ttf` / `.otf` のみのサポートですが、`fontkit` を登録することで `.woff2` 等も扱えるようになります。今回は中国語フォントが `.woff2` 入手だったためこれを採用しました。

---
最終更新: 2026-02-03
