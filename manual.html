<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AIãƒãƒ‹ãƒ¥ã‚¢ãƒ«åŸç¨¿ä½œæˆæ”¯æ´ãƒ„ãƒ¼ãƒ«</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/docx@7.1.0/build/index.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.4.2/mammoth.browser.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.10.377/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.10.377/pdf.worker.min.js";
    </script>
    <script src="https://unpkg.com/html-docx-js/dist/html-docx.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <style>
        body {
            font-family: "Meiryo UI", "Helvetica Neue", Arial, sans-serif;
        }
        .grid-layout {
            display: grid;
            grid-template-columns: 320px 1fr 380px;
            gap: 12px;
        }
        .col-panel {
            padding: 16px;
            display: flex;
            flex-direction: column;
        }
        .section-label {
            font-size: 0.75rem;
            font-weight: bold;
            border-left: 4px solid;
            padding-left: 6px;
            margin-bottom: 6px;
            display: block;
        }
        .border-green-500 { border-color:#22c55e; color:#15803d; }
        .border-blue-500  { border-color:#3b82f6; color:#1d4ed8; }
        .border-purple-500{ border-color:#a855f7; color:#7e22ce; }

        .drop-zone {
            border: 2px dashed #cbd5e1;
            border-radius: 6px;
            padding: 12px;
            text-align: center;
            transition: all 0.2s;
            cursor: pointer;
            background: #f8fafc;
            position: relative;
            display: flex;
            flex-direction: column;
            justify-content: center;
            min-height: 80px;
        }
        .drop-zone:hover {
            border-color: #9ca3af;
            background: #f1f5f9;
        }
        .drop-zone.dragover {
            border-color: #3b82f6;
            background: #eff6ff;
            transform: scale(1.02);
        }
        .file-overlay {
            position:absolute;
            top:0; left:0;
            width:100%; height:100%;
            opacity:0;
            cursor:pointer;
            z-index:10;
        }

        .genre-wrap-area {
            flex:1;
            overflow-y:auto;
            padding:8px;
            background:#f3f4f6;
            display:flex;
            flex-wrap:wrap;
            gap:8px;
            align-content:flex-start;
            min-height:200px;
        }
        .genre-group {
            width:calc(25% - 6px);
            min-width:160px;
            background:#fff;
            border:1px solid #d1d5db;
            border-radius:6px;
            display:flex;
            flex-direction:column;
            flex-shrink:0;
        }
        @media (max-width:1400px){ .genre-group{ width:calc(33.33% - 6px);} }
        @media (max-width:1100px){ .genre-group{ width:calc(50% - 4px);} }

        .genre-group-header {
            padding:6px 8px;
            font-size:.7rem;
            font-weight:bold;
            background:#f9fafb;
            border-bottom:1px solid #e5e7eb;
            color:#374151;
            display:flex;
            justify-content:space-between;
            align-items:center;
            border-top:3px solid transparent;
        }
        .genre-group-content {
            padding:4px;
            display:flex;
            flex-direction:column;
            gap:2px;
        }
        .checkbox-card {
            background:#fff;
            border:1px solid #f3f4f6;
            border-radius:3px;
            padding:3px 6px;
            display:flex;
            align-items:flex-start;
            font-size:.75rem;
            cursor:pointer;
            transition:.1s;
        }
        .checkbox-card:hover {
            border-color:#2563eb;
            background:#eff6ff;
        }
        .checkbox-card input {
            margin-right:6px;
            margin-top:3px;
            transform:scale(.9);
            flex-shrink:0;
            position:relative;
            z-index:5;
        }

        .company-card {
            background:#fff;
            border:1px solid #d1d5db;
            border-radius:6px;
            padding:8px;
            display:flex;
            align-items:center;
            justify-content:center;
            cursor:pointer;
            font-size:.8rem;
            font-weight:bold;
            color:#374151;
            transition:.2s;
            user-select:none;
        }
        .company-card.selected {
            border-color:#2563eb;
            background:#eff6ff;
            color:#1d4ed8;
            box-shadow:0 0 0 1px #2563eb;
        }
        .company-card i { margin-right:6px; }

        .editor-container {
            margin-bottom:8px;
            border:1px solid #e5e7eb;
            padding:6px;
            background:#fff;
            border-radius:4px;
        }
        .editor-header {
            font-size:.7rem;
            font-weight:bold;
            color:#6b7280;
            margin-bottom:4px;
            display:flex;
            justify-content:space-between;
            align-items:center;
        }
        .editor-wrapper {
            position:relative;
            display:inline-block;
            max-width:420px;
            max-height:320px;
            overflow:hidden;
            border:1px solid #ccc;
            border-radius:4px;
            background:#f9fafb;
        }
        .editor-img {
            display:block;
            max-width:100%;
            max-height:320px;
            height:auto;
            user-select:none;
        }
        .badge {
            position:absolute;
            width:20px;
            height:20px;
            background:rgba(255,0,0,.85);
            color:#fff;
            border-radius:50%;
            font-size:12px;
            font-weight:bold;
            display:flex;
            justify-content:center;
            align-items:center;
            cursor:grab;
            transform:translate(-50%,-50%);
            z-index:10;
            border:1px solid #fff;
        }

     .image-drop-zone {
    border:2px dashed #a78bfa;
    background:#faf5ff;
    transition:.2s;
    text-align:center;
    padding:12px;          /* 8 â†’ 12 */
    border-radius:6px;
    cursor:pointer;
    position:relative;
    min-height:120px;      /* 60 â†’ 120 ã§ã ã„ã¶å¤§ãã */
    display:flex;
    flex-direction:column;
    justify-content:center;
    align-items:center;    /* æ¨ªæ–¹å‘ã‚‚ä¸­å¤®å¯„ã› */
    margin-bottom:10px;    /* å°‘ã—ä½™ç™½ã‚’å¢—ã‚„ã™ */
}

/* === ãƒãƒ‹ãƒ¥ã‚¢ãƒ«AIãƒã‚§ãƒƒã‚¯ç”¨ãƒ‰ãƒ­ãƒƒãƒ—ã‚¾ãƒ¼ãƒ³ === */
.ai-check-drop {
    border: 2px dashed #f97316;   /* ã‚ªãƒ¬ãƒ³ã‚¸ç³» */
    background: #fff7ed;
    border-radius: 6px;
    padding: 10px;
    position: relative;
    cursor: pointer;
    min-height: 80px;
    display: flex;
    flex-direction: column;
    justify-content: center;
}
.ai-check-drop.dragover {
    border-color: #ea580c;
    background: #ffedd5;
}
/* ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠå¾Œã®è¦‹ãŸç›®ã‚’å°‘ã—å¼·èª¿ */
.ai-check-drop.has-file {
    border-style: solid;
    border-color: #ea580c;
    background: #ffedd5;
}




        
        .image-drop-zone.dragover {
            background:#f3e8ff;
            border-color:#7c3aed;
        }
        .preview-grid {
            display:grid;
            grid-template-columns:repeat(auto-fill,minmax(50px,1fr));
            gap:4px;
            margin-top:4px;
        }
        .preview-thumb {
            width:100%;
            height:50px;
            object-fit:cover;
            border-radius:4px;
            border:1px solid #ddd;
        }

        #loadingOverlay {
            position:fixed;
            top:0; left:0;
            width:100%; height:100%;
            background:rgba(255,255,255,.9);
            z-index:9998;
            display:none;
            justify-content:center;
            align-items:center;
            flex-direction:column;
        }
        .spinner {
            width:40px;
            height:40px;
            border:4px solid #e5e7eb;
            border-top-color:#3b82f6;
            border-radius:50%;
            animation:spin 1s linear infinite;
        }
        @keyframes spin {
            0%{transform:rotate(0deg);}
            100%{transform:rotate(360deg);}
        }

.parts-names-box {
    font-size:.7rem;
    line-height:1.4;
    border:1px solid #e5e7eb;
    border-radius:4px;
    padding:4px 6px;
    background:#f9fafb;
    white-space:pre-wrap;
    /* å†…éƒ¨ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’ã‚„ã‚ã‚‹ */
    max-height:none;
    overflow-y:visible;
}

/* --- ãƒ•ã‚©ãƒ³ãƒˆå…¨ä½“ã‚’å°‘ã—å¤§ããã™ã‚‹ --- */
body {
    font-family: "Meiryo UI", "Helvetica Neue", Arial, sans-serif;
    font-size: 14px;   /* ãƒ™ãƒ¼ã‚¹ãƒ•ã‚©ãƒ³ãƒˆã‚¢ãƒƒãƒ— */
}

/* Tailwind ã® text-[10px], text-[11px] ã‚’ä¸Šæ›¸ãã—ã¦å°‘ã—å¤§ããã™ã‚‹ */
.text-\[10px\] {
    font-size: 0.8rem !important;   /* ã ã„ãŸã„ 12.8px ç›¸å½“ */
}
.text-\[11px\] {
    font-size: 0.85rem !important;
}

/* ãƒ©ãƒ™ãƒ«ãªã©ã‚‚å°‘ã—å¤§ãã */
.section-label {
    font-size: 0.8rem;
}
.genre-group-header {
    font-size: 0.8rem;
}
.checkbox-card {
    font-size: 0.8rem;
}
.company-card {
    font-size: 0.85rem;
}

        

        #toast {
            position:fixed;
            bottom:16px;
            right:16px;
            background:#111827;
            color:#f9fafb;
            font-size:.75rem;
            padding:6px 10px;
            border-radius:6px;
            box-shadow:0 10px 15px rgba(0,0,0,.25);
            opacity:0;
            pointer-events:none;
            transition:opacity .25s ease;
            z-index:9999;
        }
        #toast.show { opacity:1; }









/* ãƒªãƒ³ã‚¯åˆ— */
.nav-links{
  display:flex;
  align-items:center;
  gap:8px;
}


  /* ===== è¦‹å‡ºã—ã‚’ã€ŒUIã®ã‚¿ã‚¤ãƒˆãƒ«ã€ã«æ ¼ä¸Šã’ ===== */
.ui-section-title{
  display:flex;
  align-items:center;
  gap:8px;
  font-weight:800;
  color:#111827;
  font-size:14px;
  margin:0 0 10px;
}
.ui-section-title .ui-ico{
  width:26px;
  height:26px;
  border-radius:8px;
  display:inline-flex;
  align-items:center;
  justify-content:center;
  background:#eef2ff;
  color:#1d4ed8;
  font-size:14px;
  box-shadow:0 1px 0 rgba(0,0,0,0.04);
}
.ui-section-sub{
  font-size:11px;
  color:#6b7280;
  margin:-6px 0 10px 34px;
}

/* å·¦ã‚«ãƒ©ãƒ ã®ã€Œ1. è£½å“æƒ…å ±ã€ã€Œ2. AIè§£æãƒ»è³‡æ–™ã€ã‚’è¦‹å‡ºã—åŒ– */
.section-label{
  font-size:13px;
  font-weight:800;
  padding-left:10px;
  margin-bottom:10px;
  border-left-width:6px;
  letter-spacing:.02em;
}

/* ä¸­å¤®ã‚«ãƒ©ãƒ ã®ãƒ–ãƒ­ãƒƒã‚¯ã‚¿ã‚¤ãƒˆãƒ«ï¼ˆåç¾©é¸æŠ / å®‰å…¨ãƒ»æ³¨æ„ã‚¸ãƒ£ãƒ³ãƒ«ï¼‰ã‚’å¼·èª¿ */
.panel-title{
  display:flex;
  align-items:center;
  gap:8px;
  font-size:13px;
  font-weight:800;
  color:#111827;
}
.panel-title .pill{
  font-size:11px;
  font-weight:800;
  padding:2px 8px;
  border-radius:999px;
  background:#f3f4f6;
  color:#374151;
}
      

/* ===== å…±é€šãƒ˜ãƒƒãƒ€ãƒ¼ï¼ˆç¿»è¨³ãƒ„ãƒ¼ãƒ«ã¨åŒã˜è¦‹ãŸç›®ï¼‰ ===== */
.tool-nav{
  position: sticky;
  top: 0;
  z-index: 9999;
  background: #374151;              /* é€ã‘ã•ã›ãªã„ï¼ˆã†ã£ã™ã‚‰æ–‡å­—ãŒè¦‹ãˆã‚‹å¯¾ç­–ï¼‰ */
  box-shadow: 0 2px 4px rgba(0,0,0,.18);
}

.tool-nav-inner{
  max-width: 1200px;
  margin: 0 auto;
  padding: 10px 16px;
  display: flex;
  justify-content: center;
  gap: 14px;
}

.nav-group{
  display: flex;
  flex-direction: column;            /* è¦‹å‡ºã—ã‚’â€œä¸Šâ€ã€ãƒœã‚¿ãƒ³ç¾¤ã‚’â€œä¸‹â€ã«ã™ã‚‹ */
  align-items: center;
  gap: 8px;
  padding: 8px 12px;
  border-radius: 12px;
  border: 1px solid rgba(255,255,255,.12);
  background: rgba(255,255,255,.04);
}

.nav-group-title{
  font-size: 12px;
  font-weight: 800;
  color: #cbd5e1;
  letter-spacing: .02em;
  line-height: 1;
}

.nav-links{
  display: flex;
  gap: 8px;
}

.tool-nav a{
  color: #f3f4f6;
  text-decoration: none;
  font-weight: 700;
  font-size: 14px;
  padding: 8px 12px;
  border-radius: 999px;
  background: rgba(255,255,255,.06);
  transition: background-color .15s ease, transform .15s ease;
}

.tool-nav a:hover{
  background: rgba(255,255,255,.12);
  transform: translateY(-1px);
}

.tool-nav a.active{
  background: #172554;
  color: #ffffff;
}


    </style>





</head>

<body class="bg-gray-100 text-gray-800">
    <nav class="tool-nav">
  <div class="tool-nav-inner">

    <div class="nav-group">
      <div class="nav-group-title">â­ç¿»è¨³</div>
      <div class="nav-links">
        <a href="/index.html">ç¿»è¨³ãƒ„ãƒ¼ãƒ«</a>
        <a href="/verify.html">æ¤œè¨¼çµæœç¿»è¨³</a>
        <a href="/column-translate.html">åˆ—æŒ‡å®šç¿»è¨³</a>
        <a href="/sheet-translate.html">ã‚·ãƒ¼ãƒˆç¿»è¨³</a>
        <a href="/word-translate.html">Wordç¿»è¨³</a>
      </div>
    </div>

    <div class="nav-group">
      <div class="nav-group-title">â­ãã®ä»–</div>
      <div class="nav-links">
        <a href="/report.html">ä¿®ç†ãƒ¬ãƒãƒ¼ãƒˆ</a>
        <a href="/manual.html" class="active">ãƒãƒ‹ãƒ¥ã‚¢ãƒ«</a>
                        <a href="/prompt.html">å˜ç™ºãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ</a>

      </div>
    </div>

  </div>
</nav>


<div id="loadingOverlay">
    <div class="spinner"></div>
    <div id="loadingText" class="mt-4 text-blue-600 font-bold text-lg">å‡¦ç†ä¸­...</div>
</div>

<div id="toast"></div>

<h1 class="text-xl font-extrabold text-gray-900 flex items-center gap-2 tracking-tight">
  <span class="inline-flex items-center justify-center w-8 h-8 rounded-full bg-green-600 text-white shadow-sm">ğŸ› ï¸</span>
  <span>ãƒãƒ‹ãƒ¥ã‚¢ãƒ«åŸç¨¿ä½œæˆæ”¯æ´ãƒ„ãƒ¼ãƒ«</span>
  <span class="text-xs font-semibold text-gray-500 ml-1">ChatGPT API</span>
</h1>


<div class="flex-1 container mx-auto max-w-full px-4 py-3 grid-layout">
    <!-- å·¦ã‚«ãƒ©ãƒ  -->
    <div class="col-panel bg-white rounded-lg shadow-sm">



        <div class="mb-6">
<h3 class="section-label border-blue-500 text-blue-700">ğŸ“¦ 1. è£½å“æƒ…å ±</h3>
    <div class="space-y-2">

        <label class="text-[10px] font-bold text-gray-600 block">
            å•†å“å
            <input type="text" id="productName"
                   class="w-full border rounded px-2 py-1.5 text-xs mt-0.5"
                   placeholder="å•†å“å">
        </label>

        <label class="text-[10px] font-bold text-gray-600 block">
            å‹ç•ª
            <input type="text" id="modelNumber"
                   class="w-full border rounded px-2 py-1.5 text-xs mt-0.5"
                   placeholder="å‹ç•ª">
        </label>

        <label class="text-[10px] font-bold text-gray-600 block">
            ä¿è¨¼æœŸé–“
            <select id="warrantyPeriod"
                    class="w-full border rounded px-2 py-1.5 text-xs bg-gray-50 mt-0.5"></select>
        </label>
    </div>
</div>


        <div class="mb-4">
<h3 class="section-label border-purple-500 text-purple-700">ğŸ§  2. AIè§£æãƒ»è³‡æ–™</h3>


            <!-- â‘  å„éƒ¨åç§°ãƒ»ãƒŠãƒ³ãƒãƒªãƒ³ã‚°ï¼ˆãã®ã¾ã¾ï¼‰ -->
            <div class="mb-2">
                <div class="image-drop-zone border-purple-300 bg-purple-50" id="partsImgDrop">
                    <h4 class="text-[10px] font-bold text-purple-700">â‘  å„éƒ¨åç§°ãƒ»ãƒŠãƒ³ãƒãƒªãƒ³ã‚°</h4>
                    <input type="file" id="partsImgInput" accept="image/*" multiple class="file-overlay">
                </div>
                <div id="partsPreview" class="preview-grid"></div>
            </div>

            <!-- â‘¡ å‚è€ƒè³‡æ–™ï¼šç”»åƒ + PDF/Word/TXT ã‚’ã¾ã¨ã‚ã¦æ‰±ã† -->
            <div class="mb-2">
                <div class="image-drop-zone border-blue-300 bg-blue-50" id="refDrop">
                    <h4 class="text-[10px] font-bold text-blue-700">
                        â‘¡ å‚è€ƒè³‡æ–™ï¼ˆç”»åƒ / PDF / Word / ãƒ†ã‚­ã‚¹ãƒˆï¼‰
                    </h4>
                    <input type="file" id="refInput"
                           accept=".pdf,.docx,.txt,image/*"
                           multiple class="file-overlay">
                </div>
                <div id="refFileList" class="mt-1 text-[10px] space-y-1"></div>
            </div>

            <!-- å‚è€ƒè³‡æ–™ã®åˆ©ç”¨æ–¹é‡ãªã©ã®ãƒ¡ãƒ¢ -->
            <label class="text-xs font-bold block mt-2 mb-1 text-gray-500">
                è£œè¶³ãƒ¡ãƒ¢ / å‚è€ƒè³‡æ–™ã®åˆ©ç”¨æ–¹é‡
            </label>
<textarea id="productFeatures" rows="5"
          class="w-full border rounded px-2 py-1.5 text-xs"
          style="min-height: 110px;"
          placeholder="ä¾‹ï¼‰è‡ªç¤¾æ—§ãƒ¢ãƒ‡ãƒ«ãƒãƒ‹ãƒ¥ã‚¢ãƒ«ï¼šæ§‹æˆã¨è¡¨ç¾ã¯ã»ã¼è¸è¥²ã—ã€ä»•æ§˜æ•°å€¤ã ã‘ä»Šå›ã®è£½å“ã«åˆã‚ã›ã¦ãã ã•ã„ã€‚
ä¾‹ï¼‰ä»–ç¤¾ãƒãƒ‹ãƒ¥ã‚¢ãƒ«ï¼šå®‰å…¨ä¸Šã®æ³¨æ„ã ã‘å‚è€ƒã«ã—ã€è¡¨ç¾ã¯å¤‰ãˆã¦ãã ã•ã„ã€‚"></textarea>
        </div>

    </div>

    <!-- ä¸­å¤®ã‚«ãƒ©ãƒ  -->
    <div class="col-panel bg-gray-50">
        <div class="mb-4 bg-white p-3 rounded shadow-sm">
            <div class="flex justify-between mb-2">
        <div class="panel-title">
  <span class="pill">å¿…é ˆ</span>
  <span>åç¾©é¸æŠ</span>
  <span class="text-xs text-gray-500">ğŸ·ï¸</span>
</div>

            </div>
                 <div class="flex gap-2">
                <div class="company-card flex-1" onclick="selectCompany('3R', this)">
                    <i class="far fa-circle"></i> ã‚¹ãƒªãƒ¼ã‚¢ãƒ¼ãƒ«
                </div>
                <div class="company-card flex-1" onclick="selectCompany('3RS', this)">
                    <i class="far fa-circle"></i> ã‚½ãƒªãƒ¥ãƒ¼ã‚·ãƒ§ãƒ³
                </div>
                <div class="company-card flex-1" onclick="selectCompany('OTHER', this)">
                    <i class="far fa-circle"></i> ãã®ä»–
                </div>
            </div>

        </div>

        <div class="flex-1 overflow-hidden flex flex-col">
            <div class="flex justify-between items-center mb-2 px-1">
         <div class="panel-title">
  <span>å®‰å…¨ãƒ»æ³¨æ„ã‚¸ãƒ£ãƒ³ãƒ«</span>
  <span class="text-xs text-gray-500">âš ï¸</span>
                 <a
      href="https://3rhd.sharepoint.com/:x:/r/sites/doc_share/DocLib2/%E5%95%86%E5%93%81%E9%96%8B%E7%99%BA%E3%83%81%E3%83%BC%E3%83%A0/ai-manual-database/database.xlsx?d=w8deb5def816b4890aa586b309de54dc5&csf=1&web=1&e=QXQeD6"
      target="_blank"
      rel="noopener"
      class="ml-2 text-xs font-bold text-blue-600 underline hover:text-blue-800 flex items-center gap-1"
    >
      <i class="fas fa-database"></i>
      database
    </a>
</div>

                <button onclick="clearChecks('genreArea')"
                        class="text-[10px] text-red-500 hover:underline">å…¨è§£é™¤</button>
            </div>
<div id="genreArea" class="genre-wrap-area border rounded flex-1 mb-3">
    <div class="w-full text-center text-sm text-gray-500 py-10 flex flex-col items-center justify-center gap-2">
        <i class="fas fa-spinner fa-spin text-xl text-blue-500"></i>
        <div>SharePoint ã‹ã‚‰Manual-databaseã‚’èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™...</div>
    </div>
</div>



        </div>

        <!-- å„éƒ¨åç§°ã‚¨ãƒ‡ã‚£ã‚¿ -->
<div id="editorArea"
     class="bg-purple-50 p-2 rounded shadow-sm hidden mb-2 border border-purple-200">
</div>


        <button onclick="runGenerationProcess()" id="genBtn"
                class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 rounded shadow text-sm flex-none flex justify-center items-center gap-2">
            <i class="fas fa-pen-fancy"></i> åŸç¨¿ã‚’ç”Ÿæˆã™ã‚‹
        </button>
    </div>

       <!-- å³ã‚«ãƒ©ãƒ ï¼šä¸Š = ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ / ä¸‹ = AIãƒã‚§ãƒƒã‚¯ -->
    <div class="col-panel bg-white rounded-lg shadow-sm flex flex-col">
        <!-- ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚¨ãƒªã‚¢ï¼ˆé«˜ã•ã‚’å°‘ã—ç¸®ã‚ã‚‹ï¼‰ -->
        <div class="flex flex-col mb-3 flex-[0_0_55%] min-h-[260px]">
            <div class="flex justify-between items-center mb-2">
                <h3 class="font-bold text-sm text-gray-700">ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</h3>
                <div class="flex gap-2">
                    <button onclick="document.getElementById('previewArea').value=''"
                            class="text-xs bg-gray-200 px-2 py-1 rounded hover:bg-gray-300">ã‚¯ãƒªã‚¢</button>
                    <button onclick="exportToWord()"
                            class="text-xs bg-blue-600 text-white px-3 py-1 rounded font-bold hover:bg-blue-700">
                        <i class="fas fa-file-word"></i> Wordä¿å­˜
                    </button>
                </div>
            </div>
            <textarea id="previewArea"
                      class="flex-1 w-full border rounded p-3 font-mono text-xs resize-none bg-gray-50 leading-relaxed"></textarea>
        </div>

        <!-- â–¼â–¼ æ–°æ©Ÿèƒ½ï¼šãƒãƒ‹ãƒ¥ã‚¢ãƒ«åŸç¨¿AIãƒã‚§ãƒƒã‚¯ â–¼â–¼ -->
        <div class="mt-1 flex-1">
            <div class="border border-amber-400 rounded-lg bg-amber-50 p-3 h-full flex flex-col">
                <div class="flex items-center justify-between mb-2">
                    <div class="flex items-center gap-2">
                        <span class="inline-flex items-center justify-center w-6 h-6 rounded-full bg-amber-400 text-white text-xs font-bold">AI</span>
                        <div>
                            <div class="text-sm font-bold text-amber-800">ãƒãƒ‹ãƒ¥ã‚¢ãƒ«åŸç¨¿AIãƒã‚§ãƒƒã‚¯</div>
                            <div class="text-[10px] text-amber-800">
                                ä½œæˆæ¸ˆã¿ãƒãƒ‹ãƒ¥ã‚¢ãƒ«ã®æ—¥æœ¬èªè¡¨ç¾ãƒ»è¡¨è¨˜ã‚†ã‚Œã‚’AIãŒãƒ€ãƒ–ãƒ«ãƒã‚§ãƒƒã‚¯ã—ã¾ã™ã€‚
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ãƒ‰ãƒ­ãƒƒãƒ—ã‚¾ãƒ¼ãƒ³ -->
            <div id="aiCheckDrop"
     class="ai-check-drop mb-2">
    <div class="text-[10px] font-bold text-amber-800 mb-1">
        ãƒãƒ‹ãƒ¥ã‚¢ãƒ«åŸç¨¿ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—ï¼ˆ.docxï¼‰
    </div>
    <div class="text-[10px] text-amber-700">
        ä½œæˆã—ãŸãƒãƒ‹ãƒ¥ã‚¢ãƒ«åŸç¨¿ã‚’ã“ã“ã«ãƒ‰ãƒ­ãƒƒãƒ—ã—ã¦ãã ã•ã„ï¼ˆ.docxï¼‰ã€‚<br>
        ãƒ‰ãƒ­ãƒƒãƒ—ã—ãŸåŸç¨¿ã®æ—¥æœ¬èªè¡¨ç¾ãƒ»è¡¨è¨˜ã‚†ã‚Œã‚’AIãŒãƒã‚§ãƒƒã‚¯ã—ã¾ã™ã€‚
    </div>
   <input type="file" id="aiCheckFile" accept=".docx" class="file-overlay">
</div>


                <!-- ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤º -->
                <div id="aiCheckStatus" class="text-[10px] text-amber-800 mb-2 h-10 overflow-hidden">
                    ãƒ•ã‚¡ã‚¤ãƒ«æœªé¸æŠ
                </div>

                <!-- ãƒœã‚¿ãƒ³ç¾¤ -->
                <div class="mt-auto flex flex-col gap-1">
                  <button id="aiCheckBtn"
        onclick="runAiCheck()"
        class="w-full text-xs font-bold py-2 rounded bg-amber-600 text-white disabled:opacity-40 disabled:cursor-not-allowed hover:bg-amber-700">
    <i class="fas fa-magnifying-glass-check mr-1"></i> AIãƒã‚§ãƒƒã‚¯ã‚’å®Ÿè¡Œ
</button>

        <div class="text-[10px] text-amber-900">
    ãƒ»ãƒã‚§ãƒƒã‚¯ã‚³ãƒ¡ãƒ³ãƒˆã¯å•é¡Œã®è¡Œã®ã€Œæ¬¡ã®è¡Œã€ã«èµ¤å­—ã§æŒ¿å…¥ã—ã¾ã™ã€‚<br>
    ãƒ»ç·åˆçš„ãªã‚³ãƒ¡ãƒ³ãƒˆã¯æœ«å°¾ã«ã€Œç·è©•ã€ã¨ã—ã¦è¿½è¨˜ã—ã¾ã™ã€‚
</div>


                </div>
            </div>
        </div>
        <!-- â–²â–² æ–°æ©Ÿèƒ½ã“ã“ã¾ã§ â–²â–² -->
    </div>

</div>

<canvas id="processCanvas" style="display:none;"></canvas>

<script>
/* ---- ã‚°ãƒ­ãƒ¼ãƒãƒ« ---- */
let RAW_DATA = [];
let SELECTED_COMPANY = "";
let PARTS_IMAGES = [];
let USAGE_IMAGES = [];
let REF_TEXT = "";
let LIB_READY = false;
let toastTimer = null;
let TEMPLATES = [];        // å®šå‹æ–‡
let AI_TERM_RULES = [];    // è¡¨è¨˜ãƒ«ãƒ¼ãƒ«ï¼ˆè¡¨è¨˜ã‚†ã‚Œç”¨ï¼‰

// â–¼ AIãƒã‚§ãƒƒã‚¯é–¢é€£
let AICHECK_TEXT = "";           // txt ãƒ¢ãƒ¼ãƒ‰ç”¨ï¼šAIãƒã‚§ãƒƒã‚¯å¯¾è±¡ã®ãƒãƒ‹ãƒ¥ã‚¢ãƒ«æœ¬æ–‡
let AICHECK_FILENAME = "";       // å…ƒãƒ•ã‚¡ã‚¤ãƒ«å
let AICHECK_IS_DOCX = false;     // true: docx ã‚’ AIãƒã‚§ãƒƒã‚¯ä¸­ / false: txt ãƒ¢ãƒ¼ãƒ‰
let AICHECK_DOCX_BUFFER = null;  // docx ãƒ¢ãƒ¼ãƒ‰ç”¨ï¼šå…ƒã® .docx ã® ArrayBuffer
let AICHECK_PARAGRAPHS = [];     // docx ãƒ¢ãƒ¼ãƒ‰ç”¨ï¼š{ pid, text, section, pIndex }




/* ---- å®šæ•° ---- */
const TERMINOLOGY = [
    {p:/ã‚»ãƒ³ã‚µãƒ¼/g,r:"ã‚»ãƒ³ã‚µ"},
    {p:/ãƒ¢ãƒ‹ã‚¿ãƒ¼/g,r:"ãƒ¢ãƒ‹ã‚¿"},
    {p:/ãƒãƒƒãƒ†ãƒªãƒ¼/g,r:"ãƒãƒƒãƒ†ãƒª"},
    {p:/ã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ã‚¿ãƒ¼/g,r:"ã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ã‚¿"},
    {p:/ãƒ—ãƒªãƒ³ã‚¿ãƒ¼/g,r:"ãƒ—ãƒªãƒ³ã‚¿"},
    {p:/ã‚¢ãƒ€ãƒ—ã‚¿ãƒ¼/g,r:"ã‚¢ãƒ€ãƒ—ã‚¿"}
];

const SPEC_WARNING_LINE =
"â€»ä¸Šè¨˜ä»•æ§˜å€¤ã¯å‚è€ƒå…ƒã®å–æ‰±èª¬æ˜æ›¸ã«è¨˜è¼‰ã•ã‚ŒãŸæƒ…å ±ã§ã‚ã‚Šã€æœ¬è£½å“ã®æœ€çµ‚ä»•æ§˜ã¨ã¯ç•°ãªã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ã€‚å¿…ãšæœ€æ–°ã®ä»•æ§˜ã‚’ã”ç¢ºèªãã ã•ã„ã€‚";

    // â˜…ã“ã“ã‹ã‚‰è¿½åŠ 
function getTemplateTexts(group) {
    if (!Array.isArray(TEMPLATES)) return [];
    return TEMPLATES
        .filter(t => t.group === group)
        .sort((a, b) => (a.order || 0) - (b.order || 0))
        .map(t => t.text);
}
// â˜…ã“ã“ã¾ã§è¿½åŠ 

/* ---- åˆæœŸåŒ– ---- */
window.onload = () => {
    const checkLib = setInterval(() => {
        if (typeof XLSX !== "undefined") {
            clearInterval(checkLib);
            LIB_READY = true;
            document.getElementById("loadingOverlay").style.display = "none";
            document.getElementById("genBtn").disabled = false;
        }
    }, 500);

    setTimeout(() => {
        if (!LIB_READY) {
            clearInterval(checkLib);
            alert("ã€é‡è¦ã€‘Excelèª­è¾¼ãƒ—ãƒ­ã‚°ãƒ©ãƒ ãŒãƒ­ãƒ¼ãƒ‰ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚");
            document.getElementById("loadingOverlay").style.display = "none";
        }
    }, 8000);

    const sel = document.getElementById("warrantyPeriod");
    ["æœªå®š(è¦ç¢ºèª)", "7æ—¥é–“", ...[...Array(11)].map((_, i) => `${i + 1}ã‚«æœˆé–“`), "1å¹´é–“"]
        .flat()
        .forEach(t => {
            const opt = document.createElement("option");
            opt.value = t.includes("æœªå®š") ? "ï¼ˆä¿è¨¼æœŸé–“ï¼‰" : `ã”è³¼å…¥ã‹ã‚‰${t}`;
            opt.innerText = t;
            if (t === "1å¹´é–“") opt.selected = true;
            sel.appendChild(opt);
        });

    // Excel ãƒ‰ãƒ­ãƒƒãƒ—ã¯å»ƒæ­¢ã—ãŸã®ã§ã“ã“ã¯ä½•ã‚‚å‘¼ã°ãªã„
    // setupOverlayDrop("excelDrop", "excelInput", loadExcel);

    setupOverlayDrop("partsImgDrop", "partsImgInput", f => loadImages(f, "parts"));
    setupOverlayDrop("refDrop", "refInput", loadRefs);
    // â˜… ãƒãƒ‹ãƒ¥ã‚¢ãƒ«AIãƒã‚§ãƒƒã‚¯ç”¨ãƒ‰ãƒ­ãƒƒãƒ—ã‚¾ãƒ¼ãƒ³
    setupOverlayDrop("aiCheckDrop", "aiCheckFile", handleAiCheckFiles);


    window.addEventListener("paste", e => {
        const items = e.clipboardData.items;
        for (let i = 0; i < items.length; i++) {
            if (items[i].type.indexOf("image") !== -1) {
                loadImages([items[i].getAsFile()], "parts");
                break;
            }
        }
    });

    const saved = localStorage.getItem("manual_tool_api_key");
    if (saved) {
        API_KEY = saved;
        const keyInput = document.getElementById("apiKey");
        if (keyInput) keyInput.value = "********";
    }

    renderImageEditors();

    // â˜… ãƒšãƒ¼ã‚¸è¡¨ç¤ºæ™‚ã«è‡ªå‹•ã§ SharePoint ã‹ã‚‰ Excel ã‚’èª­è¾¼
    loadExcelFromServer();
};


async function loadExcelFromServer() {
  const gArea = document.getElementById("genreArea");

  // èª­ã¿è¾¼ã¿ä¸­ã®è¡¨ç¤º
  if (gArea) {
    gArea.innerHTML = `
      <div class="w-full text-center text-sm text-gray-500 py-10 flex flex-col items-center justify-center gap-2">
        <i class="fas fa-spinner fa-spin text-xl text-blue-500"></i>
        <div>SharePoint ã‹ã‚‰Manual-databaseã‚’èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™...</div>
      </div>`;
  }

  try {
    const res = await fetch("/api/manual-test");
    if (!res.ok) {
      throw new Error("HTTP " + res.status + " " + res.statusText);
    }

    const data = await res.json();
    console.log("[loadExcelFromServer] response:", data);

    // rows / templates / termRules ã‚’æ ¼ç´
    RAW_DATA       = Array.isArray(data.rows)      ? data.rows      : [];
    TEMPLATES      = Array.isArray(data.templates) ? data.templates : [];
    AI_TERM_RULES  = Array.isArray(data.termRules) ? data.termRules : [];

    console.log("TEMPLATES:", TEMPLATES);
    console.log("AI_TERM_RULES:", AI_TERM_RULES);
    renderCheckboxes();


  } catch (err) {
    console.error("[loadExcelFromServer] error:", err);
    if (gArea) {
      gArea.innerHTML = `
        <div class="w-full text-center text-sm text-red-500 py-10">
          SharePoint ã‹ã‚‰ã®ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚<br>
          ${err.message}
        </div>`;
    }
  }
}




/* ---- å…±é€šãƒ˜ãƒ«ãƒ‘ãƒ¼ ---- */
function showToast(msg){
    const t = document.getElementById("toast");
    t.textContent = msg;
    t.classList.add("show");
    if(toastTimer) clearTimeout(toastTimer);
    toastTimer = setTimeout(()=>t.classList.remove("show"), 2500);
}

function saveKey() {
  alert("ã“ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã§ã¯ãƒ–ãƒ©ã‚¦ã‚¶å´ã§ã® APIã‚­ãƒ¼è¨­å®šã¯ä¸è¦ã§ã™ï¼ˆã‚µãƒ¼ãƒãƒ¼å´ã§ç®¡ç†ã—ã¦ã„ã¾ã™ï¼‰ã€‚");
}


function selectCompany(code, el){
    SELECTED_COMPANY = code;

    document.querySelectorAll(".company-card").forEach(c => {
        c.classList.remove("selected");
        const icon = c.querySelector("i");
        if(icon){
            icon.className = "far fa-circle";   // ç©ºã®ä¸¸ã«æˆ»ã™
        }
    });

    el.classList.add("selected");
    const icon = el.querySelector("i");
    if(icon){
        icon.className = "fas fa-check-circle"; // å¡—ã‚Šã¤ã¶ã—ä¸¸ã«å¤‰æ›´
    }
}

// ç”»åƒãƒ©ãƒ™ãƒ«ã ã‘ã®æ®µè½ã‚’é™¤å¤–ï¼ˆä¾‹ï¼šï¼ˆç”»åƒ1ï¼‰, ç”»åƒ1, (ç”»åƒ 1)ï¼‰
function isImageLabelOnlyParagraph(text) {
  const s = String(text || "").trim();

  // ï¼ˆç”»åƒ1ï¼‰/ (ç”»åƒ1) / ï¼ˆç”»åƒ 1ï¼‰/ ç”»åƒ1 / ç”»åƒ 1
  if (/^[ï¼ˆ(]?\s*ç”»åƒ\s*\d+\s*[)ï¼‰]?$/.test(s)) return true;

  // ã¤ã„ã§ã«ã€Œå›³1ã€ã‚‚åŒæ§˜ã«é™¤å¤–ã—ãŸã„å ´åˆã¯æœ‰åŠ¹åŒ–
  // if (/^[ï¼ˆ(]?\s*å›³\s*\d+\s*[)ï¼‰]?$/.test(s)) return true;

  return false;
}


    
/* === docx æ®µè½è§£æï¼†ã‚³ãƒ¡ãƒ³ãƒˆæŒ¿å…¥ç”¨ãƒ˜ãƒ«ãƒ‘ãƒ¼ === */

function isNumberingOnlyParagraph(text) {
    if (!text) return false;
    const s = String(text).trim();
    if (!s) return false;

    // ç©ºç™½é™¤å» + æ–‡å­—ç¨®æ­£è¦åŒ–ï¼ˆå…¨è§’â†’åŠè§’ãªã©ï¼‰
    const t = s.normalize("NFKC").replace(/\s+/g, "");

    // â‘ â‘¡â‘¢ / (1)(2) / ï¼ˆ1ï¼‰ï¼ˆ2ï¼‰ / 1,2,3 / 1.2.3 / 1-2-3 ç­‰ã€Œç•ªå·ã ã‘ã€ç³»
    const onlyNumSymbols =
        /^[0-9ï¼-ï¼™()ï¼ˆï¼‰ï¼»\[\]ã€ã€‘{}ï½›ï½<>ï¼œï¼.,ï¼ï¼Œã€ãƒ»\-ãƒ¼ï¼‹+Ã—xX*ï¼Š#ï¼ƒ\u2460-\u2473\u2474-\u2487\u2776-\u277F]+$/;

    if (onlyNumSymbols.test(t)) return true;

    // æ‹¬å¼§ä»˜ãæ•°å­—ãŒ2å›ä»¥ä¸Šé€£ç¶šï¼ˆä¾‹ï¼š(1)(2)(3) / ï¼ˆ1ï¼‰ï¼ˆ2ï¼‰ï¼‰
    const repeatedParenNums = /^([ï¼ˆ(]?\s*\d+\s*[)ï¼‰]?\s*){2,}$/;
    if (repeatedParenNums.test(s)) return true;

    // ä¸¸ä»˜ãæ•°å­—ãŒ3å€‹ä»¥ä¸Šå«ã¾ã‚Œã¦ã„ã¦æœ¬æ–‡ãŒçŸ­ã„ï¼ˆç”»åƒç•ªå·åˆ—ãªã©ï¼‰
    const circledCount = (s.match(/[\u2460-\u2473\u2474-\u2487\u2776-\u277F]/g) || []).length;
    if (circledCount >= 3 && t.length <= 30) return true;

    return false;
}





    
/**
 * word/document.xml ã® w:p ã‹ã‚‰ãƒ†ã‚­ã‚¹ãƒˆã‚’æŠ½å‡º
 */
function extractTextFromParagraph(pElem) {
    const wNs = "http://schemas.openxmlformats.org/wordprocessingml/2006/main";
    const texts = [];
    const tNodes = pElem.getElementsByTagNameNS(wNs, "t");
    for (let i = 0; i < tNodes.length; i++) {
        texts.push(tNodes[i].textContent || "");
    }
    return texts.join("").replace(/\r/g, "");
}


// === docx æ®µè½çµåˆï¼ˆAIãƒã‚§ãƒƒã‚¯ç”¨ï¼‰===
// collected: [{ text, pIndex }]
function mergeDocxParagraphsForAiCheck(collected) {
  const out = [];
  if (!Array.isArray(collected) || !collected.length) return out;

  let buf = "";
  let lastIndex = null;

  const flush = () => {
    const t = (buf || "").trim();
    if (t) out.push({ text: t, pIndexLast: lastIndex });
    buf = "";
    lastIndex = null;
  };

  for (let i = 0; i < collected.length; i++) {
    const curr = collected[i];
    const next = collected[i + 1];

    const currText = (curr.text || "").trim();
    if (!currText) continue;

    if (!buf) buf = currText;
    else buf += " " + currText;

    lastIndex = curr.pIndex;

    const nextText = next ? (next.text || "").trim() : "";
    if (shouldBreakBeforeNext(currText, nextText)) {
      flush();
    }
  }
  flush();
  return out;
}



    
// â˜…ä¿®æ­£ç‰ˆï¼šdocx(ArrayBuffer) â†’ AICHECK_PARAGRAPHS ã‚’ç¢ºå®Ÿã«æ§‹ç¯‰ï¼ˆã“ã‚Œ1ã¤ã ã‘æ®‹ã™ï¼‰
async function parseDocxParagraphsFromArrayBuffer(arrayBuffer) {
    AICHECK_PARAGRAPHS = [];

    if (typeof JSZip === "undefined") {
        throw new Error("JSZip is not loaded.");
    }

    const zip = await JSZip.loadAsync(arrayBuffer);
    const docFile = zip.file("word/document.xml");
    if (!docFile) {
        throw new Error("word/document.xml not found in docx");
    }

    const docXml = await docFile.async("text");

    const parser = new DOMParser();
    const xmlDoc = parser.parseFromString(docXml, "application/xml");

    // ãƒ‘ãƒ¼ã‚¹ã‚¨ãƒ©ãƒ¼æ¤œçŸ¥
    const perr = xmlDoc.getElementsByTagName("parsererror");
    if (perr && perr.length) {
        throw new Error("Failed to parse document.xml");
    }

    const wNs = "http://schemas.openxmlformats.org/wordprocessingml/2006/main";
    const pList = Array.from(xmlDoc.getElementsByTagNameNS(wNs, "p"));

    const safetyHeads = new Set([
        "â– å®‰å…¨ä¸Šã®ã”æ³¨æ„","â– å®‰å…¨ä¸Šã®æ³¨æ„","â–  å®‰å…¨ä¸Šã®ã”æ³¨æ„","â–  å®‰å…¨ä¸Šã®æ³¨æ„",
        "å®‰å…¨ä¸Šã®ã”æ³¨æ„","å®‰å…¨ä¸Šã®æ³¨æ„"
    ]);

const EXCLUDE_HEADINGS = new Set([
  "â– ã‚µãƒãƒ¼ãƒˆãƒ»ä¼æ¥­æƒ…å ±",
  "â– ã”ä½¿ç”¨æ¸ˆã¿ã®è£½å“ã®å»ƒæ£„ã«é–¢ã—ã¦",
  "â– é›»æ³¢ã«é–¢ã™ã‚‹æ³¨æ„äº‹é …",
  "â– æŠ€é©ãƒãƒ¼ã‚¯",

  // â˜…è¿½åŠ ï¼šä»•æ§˜ã¯AIãƒã‚§ãƒƒã‚¯å¯¾è±¡å¤–
  "â– ä»•æ§˜",
  "â–  ä»•æ§˜",
  "ä»•æ§˜",
  " ä»•æ§˜",
]);


    // ã¾ãšå…¨æ–‡ã‹ã‚‰ã€Œå®‰å…¨è¦‹å‡ºã—ãŒã‚ã‚‹ã‹ã€ã‚’ç¢ºèª
    const allTexts = pList
        .map(p => (extractTextFromParagraph(p) || "").trim())
        .filter(Boolean);

    const hasSafetyHeading = allTexts.some(t => safetyHeads.has(t));

    // åé›†
    let currentHeading = "";
    let inExcludedSection = false;
    let startCollect = !hasSafetyHeading;

    const collected = []; // { text, pIndex }

    for (let i = 0; i < pList.length; i++) {
        const p = pList[i];
        const textRaw = extractTextFromParagraph(p);
        const text = normalizeWordTextForAiCheck(textRaw);
        if (!text) continue;

        const isHeadingLike = text.startsWith("â– ") || safetyHeads.has(text);

        if (isHeadingLike) {
            currentHeading = text.startsWith("â– ") ? text : ("â– " + text);
            inExcludedSection = EXCLUDE_HEADINGS.has(currentHeading);

            if (safetyHeads.has(text) || safetyHeads.has(currentHeading)) {
                startCollect = true;
            }
            continue;
        }

        if (!startCollect) continue;
        if (inExcludedSection) continue;

        // ç•ªå·ã ã‘æ®µè½ã¯é™¤å¤–
if (isNumberingOnlyParagraph(text)) continue;

// <å±é™º> / <è­¦å‘Š> ãªã©ã€Œãƒˆãƒ¼ã‚¯ãƒ³è¦‹å‡ºã—ã€ã ã‘ã®è¡Œã¯é™¤å¤–
if (/^<[^>]+>$/.test(text)) continue;

// ï¼ˆç”»åƒ1ï¼‰/ ç”»åƒ1 ãªã©ã€Œç”»åƒãƒ©ãƒ™ãƒ«ã ã‘ã€ã®è¡Œã¯é™¤å¤–
if (isImageLabelOnlyParagraph(text)) continue;

collected.push({ text, pIndex: i });

    }

    // æ®µè½çµåˆï¼ˆçµåˆé–¢æ•°ã¯æ—¢å­˜ã®ã‚‚ã®ã‚’ä½¿ã†ï¼‰
    const merged = mergeDocxParagraphsForAiCheck(collected);

    // PID ä»˜ä¸ã—ã¦ AICHECK_PARAGRAPHS ã«æ ¼ç´
    let pidCounter = 0;
    for (const m of merged) {
        const pid = "P" + String(pidCounter).padStart(3, "0");
        pidCounter++;

        AICHECK_PARAGRAPHS.push({
            pid,
            text: m.text,
            section: "normal",
            // çµåˆå¾Œã‚³ãƒ¡ãƒ³ãƒˆæŒ¿å…¥ä½ç½®ï¼šæœ€å¾Œã®æ®µè½
            pIndex: m.pIndexLast
        });
    }

    return AICHECK_PARAGRAPHS;
}


function normalizeWordTextForAiCheck(textRaw) {
  let s = (textRaw || "");

  // 1) æ®µè½å†…ã®æ‰‹å‹•æ”¹è¡Œï¼ˆShift+Enter ç­‰ï¼‰ã‚’ã€Œæ¶ˆã™ã€
  //   â€» ã“ã“ãŒä»Šå›ã®æ®‹ã‚Š1ä»¶ã«ä¸€ç•ªåŠ¹ã
  s = s.replace(/\r\n|\r|\n/g, "");

  // 2) Wordç”±æ¥ã®ä½™è¨ˆãªç©ºç™½ã‚’æ•´å½¢ï¼ˆå¿…è¦ãªã‚‰å¼±ã‚ã¦OKï¼‰
  s = s.replace(/[ \t]+/g, " ");
  s = s.replace(/ã€€+/g, " ");            // å…¨è§’ã‚¹ãƒšãƒ¼ã‚¹é€£ç¶šã‚’åœ§ç¸®
  s = s.replace(/\s+([ã€ã€‚ï¼.!ï¼ï¼Ÿ\?ã€ã€ã€‘ï¼‰)\]])/g, "$1"); // å¥èª­ç‚¹/é–‰ã˜æ‹¬å¼§ã®å‰ã®ç©ºç™½é™¤å»
  s = s.replace(/([ã€Œã€ï¼ˆã€\[])\s+/g, "$1");              // é–‹ãæ‹¬å¼§ç›´å¾Œã®ç©ºç™½é™¤å»

  return s.trim();
}

    

    

/* === AIãƒã‚§ãƒƒã‚¯ç”¨ï¼šé€”ä¸­æ”¹è¡Œã®æ®µè½çµåˆãƒ˜ãƒ«ãƒ‘ãƒ¼ === */

// è¦‹å‡ºã—/ç®‡æ¡æ›¸ã/æ³¨æ„ãƒ©ãƒ™ãƒ«/ç•ªå·æ®µè½ã£ã½ã„ã‚‚ã®ã¯ã€Œåˆ¥é …ç›®ã€ã¨ã—ã¦æ‰±ã„ã€çµåˆã—ãªã„
function isStructuralParagraph(text) {
    if (!text) return false;
    const s = String(text).trim();
    if (!s) return true;

    // è¦‹å‡ºã—
    if (s.startsWith("â– ") || /^ã€.+ã€‘$/.test(s)) return true;

    // ç®‡æ¡æ›¸ã/æ³¨æ„/å±é™ºãƒ©ãƒ™ãƒ«ç­‰
    if (s.startsWith("ãƒ»") || s.startsWith("â€»")) return true;
    if (/^<[^>]+>$/.test(s)) return true; // <å±é™º> ãªã©

    // å…¸å‹çš„ãªç•ªå·é–‹å§‹ï¼ˆ1. / 1) / (1) / â‘  ãªã©ï¼‰
    if (/^(\(?\d+\)?[.\)ï¼‰]|[\u2460-\u2473\u2474-\u2487\u2776-\u277F])\s*/.test(s)) return true;

    // ã€Œç•ªå·ã ã‘æ®µè½ã€ã¯æ§‹é€ æ‰±ã„ï¼ˆã™ã§ã«åˆ¥é–¢æ•°ã§ã‚‚é™¤å¤–ã—ã¦ã‚‹ãŒä¿é™ºï¼‰
    if (isNumberingOnlyParagraph(s)) return true;

    return false;
}

// æ–‡ã®çµ‚ç«¯ã£ã½ã„ã‹ï¼ˆã€Œã€‚ã€ãŒç„¡ã„æ–‡ã‚‚ã‚ã‚‹ã®ã§è¤‡æ•°æ¡ä»¶ï¼‰
function isSentenceEndLike(text) {
    if (!text) return false;
    const s = String(text).trim();
    if (!s) return true;

    // æ˜ç¢ºãªçµ‚ç«¯
    if (/[ã€‚ï¼ï¼Ÿ!?]$/.test(s)) return true;

    // é–‰ã˜è¨˜å·ã§çµ‚ã‚ã£ã¦ã„ã¦ã€ãã“ãã“é•·ã„ãªã‚‰çµ‚ç«¯æ‰±ã„ï¼ˆæ³¨è¨˜/è¦‹å‡ºã—é¢¨ã®å®Œçµæ–‡ï¼‰
    if (/[ï¼‰\]ã€‘ã€•ã€]$/.test(s) && s.length >= 12) return true;

    return false;
}

// æ¬¡æ®µè½ãŒæ¥ãŸã‚‰ã€Œã“ã“ã§çµåˆã‚’æ­¢ã‚ã‚‹ã¹ãã€ã‹
function shouldBreakBeforeNext(currText, nextText) {
    if (!nextText) return true;                 // æ¬¡ãŒç„¡ã„ï¼çµ‚ã‚ã‚Š
    if (isStructuralParagraph(nextText)) return true; // æ¬¡ãŒæ§‹é€ è¦ç´ ãªã‚‰æ­¢ã‚ã‚‹
    if (isSentenceEndLike(currText)) return true;     // ã„ã¾ã®æ®µè½ãŒçµ‚ç«¯ãªã‚‰æ­¢ã‚ã‚‹
    return false;
}



/**
 * docx ãƒ¢ãƒ¼ãƒ‰ç”¨ï¼šAI ã‹ã‚‰ã®è¿”ç­” (P000: xxx / TOTAL: yyy) ã‚’
 * { commentsByPid, totalComment } ã«å¤‰æ›ã—ã€ä¸è¦ã‚³ãƒ¡ãƒ³ãƒˆã‚’é™¤å¤–
 */
// â˜…ç½®ãæ›ãˆï¼šAI è¿”ç­” â†’ ã‚³ãƒ¡ãƒ³ãƒˆãƒãƒƒãƒ—ã¸
function parseAiCheckResponse(rawText) {
  const lines = (rawText || "").split(/\r?\n/);

  const commentsByPid = {};
  let totalComment = "";

  const tmplSet = new Set((TEMPLATES || []).map(t => (t.text || "").trim()).filter(Boolean));
  const findParagraphByPid = (pid) => AICHECK_PARAGRAPHS.find(p => p.pid === pid);

  let currentPid = null;
  let buf = [];

  const flush = () => {
    if (!currentPid) return;

    let commentText = buf.join(" ").replace(/\s+/g, " ").trim();
    commentText = removePageRefsFromComment(commentText);

    const para = findParagraphByPid(currentPid);
    currentPid = null;
    buf = [];

    if (!para || para.section === "support") return;

    // ç•ªå·ã ã‘æ®µè½ã¯å¯¾è±¡å¤–
    if (isNumberingOnlyParagraph(para.text)) return;

    // åŸæ–‡ã®æ›¸ãå†™ã—ï¼ˆåˆ†æã‚¼ãƒ­ï¼‰ã‚’æ¨ã¦ã‚‹
    const norm = (s) => String(s || "").replace(/\s+/g, "").normalize("NFKC");
    if (norm(commentText) === norm(para.text)) return;

    const isTemplatePara = tmplSet.has((para.text || "").trim());
    if (shouldSuppressComment(commentText, isTemplatePara, para)) return;

    if (commentText) commentsByPid[para.pid] = commentText;
  };

  for (const raw of lines) {
    const line = (raw || "").trim();
    if (!line) continue;

    if (/^TOTAL\s*:/i.test(line)) {
      flush();
      totalComment = removePageRefsFromComment(line.replace(/^TOTAL\s*:\s*/i, "").trim());
      continue;
    }

    const m = line.match(/^P(\d{3})\s*[:ï¼š]\s*(.*)$/);
    if (m) {
      flush();
      currentPid = "P" + m[1];
      const first = (m[2] || "").trim();
      if (first) buf.push(first);
      continue;
    }

    // PIDã®ç¶šãè¡Œã¯ã€åŒã˜ã‚³ãƒ¡ãƒ³ãƒˆã¨ã—ã¦å¸åï¼ˆã“ã“ãŒé‡è¦ï¼‰
    if (currentPid) buf.push(line);
  }

  flush();

  if (!totalComment) {
    totalComment = "å…¨ä½“ã¨ã—ã¦é‡å¤§ãªå•é¡Œã¯è¦‹å½“ãŸã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚æŒ‡æ‘˜ãŒå¿…è¦ãªç®‡æ‰€ã®ã¿ã‚³ãƒ¡ãƒ³ãƒˆã—ã¦ã„ã¾ã™ã€‚";
  }

  return { commentsByPid, totalComment };
}



// â˜…ç½®ãæ›ãˆï¼šã‚³ãƒ¡ãƒ³ãƒˆæŠ‘åˆ¶ãƒ­ã‚¸ãƒƒã‚¯ï¼ˆä¸è¦æŒ‡æ‘˜ã‚’ã¾ã¨ã‚ã¦é™¤å¤–ï¼‰
function shouldSuppressComment(content, isTemplatePara, para) {
    if (!content) return true;

    // ãƒ†ãƒ³ãƒ—ãƒ¬æ®µè½ã¯åŸå‰‡ã‚³ãƒ¡ãƒ³ãƒˆç¦æ­¢ï¼ˆç¾ä»•æ§˜ç¶­æŒï¼‰
    if (isTemplatePara) return true;

    const c = String(content).trim();
    if (!c) return true;
    // ===== è¿½åŠ ï¼šè¡¨è¨˜ãƒ«ãƒ¼ãƒ«ã‚³ãƒ¡ãƒ³ãƒˆã®å¦¥å½“æ€§æ¤œè¨¼ï¼ˆfrom ãŒæœ¬æ–‡ã«ç„¡ã‘ã‚Œã°æ¨ã¦ã‚‹ï¼‰=====
const isTerminologyTopic =
  c.includes("è¡¨è¨˜ãƒ«ãƒ¼ãƒ«") || c.includes("è¡¨è¨˜ã‚†ã‚Œ") || c.includes("ç”¨èª") || /â†’/.test(c);

// ã‚³ãƒ¡ãƒ³ãƒˆãŒè¡¨è¨˜ãƒ«ãƒ¼ãƒ«ç³»ã£ã½ã„å ´åˆã ã‘å³æ ¼ãƒã‚§ãƒƒã‚¯
if (isTerminologyTopic && para && typeof para.text === "string") {
  const src = para.text;

  // 1) ã‚³ãƒ¡ãƒ³ãƒˆå†…ã«ã€Œfromâ†’toã€ãŒæ›¸ã‹ã‚Œã¦ã„ã‚‹å ´åˆï¼šfrom ãŒæœ¬æ–‡ã«ç„¡ã‘ã‚Œã°æ¨ã¦ã‚‹
  const arrow = c.match(/(.+?)\s*â†’\s*(.+)/);
  if (arrow) {
    const fromWord = (arrow[1] || "").trim();
    if (fromWord && !src.includes(fromWord)) {
      return true;
    }
  }

  // 2) ã€Œè¡¨è¨˜ãƒ«ãƒ¼ãƒ«ã€fromâ†’toã€ã¨ç•°ãªã‚‹ã€ç³»ï¼štermRules ã‹ã‚‰ç‰¹å®šã—ã€from ãŒæœ¬æ–‡ã«ç„¡ã‘ã‚Œã°æ¨ã¦ã‚‹
  //    ï¼ˆä»Šå›ã®ã€Œã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ã¯â€¦ç•°ãªã‚‹ãŸã‚â€¦ã€èª¤çˆ†ã‚’ã“ã“ã§è½ã¨ã™ï¼‰
  if (Array.isArray(AI_TERM_RULES) && AI_TERM_RULES.length) {
    const hit = AI_TERM_RULES.find(r => {
      const f = (r.from || "").trim();
      const t = (r.to || "").trim();
      if (!f || !t) return false;
      // ã‚³ãƒ¡ãƒ³ãƒˆãŒã“ã®ãƒ«ãƒ¼ãƒ«ã«è¨€åŠã—ã¦ãã†ã‹ï¼ˆfrom/to/ã€Œfromâ†’toã€ã©ã‚Œã‹ï¼‰
      return c.includes(f) || c.includes(t) || c.includes(`${f} â†’ ${t}`) || c.includes(`${f}â†’${t}`);
    });

    if (hit) {
      const f = (hit.from || "").trim();
      const t = (hit.to || "").trim();

      // æœ¬æ–‡ãŒ toï¼ˆæ­£ï¼‰ã‚’å«ã‚€ã®ã«ã€fromï¼ˆèª¤ï¼‰ãŒç„¡ã„ = ã€Œåˆã£ã¦ã‚‹ã®ã«é•ã†ã€ç³»ãªã®ã§æ¨ã¦ã‚‹
      if (t && src.includes(t) && (!f || !src.includes(f))) {
        return true;
      }

      // æœ¬æ–‡ã« from ãŒç„¡ã„ã®ã«ä¿®æ­£ã‚’æ±‚ã‚ã‚‹ã®ã¯èª¤çˆ†ãªã®ã§æ¨ã¦ã‚‹ï¼ˆã‚ˆã‚Šä¸€èˆ¬çš„ï¼‰
      if (f && !src.includes(f) && (c.includes("ä¿®æ­£") || c.includes("ä¿®æ­£ã—ã¾ã™") || c.includes("ç½®æ›") || c.includes("å¤‰æ›´"))) {
        return true;
      }
    }
  }
}

    // ===== è¿½åŠ ï¼šè¡¨è¨˜ãƒ«ãƒ¼ãƒ«çµ¡ã¿ã®ã€Œæ¨æ¸¬ãƒ»æ¡ä»¶ä»˜ãã‚³ãƒ¡ãƒ³ãƒˆã€ã‚’å…¨è½ã¨ã— =====
    // ä¾‹ï¼‰ã€Œã€œãŒãƒ«ãƒ¼ãƒ«ã«åã—ã¦ã€ã€œã€ã¨ãªã£ã¦ã„ã‚‹å ´åˆã¯â€¦ã€ã®ã‚ˆã†ãªä»®å®šã¯ä¸è¦æŒ‡æ‘˜ã¨ã—ã¦é™¤å¤–
    const looksLikeTerminologyComment =
        c.includes("è¡¨è¨˜") || c.includes("è¡¨è¨˜ã‚†ã‚Œ") || c.includes("ç”¨èª") || c.includes("ãƒ«ãƒ¼ãƒ«") || /â†’/.test(c);

    const hasSpeculativeConditional =
        /(ã‚‚ã—|å ´åˆ|å¯èƒ½æ€§|ã‹ã‚‚ã—ã‚Œ|ã‚ˆã†ã«è¦‹ãˆ|ã¨ãªã£ã¦ã„ã‚‹å ´åˆ|å ´åˆã¯)/.test(c);

    const isAssumptionStyle =
        /(ãƒ«ãƒ¼ãƒ«ã«å(ã—|ã—ã¦)|åã—ã¦).*(å ´åˆ|å¯èƒ½æ€§)/.test(c);

    if (looksLikeTerminologyComment && (hasSpeculativeConditional || isAssumptionStyle)) {
        return true;
    }

    // ===== è¿½åŠ ï¼šè¡¨è¨˜ãƒ«ãƒ¼ãƒ«â€œé©åˆâ€å‰æã®ã‚¯ãƒ‰ã„æ³¨é‡ˆã‚’è½ã¨ã™ =====
    // ã€Œåã—ã¦/çµ±ä¸€/ææ¡ˆã€ç­‰ãŒã‚ã‚‹ã®ã«ã€ç½®æ›çŸ¢å°(â†’)ãŒç„¡ã„ï¼æ›–æ˜§æŒ‡æ‘˜ã¨ã—ã¦è½ã¨ã™
    const aggressiveTerms = /(åã—ã¦|ç½®æ›|ç½®ãæ›ãˆ|å¤‰æ›´|çµ±ä¸€|ææ¡ˆ)/.test(c);
    if (looksLikeTerminologyComment && aggressiveTerms && !/â†’/.test(c)) {
        return true;
    }

    // â‘ ã€Œå•é¡Œã‚ã‚Šã¾ã›ã‚“/é©åˆ‡ã§ã™ã€ç³»ã¯ä¸è¦
    const noIssuePhrases = [
        "å•é¡Œã‚ã‚Šã¾ã›ã‚“",
        "å•é¡Œã¯ã‚ã‚Šã¾ã›ã‚“",
        "å•é¡Œã¯ãªã„",
        "ä¿®æ­£ã®å¿…è¦ã¯ã‚ã‚Šã¾ã›ã‚“",
        "ä¿®æ­£ã®å¿…è¦ã¯ãªã„",
        "å•é¡Œã¨ãªã‚‹è¡¨ç¾ã¯ã‚ã‚Šã¾ã›ã‚“",
        "å•é¡Œã¨ãªã‚‹ç®‡æ‰€ã¯ã‚ã‚Šã¾ã›ã‚“",
        "ãƒ©ãƒ™ãƒ«ã¨ã—ã¦é©åˆ‡ã§ã™",
        "é©åˆ‡ã§ã™",
        "å¦¥å½“ã§ã™",
        "OKã§ã™",
        "è‰¯ã„ã§ã™",
    ];
    if (noIssuePhrases.some(p => c.includes(p))) return true;

    // â‘ ã€Œã¨åŒæ§˜ã«/åŒæ§˜ã«ã€ã§å§‹ã¾ã‚‹ã‚³ãƒ¡ãƒ³ãƒˆï¼ˆå‰æãŒç„¡ã„ã¨æ„å‘³ä¸æ˜ã«ãªã‚ŠãŒã¡ï¼‰
    if (/^(ã¨åŒæ§˜ã«|åŒæ§˜ã«|åŒã˜ã)\s*[ã€ï¼Œ]/.test(c) || /^(ã¨åŒæ§˜ã«|åŒæ§˜ã«|åŒã˜ã)/.test(c)) {
        return true;
    }

    // æ‹¬å¼§ã®è¡¨è¨˜ã‚†ã‚Œï¼ˆå…¨è§’/åŠè§’ï¼‰æŒ‡æ‘˜ã¯ä¸è¦
    if (c.includes("å…¨è§’") || c.includes("åŠè§’")) return true;
    if (c.includes("æ‹¬å¼§") && (c.includes("å…¨è§’") || c.includes("åŠè§’") || c.includes("çµ±ä¸€") || c.includes("æƒ") )) {
        return true;
    }

    // ã‚¹ãƒ©ãƒƒã‚·ãƒ¥ï¼ˆ/ ã¨ ï¼ï¼‰ã®åŠè§’å…¨è§’æŒ‡æ‘˜ã¯ä¸è¦
    if (c.includes("ã‚¹ãƒ©ãƒƒã‚·ãƒ¥") || c.includes("/ã¨ï¼") || c.includes("ï¼ã¨/") || c.includes("ï¼") && c.includes("çµ±ä¸€")) {
        return true;
    }

    // ç”»åƒä¸Šã®ç•ªå·ï¼ˆèµ¤ä¸¸ç•ªå·ãªã©ï¼‰ã«é–¢ã™ã‚‹ã‚³ãƒ¡ãƒ³ãƒˆã¯ä¸è¦
    // ä¾‹ï¼šã€Œ(3,5,9...)ãŒé‡è¤‡ã€ãªã©ã®â€œç•ªå·åˆ—â€ï¼‹ã€Œç”»åƒ/ç•ªå·/èµ¤ä¸¸/å„éƒ¨ã®åç§°ã€çµ¡ã¿ã‚’é™¤å¤–
    const hasNumberCluster =
        /[ï¼ˆ(]?\s*\d{1,2}(?:\s*[ã€,]\s*\d{1,2}){3,}\s*[)ï¼‰]?/.test(c) ||
        /(?:\d{1,2}\s*){4,}/.test(c);
    const mentionsImageNumber =
        c.includes("ç”»åƒ") || c.includes("ç•ªå·") || c.includes("èµ¤ä¸¸") || c.includes("å„éƒ¨ã®åç§°") || c.includes("ãƒŠãƒ³ãƒãƒªãƒ³ã‚°");
    if (hasNumberCluster && mentionsImageNumber) return true;
    // æ®µè½æœ¬æ–‡ãŒã€Œç•ªå·ã ã‘ã€ãªã‚‰ã‚³ãƒ¡ãƒ³ãƒˆè‡ªä½“ã‚’å‡ºã•ãªã„ï¼ˆä¿é™ºï¼‰
    if (para && isNumberingOnlyParagraph(para.text)) return true;
// â‘¡ã€Œãã‚ãˆã‚‹/çµ±ä¸€ã€ç³»ã®æ›–æ˜§ã‚³ãƒ¡ãƒ³ãƒˆã¯è½ã¨ã™ï¼ˆç½®æ›ãŒæ›¸ã‹ã‚Œã¦ã„ãªã„é™ã‚Šä¸è¦ï¼‰
const vagueUnify =
  /(è¡¨è¨˜|æ›¸å¼|å…ˆé ­).*(ãã‚|æƒ|çµ±ä¸€)|ä»–é …ç›®.*(ãã‚|æƒ|çµ±ä¸€)|åŒã˜ã‚¹ã‚¿ã‚¤ãƒ«|åŒæ§˜ã«æƒ/;
const hasReplacementArrow = /â†’/.test(c);
if (vagueUnify.test(c) && !hasReplacementArrow) return true;
// â‘¡ è¡¨è¨˜ãƒ«ãƒ¼ãƒ«ã«åˆã£ã¦ã„ã‚‹ã®ã«è¨€åŠã—ã¦ãã‚‹ã€Œãã©ã„æŒ‡æ‘˜ã€ã‚’æ¨ã¦ã‚‹
const redundantRulePhrases = [
  "è¡¨è¨˜ãƒ«ãƒ¼ãƒ«ã«åˆã£ã¦ã„ã‚‹ãŸã‚",
  "è¡¨è¨˜ãƒ«ãƒ¼ãƒ«ã«åˆè‡´ã—ã¦ã„ã‚‹ãŸã‚",
  "ãƒ«ãƒ¼ãƒ«ã«åˆã£ã¦ã„ã‚‹ãŸã‚",
  "çµ±ä¸€ã•ã‚Œã¦ã„ã‚‹ãŸã‚",
  "æ­£ã—ã„è¡¨è¨˜ã§ã™",
  "é©åˆ‡ãªè¡¨è¨˜ã§ã™",
  "å¤‰æ›´ä¸è¦ã§ã™",
];
if (redundantRulePhrases.some(p => c.includes(p))) return true;

// â‘¢ ã€Œã€œã¨ã™ã‚‹ã¨åˆ†ã‹ã‚Šã‚„ã™ã„ã€ç³»ã®è¨€ã„æ›ãˆææ¡ˆã‚’æ¨ã¦ã‚‹ï¼ˆå†…å®¹ãŒå¤‰ã‚ã‚‰ãªã„â€œå¥½ã¿â€ææ¡ˆï¼‰
if (/(?:ã¨ã™ã‚‹ã¨|ã«ã™ã‚‹ã¨|ã¨ã™ã‚Œã°).{0,20}(?:åˆ†ã‹ã‚Šã‚„ã™|ç†è§£ã—ã‚„ã™|è¦‹ã‚„ã™|æ˜ç¢º|è¦–è¦šçš„ã«)/.test(c)) return true;

// â‘£ ã€Œã€œã¨ãªã‚Šã¾ã™ã€ã‚’ã€Œã€œã—ã¾ã™ã€ç­‰ã¸å¯„ã›ã‚‹ã ã‘ã®èªå°¾èª¿æ•´ææ¡ˆã‚’æ¨ã¦ã‚‹ï¼ˆæ„å‘³ãŒåŒã˜ãªã‚‰ä¸è¦ï¼‰
if (/(?:ã€œ|)ã¨(ãªã‚Šã¾ã™|ã—ã¾ã™)ã®è¡¨ç¾/.test(c)) return true;

// â‘¤ ã‚³ãƒ¡ãƒ³ãƒˆãŒã€Œæœ¬æ–‡ã®å¾©å”±ã€ãªã‚‰æ¨ã¦ã‚‹ï¼ˆä»Šå›ã®ç—‡çŠ¶å¯¾ç­–ï¼‰
if (para && typeof para.text === "string") {
  const base = para.text.trim();

  // ã‚³ãƒ¡ãƒ³ãƒˆã‹ã‚‰å¼•ç”¨ç¬¦ã£ã½ã„ã‚‚ã®ã‚’å‰¥ãŒã—ã¦æ¯”è¼ƒ
  const stripped = c
    .replace(/^[ã€Œã€"â€]+/, "")
    .replace(/[ã€ã€"â€]+$/, "")
    .trim();

  // ã»ã¼åŒä¸€ãªã‚‰ã‚³ãƒ¡ãƒ³ãƒˆã¨ã—ã¦ç„¡æ„å‘³ãªã®ã§é™¤å¤–
  if (stripped === base) return true;

  // é•·æ–‡ã§å¤§éƒ¨åˆ†ãŒä¸€è‡´ã™ã‚‹å ´åˆã‚‚é™¤å¤–ï¼ˆã–ã£ãã‚Šåˆ¤å®šï¼‰
  if (base.length >= 20 && stripped.length >= 20) {
    const b = base.replace(/\s+/g, "");
    const s = stripped.replace(/\s+/g, "");
    if (s.includes(b) || b.includes(s)) return true;
  }
}


    
    return false; // åŸºæœ¬é€šã™
}






/**
 * docx ãƒ¢ãƒ¼ãƒ‰ç”¨ï¼šå…ƒã® document.xml ã«ã‚³ãƒ¡ãƒ³ãƒˆæ®µè½ã‚’è¿½è¨˜ã—ã¦æ–°ã—ã„ .docx ã‚’ç”Ÿæˆ
 */
async function exportAiCheckedDocxWithComments(arrayBuffer, commentsByPid, totalComment, originalName) {
    if (!arrayBuffer) {
        throw new Error("å…ƒã® docx ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚");
    }

    const zip = await JSZip.loadAsync(arrayBuffer);
    const docXml = await zip.file("word/document.xml").async("text");

    const parser = new DOMParser();
    const xmlDoc = parser.parseFromString(docXml, "application/xml");

    const wNs = "http://schemas.openxmlformats.org/wordprocessingml/2006/main";
    const body = xmlDoc.getElementsByTagNameNS(wNs, "body")[0];
    const pList = Array.from(xmlDoc.getElementsByTagNameNS(wNs, "p"));

    // pid â†’ å…ƒ document.xml ã®æ®µè½ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
    const indexByPid = new Map();
    AICHECK_PARAGRAPHS.forEach(p => indexByPid.set(p.pid, p.pIndex));

    // æŒ¿å…¥é †ï¼ˆå¾Œã‚ã‹ã‚‰å…¥ã‚Œã‚‹ï¼‰
    const pidList = Object.keys(commentsByPid || {}).sort((a, b) => {
        const ia = indexByPid.get(a);
        const ib = indexByPid.get(b);
        return (ia ?? 0) - (ib ?? 0);
    });

    // â˜…é‡è¦ï¼šè¡¨å†…æ®µè½ã§ã‚‚ã€ŒbaseP ã®è¦ªã€ã« insert ã™ã‚‹ï¼ˆbody å›ºå®šã ã¨è¡¨å¤–ã«é£›ã¶ï¼‰
    for (let i = pidList.length - 1; i >= 0; i--) {
        const pid = pidList[i];
        const idx = indexByPid.get(pid);
        if (idx == null) continue;

        const baseP = pList[idx];
        if (!baseP) continue;

        const commentText = (commentsByPid[pid] || "").trim();
        if (!commentText) continue;

        const parent = baseP.parentNode; // w:tc / w:body ãªã©
        if (!parent) continue;

        // ã‚³ãƒ¡ãƒ³ãƒˆæ®µè½ï¼ˆèµ¤å­—ï¼‹é»„è‰²ãƒã‚¤ãƒ©ã‚¤ãƒˆï¼‰
        const commentP = xmlDoc.createElementNS(wNs, "w:p");
        const r = xmlDoc.createElementNS(wNs, "w:r");
        const rPr = xmlDoc.createElementNS(wNs, "w:rPr");

        const color = xmlDoc.createElementNS(wNs, "w:color");
        color.setAttribute("w:val", "FF0000");
        const highlight = xmlDoc.createElementNS(wNs, "w:highlight");
        highlight.setAttribute("w:val", "yellow");

        rPr.appendChild(color);
        rPr.appendChild(highlight);

        const t = xmlDoc.createElementNS(wNs, "w:t");
        t.textContent = commentText;

        r.appendChild(rPr);
        r.appendChild(t);
        commentP.appendChild(r);

        // baseP ã®ç›´å¾Œã«æŒ¿å…¥
        if (baseP.nextSibling) {
            parent.insertBefore(commentP, baseP.nextSibling);
        } else {
            parent.appendChild(commentP);
        }
    }

    // â– ç·è©•ï¼ˆw:body ã®æœ«å°¾ã«è¿½åŠ ï¼‰
    if (totalComment && totalComment.trim()) {
        const totalP = xmlDoc.createElementNS(wNs, "w:p");
        const r = xmlDoc.createElementNS(wNs, "w:r");
        const rPr = xmlDoc.createElementNS(wNs, "w:rPr");

        const color = xmlDoc.createElementNS(wNs, "w:color");
        color.setAttribute("w:val", "FF0000");
        const highlight = xmlDoc.createElementNS(wNs, "w:highlight");
        highlight.setAttribute("w:val", "yellow");

        rPr.appendChild(color);
        rPr.appendChild(highlight);

        const t = xmlDoc.createElementNS(wNs, "w:t");
        t.textContent = "â– ç·è©• " + totalComment;

        r.appendChild(rPr);
        r.appendChild(t);
        totalP.appendChild(r);
        body.appendChild(totalP);
    }

    const serializer = new XMLSerializer();
    const newXml = serializer.serializeToString(xmlDoc);
    zip.file("word/document.xml", newXml);

    const outBlob = await zip.generateAsync({ type: "blob" });

    let base = (originalName || "manual").replace(/\.docx$/i, "");
    if (!base) base = "manual";
    const fileName = `${base}_AIãƒã‚§ãƒƒã‚¯.docx`;

    saveAs(outBlob, fileName);
}




    
/* ---- ãƒ‰ãƒ­ãƒƒãƒ—è¨­å®š ---- */
function setupOverlayDrop(zoneId, inputId, handler) {
    const z = document.getElementById(zoneId);
    const i = document.getElementById(inputId);
    if (!z || !i) return;

    // â–¼ ã‚¾ãƒ¼ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ãŸã‚‰ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’é–‹ãï¼ˆå¿µã®ãŸã‚ï¼‰
    z.addEventListener("click", () => i.click());

    // â–¼ ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠï¼ˆclick/ãƒ‰ãƒ­ãƒƒãƒ—ã®ä¸¡æ–¹ï¼‰ã§ç™ºç«
    i.addEventListener("change", e => {
        const files = e.target.files;
        if (files && files.length > 0) {
            handler(files);
        }
        // åŒã˜ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç¶šã‘ã¦é¸ã¹ã‚‹ã‚ˆã†ã«ãƒªã‚»ãƒƒãƒˆ
        i.value = "";
    });

    // â–¼ dragenter / dragoverï¼ˆã‚¾ãƒ¼ãƒ³ + input ä¸¡æ–¹ã§æ‹¾ã†ï¼‰
    ["dragenter","dragover"].forEach(ev => {
        [z, i].forEach(el => {
            el.addEventListener(ev, e => {
                e.preventDefault();
                e.stopPropagation();
                z.classList.add("dragover");
            });
        });
    });

    // â–¼ dragleave / dropï¼ˆã‚¾ãƒ¼ãƒ³ + input ä¸¡æ–¹ã§æ‹¾ã†ï¼‰
    ["dragleave","drop"].forEach(ev => {
        [z, i].forEach(el => {
            el.addEventListener(ev, e => {
                e.preventDefault();
                e.stopPropagation();
                z.classList.remove("dragover");
            });
        });
    });

    // â–¼ å®Ÿéš›ã® drop ã§ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ handler ã«æ¸¡ã™ï¼ˆã‚¾ãƒ¼ãƒ³ + input ä¸¡æ–¹ï¼‰
    const handleDrop = e => {
        e.preventDefault();
        e.stopPropagation();
        const files = (e.dataTransfer && e.dataTransfer.files) || (e.target && e.target.files);
        if (files && files.length > 0) {
            handler(files);
        }
    };

    z.addEventListener("drop", handleDrop);
    i.addEventListener("drop", handleDrop);
}


/* ---- Excel èª­è¾¼ï¼ˆå¼·åŒ–ç‰ˆï¼‰ ---- */
function loadExcel(files){
    const statusEl = document.getElementById("excelStatus");

    console.log("[loadExcel] å‘¼ã³å‡ºã—:", files);

    if (!files || !files.length) {
        console.error("[loadExcel] files ãŒç©º");
        statusEl.innerText = "ãƒ•ã‚¡ã‚¤ãƒ«ãŒèª­ã¿è¾¼ã‚ã¾ã›ã‚“";
        return;
    }

    const file = files[0];
    if (!file) {
        console.error("[loadExcel] files[0] ãŒ undefined");
        statusEl.innerText = "ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼";
        return;
    }

    statusEl.innerText = "èª­è¾¼ä¸­...";

    const reader = new FileReader();

    reader.onerror = e => {
        console.error("[loadExcel] FileReader ã‚¨ãƒ©ãƒ¼:", e);
        statusEl.innerText = "ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ";
        alert("Excel ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸï¼ˆFileReader errorï¼‰");
    };

    reader.onload = e => {
        try {
            const arr = e.target.result;
            console.log("[loadExcel] FileReader success");

            if (typeof XLSX === "undefined") {
                throw new Error("XLSX ãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“ï¼ˆCDN ã®èª­ã¿è¾¼ã¿å¤±æ•—ï¼‰");
            }

            const wb = XLSX.read(arr, { type: "array" });

            if (!wb || !wb.SheetNames || wb.SheetNames.length === 0) {
                throw new Error("Excel ã«ã‚·ãƒ¼ãƒˆãŒã‚ã‚Šã¾ã›ã‚“");
            }

            const sheet = wb.Sheets[wb.SheetNames[0]];
            if (!sheet) {
                throw new Error("æœ€åˆã®ã‚·ãƒ¼ãƒˆãŒèª­ã¿å–ã‚Œã¾ã›ã‚“");
            }

            const data = XLSX.utils.sheet_to_json(sheet, { header: 1 });

            if (!Array.isArray(data) || data.length === 0) {
                throw new Error("Excel ã®å†…å®¹ã‚’èª­ã¿å–ã‚Œã¾ã›ã‚“");
            }

            console.log("[loadExcel] ã‚·ãƒ¼ãƒˆè¡Œæ•°:", data.length);

            let lastLabel = "";
            RAW_DATA = data.slice(1).map((row, idx) => {
                if (!row || (row[1] == null && row[2] == null)) return null;

                let label = (row[0] || "").toString().trim();
                if (label === "") label = lastLabel; else lastLabel = label;

                const category = (row[1] || "").toString().trim();
                const content  = (row[2] || "").toString().trim();

                return { id: idx, label, category, content };
            }).filter(r =>
                r !== null &&
                r.label &&
                r.content &&
                r.label !== "é …ç›®å"
            );

            console.log("[loadExcel] ãƒ‘ãƒ¼ã‚¹å¾Œä»¶æ•°:", RAW_DATA.length);

            renderCheckboxes();

            statusEl.innerText = `å®Œäº†: ${RAW_DATA.length}ä»¶`;
        }
        catch (err) {
            console.error("[loadExcel] èª­è¾¼ã‚¨ãƒ©ãƒ¼:", err);
            statusEl.innerText = "èª­è¾¼ã‚¨ãƒ©ãƒ¼";
            alert("Excel èª­è¾¼ã‚¨ãƒ©ãƒ¼: " + err.message);
        }
    };

    reader.readAsArrayBuffer(file);
}






/* ---- ç”»åƒãƒ»è³‡æ–™ ---- */
function loadImages(files, type){
    Array.from(files).forEach(f => {
        const r = new FileReader();
        r.onload = e => {
            if(type === "parts"){
                PARTS_IMAGES.push({
                    id:Date.now()+Math.random(),
                    name:f.name,
                    dataUrl:e.target.result,
                    badges:[],
                    names:"",
                    nameHint:""
                });
                renderImageEditors();
                updateFileList("partsPreview", PARTS_IMAGES, "parts");
            }else{
                USAGE_IMAGES.push({ name:f.name, dataUrl:e.target.result });
                updateFileList("usageImgList", USAGE_IMAGES, "usage");
            }
        };
        r.readAsDataURL(f);
    });
}

function updateFileList(elId, list, type){
    const el = document.getElementById(elId);
    if(type === "parts"){
        el.innerHTML = list.map((f,i) =>
            `<div class="inline-block relative m-1">
                <img src="${f.dataUrl}" class="preview-thumb">
                <span onclick="removeFile('parts',${i})"
                      class="absolute top-0 right-0 bg-red-500 text-white text-[8px] px-1 cursor-pointer">Ã—</span>
            </div>`
        ).join("");
    }else{
        el.innerHTML = list.map((f,i) =>
            `<div class="file-item text-[10px] flex justify-between items-center">
                <span>${f.name}</span>
                <span class="text-red-500 cursor-pointer" onclick="removeFile('usage',${i})">Ã—</span>
            </div>`
        ).join("");
    }
}

window.removeFile = function(type, idx){
    if(type === "parts"){
        PARTS_IMAGES.splice(idx,1);
        renderImageEditors();
        updateFileList("partsPreview", PARTS_IMAGES, "parts");
    }else{
        USAGE_IMAGES.splice(idx,1);
        updateFileList("usageImgList", USAGE_IMAGES, "usage");
    }
};

// â‘¡ å‚è€ƒè³‡æ–™ï¼šç”»åƒ / PDF / Word / ãƒ†ã‚­ã‚¹ãƒˆ
async function loadRefs(files){
  const el = document.getElementById("refFileList");
  if (!files || !files.length) return;

  for (let f of files) {
    try {
      // ç”»åƒãƒ•ã‚¡ã‚¤ãƒ« â†’ USAGE_IMAGES ã«ä¿å­˜ï¼ˆWordå‡ºåŠ›ã‚„AIã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆç”¨ï¼‰
      if (f.type && f.type.startsWith("image/")) {
        const dataUrl = await new Promise((resolve, reject) => {
          const r = new FileReader();
          r.onload  = e => resolve(e.target.result);
          r.onerror = reject;
          r.readAsDataURL(f);
        });

        USAGE_IMAGES.push({ name: f.name, dataUrl });
        el.innerHTML += `
          <div class="file-item text-[10px] flex items-center gap-1">
            <span>[ç”»åƒ] ${f.name}</span>
            <i class="fas fa-check text-green-500"></i>
          </div>`;
        continue;
      }

      // æ–‡æ›¸ç³» â†’ ãƒ†ã‚­ã‚¹ãƒˆæŠ½å‡º
      const txt = await extractTextFromFile(f);

      // â˜…å…¨æ–‡ã‚’ä¿æŒã™ã‚‹ï¼ˆãƒˆãƒ¼ã‚¯ãƒ³é‡ã¯ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆå´ã§åˆ¶é™ã™ã‚‹ï¼‰
      REF_TEXT += `\nã€å‚è€ƒ:${f.name}ã€‘\n${txt}\n`;

      el.innerHTML += `
        <div class="file-item text-[10px] flex items-center gap-1">
          <span>[æ–‡æ›¸] ${f.name}</span>
          <i class="fas fa-check text-green-500"></i>
        </div>`;
    } catch (e) {
      console.error(e);
      alert("ãƒ•ã‚¡ã‚¤ãƒ«èª­è¾¼å¤±æ•—: " + f.name);
    }
  }
}
async function extractTextFromFile(file){
  const name = (file.name || "").toLowerCase();
  const ext  = name.includes(".") ? name.split(".").pop() : "";
  const type = (file.type || "").toLowerCase();

  // 1) plain text
  if (type.startsWith("text/") || ext === "txt" || ext === "md" || ext === "csv") {
    return await file.text();
  }

  // 2) PDF
  if (type === "application/pdf" || ext === "pdf") {
    return await extractPdfText(file);
  }

  // 3) DOCXï¼ˆWordï¼‰
  if (type === "application/vnd.openxmlformats-officedocument.wordprocessingml.document" || ext === "docx") {
    return await extractDocxText(file);
  }

  // ãã®ä»–ã¯æœ€ä½é™ï¼šãƒã‚¤ãƒŠãƒªæ‰±ã„
  return `ï¼ˆæœªå¯¾å¿œå½¢å¼: ${file.type || ext || "unknown"}ï¼‰`;
}

async function extractDocxText(file){
  if (typeof mammoth === "undefined") {
    throw new Error("mammoth ãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“ï¼ˆCDNç¢ºèªï¼‰");
  }
  const ab = await file.arrayBuffer();
  const res = await mammoth.extractRawText({ arrayBuffer: ab });
  return (res && res.value ? res.value : "").trim();
}

async function extractPdfText(file){
  if (typeof pdfjsLib === "undefined") {
    throw new Error("pdfjsLib ãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“ï¼ˆCDNç¢ºèªï¼‰");
  }

  const ab = await file.arrayBuffer();
  const pdf = await pdfjsLib.getDocument({ data: ab }).promise;

  const texts = [];
  for (let p = 1; p <= pdf.numPages; p++) {
    const page = await pdf.getPage(p);
    const content = await page.getTextContent();
    const pageText = content.items.map(it => (it && it.str) ? it.str : "").join(" ");
    texts.push(pageText);
  }
  return texts.join("\n").trim();
}


// === ãƒãƒ‹ãƒ¥ã‚¢ãƒ«åŸç¨¿AIãƒã‚§ãƒƒã‚¯é–¢é€£ ===
function handleAiCheckFiles(files) {
    if (!files || !files.length) return;
    const file = files[0];
    if (!file) return;

    const statusEl = document.getElementById("aiCheckStatus");
    const btn      = document.getElementById("aiCheckBtn");
    const drop     = document.getElementById("aiCheckDrop");

    // æ‹¡å¼µå­åˆ¤å®šï¼ˆ.docx ã®ã¿è¨±å¯ï¼‰
    const ext = (file.name.split(".").pop() || "").toLowerCase();
    if (ext !== "docx") {
        alert("ç¾åœ¨ã€AIãƒã‚§ãƒƒã‚¯ã¯ .docx ãƒ•ã‚¡ã‚¤ãƒ«ã®ã¿å¯¾å¿œã—ã¦ã„ã¾ã™ã€‚");
        statusEl.textContent = "å¯¾å¿œã—ã¦ã„ãªã„ãƒ•ã‚¡ã‚¤ãƒ«å½¢å¼ã§ã™ï¼ˆ.docxã®ã¿å¯¾å¿œï¼‰";
        btn.disabled = true;
        if (drop) drop.classList.remove("has-file");
        AICHECK_FILENAME = "";
        AICHECK_IS_DOCX = false;
        AICHECK_DOCX_BUFFER = null;
        AICHECK_PARAGRAPHS = [];
        return;
    }

    AICHECK_FILENAME = file.name || "manual";
    statusEl.textContent = "èª­è¾¼ä¸­...";
    btn.disabled = true;
    if (drop) {
        drop.classList.add("has-file");
    }

    // docx ã‚’ãã®ã¾ã¾ä¿æŒã—ã¤ã¤ã€æ®µè½è§£æ
    file.arrayBuffer()
        .then(async (ab) => {
            AICHECK_IS_DOCX = true;
            AICHECK_DOCX_BUFFER = ab;

            // æ®µè½ãƒªã‚¹ãƒˆã‚’ä½œæˆï¼ˆAICHECK_PARAGRAPHS ã‚’åŸ‹ã‚ã‚‹ï¼‰
            await parseDocxParagraphsFromArrayBuffer(ab);

            const paraCount = AICHECK_PARAGRAPHS.length;
            const charCount = AICHECK_PARAGRAPHS
                .reduce((sum, p) => sum + (p.text || "").length, 0);

            statusEl.textContent =
                `é¸æŠä¸­ï¼š${AICHECK_FILENAME}ï¼ˆæ®µè½æ•° ${paraCount} / æ–‡å­—æ•° ç´„${charCount}ï¼‰`;
            btn.disabled = paraCount === 0;
        })
        .catch(e => {
            console.error(e);
            alert("Wordãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
            statusEl.textContent = "èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼";
            btn.disabled = true;
            if (drop) drop.classList.remove("has-file");
            AICHECK_IS_DOCX = false;
            AICHECK_DOCX_BUFFER = null;
            AICHECK_PARAGRAPHS = [];
        });
}




// docx ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ HTML + ç”»åƒä»˜ãã® Document ã«å¤‰æ›ã—ã€è¡Œãƒ†ã‚­ã‚¹ãƒˆã‚’æŠ½å‡º
async function loadDocxToHtmlDocument(file) {
    const arrayBuffer = await file.arrayBuffer();

    // ç”»åƒã‚‚å«ã‚ã¦ HTML ç”Ÿæˆ
    const result = await mammoth.convertToHtml(
        { arrayBuffer },
        {
            convertImage: mammoth.images.inline(function (element) {
                return element.read("base64").then(function (imageBuffer) {
                    return {
                        src: "data:" + element.contentType + ";base64," + imageBuffer
                    };
                });
            })
        }
    );

    const html = result.value || "";
    const parser = new DOMParser();
    const doc = parser.parseFromString(html, "text/html");

    const lines = extractTextLinesFromDoc(doc);

    return { doc, lines };
}

// ãƒ—ãƒ¬ãƒ¼ãƒ³ãƒ†ã‚­ã‚¹ãƒˆï¼ˆ.txtï¼‰ã‹ã‚‰ç°¡æ˜“ HTML Document ã‚’ä½œã‚‹
function createHtmlDocFromPlainText(text) {
    const doc = document.implementation.createHTMLDocument("");
    const body = doc.body;

    const srcLines = (text || "").split(/\r?\n/);
    const lines = [];

    srcLines.forEach((line, index) => {
        const p = doc.createElement("p");
        p.textContent = line;
        p.setAttribute("data-ai-line-index", String(index));
        body.appendChild(p);
        lines.push((line || "").replace(/\r?\n/g, " ").trim());
    });

    return { doc, lines };
}

// HTML Document ã‹ã‚‰ã€Œæ ¡æ­£å¯¾è±¡ã®è¡Œãƒ†ã‚­ã‚¹ãƒˆã€ã¨ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹å±æ€§ã‚’ä»˜ä¸
function extractTextLinesFromDoc(doc) {
    const body = doc.body;
    const blocks = Array.from(
        body.querySelectorAll("h1,h2,h3,h4,h5,h6,p,li")
    );

    const lines = [];
    let index = 0;

    blocks.forEach(el => {
        const text = (el.textContent || "")
            .replace(/\r?\n/g, " ")
            .replace(/\s+/g, " ")
            .trim();

        // è¡Œã¨ã—ã¦æ‰±ã†ï¼ˆç©ºè¡Œã‚‚ä½ç½®åˆã‚ã›ã®ãŸã‚ä¿æŒï¼‰
        el.setAttribute("data-ai-line-index", String(index));
        lines.push(text);
        index++;
    });

    return lines;
}

    


// â˜…AIãƒã‚§ãƒƒã‚¯ã¯ .docx å°‚ç”¨ã«å›ºå®šã™ã‚‹
// AIãƒã‚§ãƒƒã‚¯ç”¨ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆï¼ˆdocxå°‚ç”¨ãƒ©ãƒƒãƒ‘ãƒ¼ï¼‰
function buildAiCheckPrompt() {
    return buildAiCheckPromptForDocx();
}

// â˜…ç½®ãæ›ãˆï¼šdocx ãƒ¢ãƒ¼ãƒ‰ç”¨ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ
function buildAiCheckPromptForDocx() {
    const tmplLines = (TEMPLATES || []).map(t => t.text).join("\n");
    const ruleLines = (AI_TERM_RULES || [])
        .map(r => `${r.from} â†’ ${r.to}`)
        .join("\n");

    const listText = (AICHECK_PARAGRAPHS || [])
        .filter(p => p.section !== "support")
        .map(p => `${p.pid}\n${p.text}`)
        .join("\n\n");

    return `
ã‚ãªãŸã¯æ—¥æœ¬èªã®å–æ‰±èª¬æ˜æ›¸ã‚’å°‚é–€ã¨ã™ã‚‹ãƒ†ã‚¯ãƒ‹ã‚«ãƒ«ãƒ©ã‚¤ã‚¿ãƒ¼å…¼æ ¡æ­£è€…ã§ã™ã€‚
æ—¥æœ¬èªã ã‘ã§å›ç­”ã—ã¦ãã ã•ã„ã€‚

ç›®çš„ï¼š
1. èª¤å­—è„±å­—ãƒ»æ–‡æ³•ãƒ»ä¸è‡ªç„¶è¡¨ç¾ã‚’æŒ‡æ‘˜ã™ã‚‹ã€‚
2. èª­ã¿ã‚„ã™ã•æ”¹å–„ã‚’â€œç©æ¥µçš„ã«â€ææ¡ˆã™ã‚‹ï¼ˆåˆ†å‰²ææ¡ˆï¼å†—é•·æ€§å‰Šæ¸›ï¼é‡è¤‡ã®æ•´ç†ï¼æ›–æ˜§ã•è§£æ¶ˆï¼‰ã€‚
3. è¡¨è¨˜ãƒ«ãƒ¼ãƒ«ã«åã™ã‚‹è¡¨ç¾ãŒã‚ã‚Œã°çµ±ä¸€è¡¨è¨˜ã‚’ææ¡ˆã™ã‚‹ã€‚

é‡è¦ãƒ«ãƒ¼ãƒ«ï¼š
- ä½“è£ã‚„ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã«é–¢ã™ã‚‹æŒ‡æ‘˜ã¯ç¦æ­¢ï¼ˆç©ºç™½/ã‚¤ãƒ³ãƒ‡ãƒ³ãƒˆ/å…¨åŠè§’/å¥èª­ç‚¹ã®çµ±ä¸€/ãƒ•ã‚©ãƒ³ãƒˆ/æƒãˆç­‰ï¼‰ã€‚
- æ”¹è¡Œæ–¹å¼ï¼ˆShift+Enter ãªã©ï¼‰ã«ã‚ˆã‚‹ã€ä¸€æ–‡ãŒé•·ã™ãã‚‹ãªã©ã®æŒ‡æ‘˜ã¯ä¸è¦ã€‚
- ã€Œå•é¡Œã‚ã‚Šã¾ã›ã‚“ã€ã€Œé©åˆ‡ã§ã™ã€ã€Œè‰¯ã„ã§ã™ã€ã€Œã“ã®ã¾ã¾ã§ã‚ˆã„ã€ãªã©
  â€œä¿®æ­£ä¸è¦â€ã‚’ä¼ãˆã‚‹ã‚³ãƒ¡ãƒ³ãƒˆã¯ç¦æ­¢ã€‚æŒ‡æ‘˜ãŒãªã„æ®µè½ã¯å‡ºåŠ›ã—ãªã„ã€‚
- ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆæ–‡ç« ä¸€è¦§ã¯ database ç”±æ¥ã®å®šå‹æ–‡ã ãŒã€
  â€œèª¤å­—è„±å­—â€ã ã‘ã§ãªãã€Œèª­ã¿ã‚„ã™ã•ï¼ˆåˆ†å‰²/å†—é•·/èª¤è§£é˜²æ­¢ï¼‰ã€ã‚„ã€Œè¡¨è¨˜ãƒ«ãƒ¼ãƒ«é•åã€ã‚‚æ”¹å–„ä½™åœ°ãŒã‚ã‚Œã°æŒ‡æ‘˜ã—ã¦ã‚ˆã„ã€‚
  ãŸã ã—ã€ãƒ†ãƒ³ãƒ—ãƒ¬æ–‡ã®â€œå†…å®¹æ”¹å¤‰â€ã‚’å¼·åˆ¶ã™ã‚‹ã®ã§ã¯ãªãã€æ”¹å–„ææ¡ˆã¨ã—ã¦ç°¡æ½”ã«æ›¸ãã€‚
- ã€æ¨æ¸¬ç¦æ­¢ã€‘è¡¨è¨˜ãƒ«ãƒ¼ãƒ«é•åãŒâ€œæœ¬æ–‡ã‹ã‚‰ç¢ºå®Ÿã«ç¢ºèªã§ããªã„â€é™ã‚Šã€è¡¨è¨˜ãƒ«ãƒ¼ãƒ«é–¢é€£ã®ã‚³ãƒ¡ãƒ³ãƒˆã‚’å‡ºã—ã¦ã¯ã„ã‘ã¾ã›ã‚“ã€‚
- ã€æ¡ä»¶æ–‡ç¦æ­¢ã€‘è¡¨è¨˜ãƒ«ãƒ¼ãƒ«é–¢é€£ã®ã‚³ãƒ¡ãƒ³ãƒˆã§ã€Œã‚‚ã—ã€œãªã‚‰ã€ã€Œã€œã®å ´åˆã€ã€Œã€œã¨ãªã£ã¦ã„ã‚‹å ´åˆã¯ã€ã€Œå¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€ç­‰ã®æ¡ä»¶ä»˜ããƒ»ä»®å®šè¡¨ç¾ã¯ç¦æ­¢ã§ã™ã€‚
- è¡¨è¨˜ãƒ«ãƒ¼ãƒ«ã«â€œåˆè‡´ã—ã¦ã„ã‚‹â€å ´åˆã¯ã€ãã®èªã«ã¤ã„ã¦ä¸€åˆ‡ã‚³ãƒ¡ãƒ³ãƒˆã—ãªã„ï¼ˆâ€œåˆã£ã¦ã„ã‚‹ã®ã§OKâ€ã‚‚ç¦æ­¢ï¼‰ã€‚
- è¡¨è¨˜ã‚†ã‚Œï¼ˆè¡¨è¨˜ãƒ«ãƒ¼ãƒ«é–¢é€£ï¼‰ã‚’æŒ‡æ‘˜ã§ãã‚‹ã®ã¯ã€æœ¬æ–‡ä¸­ã«ã€Œfromï¼ˆèª¤ï¼‰ã€ãŒå®Ÿéš›ã«å­˜åœ¨ã™ã‚‹ã¨ãã ã‘ã§ã™ã€‚
- è¡¨è¨˜ã‚†ã‚Œã‚’æŒ‡æ‘˜ã™ã‚‹å ´åˆã¯ã€å¿…ãšã€Œfromâ†’toã€ã‚’1ã¤ã ã‘æ›¸ãï¼ˆå€™è£œã‚’è¤‡æ•°å‡ºã™ï¼æ¨æ¸¬ã§æ›¸ãã®ã¯ç¦æ­¢ï¼‰ã€‚
- ã€Œè¡¨è¨˜ã‚’ãã‚ãˆã‚‹ï¼æƒãˆã‚‹ï¼çµ±ä¸€ã™ã‚‹ï¼ä»–é …ç›®ã¨åŒã˜ã«ã™ã‚‹ã€ãªã©ã€ç½®æ›å†…å®¹ãŒç‰¹å®šã§ããªã„æ›–æ˜§ãªã‚³ãƒ¡ãƒ³ãƒˆã¯ç¦æ­¢ã§ã™ã€‚
- è¡¨è¨˜ãƒ«ãƒ¼ãƒ«ä¸€è¦§ã«ç„¡ã„å˜èªã¯ã€è¡¨è¨˜ã‚†ã‚Œã¨ã—ã¦æŒ‡æ‘˜ã—ãªã„ã§ãã ã•ã„ã€‚
- è¡¨è¨˜ãƒ«ãƒ¼ãƒ«ã«é–¢é€£ã™ã‚‹ã‚³ãƒ¡ãƒ³ãƒˆã¯ã€Œé•åãŒã‚ã‚‹å ´åˆã®ã¿ã€å‡ºã™ï¼ˆé•åãŒç„¡ã„ãªã‚‰æ²ˆé»™ï¼‰ã€‚
- è¡¨è¨˜ãƒ«ãƒ¼ãƒ«é•åã‚’æŒ‡æ‘˜ã™ã‚‹å ´åˆã¯ã€å¿…ãšã€Œæœ¬æ–‡ã«å®Ÿéš›ã«å«ã¾ã‚Œã¦ã„ã‚‹èª¤è¡¨è¨˜ï¼ˆfromï¼‰ã€ã‚’ãã®ã¾ã¾å¼•ç”¨ã—ã€fromâ†’to ã‚’æ›¸ãã“ã¨ã€‚
  æœ¬æ–‡ã« from ãŒå­˜åœ¨ã—ãªã„å ´åˆã€è¡¨è¨˜ãƒ«ãƒ¼ãƒ«é–¢é€£ã®ã‚³ãƒ¡ãƒ³ãƒˆã¯ä¸€åˆ‡å‡ºã—ã¦ã¯ã„ã‘ãªã„ã€‚
- ã‚³ãƒ¡ãƒ³ãƒˆæœ¬æ–‡ã«ã€ŒåŸæ–‡ãã®ã‚‚ã®ã€ã‚’æ›¸ãã®ã¯ç¦æ­¢ï¼ˆå¼•ç”¨ãƒ»å¾©å”±ç¦æ­¢ï¼‰ã€‚
- ã‚³ãƒ¡ãƒ³ãƒˆã¯å¿…ãšã€Œä½•ã‚’ã©ã†ç›´ã™ã‹ã€ã ã‘ã‚’æ›¸ãï¼ˆä¾‹ï¼šã€å†—é•·ãªã®ã§ã€Œã€œã€ã‚’å‰Šé™¤ã€ï¼‰ã€‚



- èªå°¾ã‚„è¨€ã„å›ã—ã®å¥½ã¿ï¼ˆä¾‹ï¼šã€Œã€œã™ã‚‹ã¨åˆ†ã‹ã‚Šã‚„ã™ã„ã€ç­‰ï¼‰ã®ææ¡ˆã¯ç¦æ­¢ã€‚
  æ”¹å–„ææ¡ˆã¯ã€Œèª¤è§£ãƒ»èª¤æ“ä½œãƒ»å®‰å…¨ãƒªã‚¹ã‚¯ã®ä½æ¸›ã€ã¾ãŸã¯ã€Œæ‰‹é †ã®æ¬ è½è£œå®Œã€ãŒã‚ã‚‹å ´åˆã«é™ã‚‹ã€‚


ç•ªå·ãƒ»ãƒšãƒ¼ã‚¸ç•ªå·ãƒ«ãƒ¼ãƒ«ï¼š
- ã‚³ãƒ¡ãƒ³ãƒˆæœ¬æ–‡ã«ãƒšãƒ¼ã‚¸ç•ªå·ï¼ˆP123 ç­‰ï¼‰ã‚’æ›¸ã‹ãªã„ã€‚

å‡ºåŠ›ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆï¼ˆå³å®ˆï¼‰ï¼š
P000: ã‚³ãƒ¡ãƒ³ãƒˆæœ¬æ–‡
P010: ã‚³ãƒ¡ãƒ³ãƒˆæœ¬æ–‡
TOTAL: ç·è©•æœ¬æ–‡
â€»Markdownã‚„ç®‡æ¡æ›¸ãã¯ç¦æ­¢ã€‚ã™ã¹ã¦ãƒ—ãƒ¬ãƒ¼ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã€‚

è¡¨è¨˜ãƒ«ãƒ¼ãƒ«ä¸€è¦§ï¼š
${ruleLines || "ï¼ˆãƒ«ãƒ¼ãƒ«ãªã—ï¼‰"}

ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆæ–‡ç« ä¸€è¦§ï¼š
${tmplLines || "ï¼ˆãªã—ï¼‰"}

ãƒã‚§ãƒƒã‚¯å¯¾è±¡ã®æ®µè½ä¸€è¦§ï¼š
${listText}
`.trim();
}

// â˜…ç½®ãæ›ãˆï¼šãƒšãƒ¼ã‚¸ç•ªå·è¡¨è¨˜ã‚’ã‚³ãƒ¡ãƒ³ãƒˆã‹ã‚‰å¾¹åº•çš„ã«é™¤å»
// â˜…ç½®ãæ›ãˆï¼šãƒšãƒ¼ã‚¸ç•ªå·è¡¨è¨˜ã‚’ã‚³ãƒ¡ãƒ³ãƒˆã‹ã‚‰å¾¹åº•çš„ã«é™¤å»ï¼ˆP/ï¼°/på¯¾å¿œï¼‰
function removePageRefsFromComment(text) {
    if (!text) return "";

    let s = text;

    // P / ï¼° / p ã‚’è¨±å®¹
    const P = "[Pï¼°p]";

    // 1) æ‹¬å¼§ä»˜ã: ï¼ˆP108-P109ï¼‰, (ï¼°108ã€œ109) ç­‰
    s = s.replace(new RegExp(`[ï¼ˆ(]\\s*${P}\\s*\\d{1,4}(?:\\s*[ã€œ~\\-ï¼]\\s*${P}?\\s*\\d{1,4})?(?:\\s*[ã€,ã‚„]\\s*${P}?\\s*\\d{1,4}(?:\\s*[ã€œ~\\-ï¼]\\s*\\d{1,4})?)*\\s*[)ï¼‰]`, "g"), "");

    // 2) ç¯„å›²: P108-P109, ï¼°108ã€œ109
    s = s.replace(new RegExp(`${P}\\s*\\d{1,4}\\s*[ã€œ~\\-ï¼]\\s*${P}?\\s*\\d{1,4}`, "g"), "");

    // 3) è¤‡æ•°: P108, P181 / P108ã‚„181
    s = s.replace(new RegExp(`${P}\\s*\\d{1,4}\\s*[ã€,ã‚„]\\s*${P}?\\s*\\d{1,4}`, "g"), "");

    // 4) å˜ç‹¬: P108 / P108ãƒšãƒ¼ã‚¸
    s = s.replace(new RegExp(`${P}\\s*\\d{1,4}\\s*ãƒšãƒ¼ã‚¸?`, "g"), "");
    s = s.replace(new RegExp(`${P}\\s*\\d{1,4}`, "g"), "");

    // å¾Œå‡¦ç†
    s = s.replace(/[ã€,ã‚„]\s*(?=ã€‚|$)/g, "");
    s = s.replace(/\s{2,}/g, " ");
    s = s.replace(/^[ã€,ã‚„\s]+/, "").replace(/[ã€,ã‚„\s]+$/, "");

    return s.trim();
}


async function runAiCheck() {
    // docx ãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
    if (!AICHECK_DOCX_BUFFER || !Array.isArray(AICHECK_PARAGRAPHS) || !AICHECK_PARAGRAPHS.length) {
        alert("å…ˆã«ãƒãƒ‹ãƒ¥ã‚¢ãƒ«åŸç¨¿ã® Word ãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆ.docxï¼‰ã‚’ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—ã—ã¦ãã ã•ã„ã€‚");
        return;
    }

    const statusEl = document.getElementById("aiCheckStatus");
    const btn      = document.getElementById("aiCheckBtn");
    const loading  = document.getElementById("loadingOverlay");
    const loadText = document.getElementById("loadingText");

    const setStep = (stepText) => {
        if (statusEl)  statusEl.textContent = stepText;
        if (loadText)  loadText.textContent = stepText;
    };

    loading.style.display = "flex";
    btn.disabled = true;

    try {
        // 1/3
        setStep("1/3ï¼šAIãƒã‚§ãƒƒã‚¯ç”¨ã®æŒ‡ç¤ºæ–‡ã‚’æº–å‚™ã—ã¦ã„ã¾ã™â€¦");
        const prompt = buildAiCheckPrompt();  // docx ãƒ¢ãƒ¼ãƒ‰å›ºå®š

   // 2/3
setStep("2/3ï¼šAIã«é€ä¿¡ä¸­ã§ã™ï¼ˆå¿œç­”å¾…ã¡: æ•°åç§’ã‹ã‹ã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ï¼‰â€¦");
const aiTextRaw = await callAI(prompt, null);

// â˜…è¿½åŠ ï¼šè¡¨ç¤º/è§£æ/ãƒãƒ¼ã‚¸ã®å‰ã«ãƒ•ã‚£ãƒ«ã‚¿ã‚’é€šã™
const aiText = filterAiCheckOutput(aiTextRaw);

// æŒ‡æ‘˜ãŒç„¡ã„å ´åˆã¯ä½•ã‚‚è¡¨ç¤ºã›ãšã€ãã®ã¾ã¾çµ‚äº†
if (!aiText || !aiText.trim()) {
  setStep("AIãƒã‚§ãƒƒã‚¯å®Œäº†ï¼ˆæŒ‡æ‘˜ãªã—ï¼‰");
  return;
}


// 3/3ï¼šã‚³ãƒ¡ãƒ³ãƒˆè§£æâ†’Word ã«è¿½è¨˜
setStep("3/3ï¼šã‚³ãƒ¡ãƒ³ãƒˆã‚’è§£æã—ã€Wordã«è¿½è¨˜ã—ã¦ã„ã¾ã™â€¦");
const { commentsByPid, totalComment } = parseAiCheckResponse(aiText);


        await exportAiCheckedDocxWithComments(
            AICHECK_DOCX_BUFFER,
            commentsByPid,
            totalComment,
            AICHECK_FILENAME
        );

        showToast("AIãƒã‚§ãƒƒã‚¯çµæœã®Wordãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã¾ã—ãŸ");
        setStep("å®Œäº†ï¼šAIãƒã‚§ãƒƒã‚¯ä»˜ãWordãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸã€‚");
    } catch (e) {
        console.error(e);
        setStep("ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚è©³ç´°ã¯ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚");
        alert("AIãƒã‚§ãƒƒã‚¯ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: " + e.message);
    } finally {
        loading.style.display = "none";
        btn.disabled = false;
    }
}



// AIãƒã‚§ãƒƒã‚¯çµæœ â†’ å…ƒWordç”±æ¥HTMLã«ã‚³ãƒ¡ãƒ³ãƒˆã‚’ãƒãƒ¼ã‚¸ã—ã¦ã‹ã‚‰ Word å‡ºåŠ›
async function exportAiCheckedWord(aiText, originalName) {
    if (!AICHECK_DOC) {
        alert("å…ƒã®ãƒãƒ‹ãƒ¥ã‚¢ãƒ«æ–‡æ›¸ãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ã‚‚ã†ä¸€åº¦ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚");
        return;
    }

   
  // â˜…è¿½åŠ ï¼šãƒãƒ¼ã‚¸å‰ã«ãƒ•ã‚£ãƒ«ã‚¿
const filtered = filterAiCheckOutput(aiText);

// â˜… ã¾ãš AIã‚³ãƒ¡ãƒ³ãƒˆï¼ˆã€ã‚³ãƒ¡ãƒ³ãƒˆã€‘è¡Œï¼‰ã‚’ AICHECK_DOC ã«ãƒãƒ¼ã‚¸
mergeAiCommentsIntoDoc(filtered);


    // â˜… ãƒ•ã‚©ãƒ³ãƒˆã¨ç”»åƒã®åŸºæœ¬ã‚¹ã‚¿ã‚¤ãƒ«ã‚’è¿½åŠ 
    // head è¦ç´ ãŒç„¡ã„å ´åˆã¯ä½œã‚‹
    let head = AICHECK_DOC.head;
    if (!head) {
        head = AICHECK_DOC.createElement("head");
        const htmlEl = AICHECK_DOC.documentElement || AICHECK_DOC.getElementsByTagName("html")[0];
        if (htmlEl) {
            htmlEl.insertBefore(head, htmlEl.firstChild);
        }
    }
    const styleEl = AICHECK_DOC.createElement("style");
    styleEl.type = "text/css";
    styleEl.textContent = `
        body {
            font-family: "Meiryo UI", "Meiryo", "MS PGothic", sans-serif;
        }
        p, li, span {
            font-family: inherit;
        }
        img {
            max-width: 100%;
            height: auto;
        }
    `;
    head.appendChild(styleEl);

    // HTML æ–‡å­—åˆ—ã¨ã—ã¦å–ã‚Šå‡ºã—
    const html =
        "<!DOCTYPE html>" +
        "<html>" +
        AICHECK_DOC.documentElement.innerHTML +
        "</html>";

    if (!window.htmlDocx || typeof window.htmlDocx.asBlob !== "function") {
        alert("html-docx-js ãŒèª­ã¿è¾¼ã‚ã¦ã„ã¾ã›ã‚“ã€‚ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯çŠ¶æ³ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚");
        return;
    }

    // HTML â†’ docx Blob ã«å¤‰æ›
    const blob = window.htmlDocx.asBlob(html);

    let base = (originalName || "manual").replace(/\.docx$/i, "");
    if (!base) base = "manual";
    const fileName = `${base}_AIãƒã‚§ãƒƒã‚¯.docx`;

    saveAs(blob, fileName);
}



// AIã‹ã‚‰è¿”ã£ã¦ããŸãƒ†ã‚­ã‚¹ãƒˆï¼ˆå…ƒè¡Œï¼‹ã€ã‚³ãƒ¡ãƒ³ãƒˆã€‘è¡Œï¼‰ã‚’ã€AICHECK_DOC ã«ãƒãƒ¼ã‚¸ã™ã‚‹
function mergeAiCommentsIntoDoc(aiText) {
    if (!aiText || !aiText.trim()) return;
    if (!AICHECK_DOC || !Array.isArray(AICHECK_TEXT_LINES)) return;

    const lines = aiText.split(/\r?\n/);
    const commentsMap = {};   // key: å…ƒè¡Œindex, value: [ã‚³ãƒ¡ãƒ³ãƒˆæ–‡å­—åˆ—,...]

    let currentIndex = -1;    // ç›´è¿‘ã®ã€Œå…ƒè¡Œã€ãŒãƒãƒƒãƒã—ãŸã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹

    for (let raw of lines) {
        const trimmed = raw.trim();
        if (!trimmed) continue;

        // ã‚³ãƒ¡ãƒ³ãƒˆè¡Œ
        if (trimmed.startsWith("ã€ã‚³ãƒ¡ãƒ³ãƒˆã€‘")) {
            const body = trimmed.replace(/^ã€ã‚³ãƒ¡ãƒ³ãƒˆã€‘\s*/, "");
            if (!body) continue;
            if (currentIndex < 0) continue;  // å¯¾å¿œã™ã‚‹å…ƒè¡Œãªã—

            if (!commentsMap[currentIndex]) {
                commentsMap[currentIndex] = [];
            }
            commentsMap[currentIndex].push(body);
            continue;
        }

        // ãã‚Œä»¥å¤–ã¯ã€Œå…ƒã®æœ¬æ–‡è¡Œã€ã¨ã¿ãªã—ã¦ã€AICHECK_TEXT_LINES ã‹ã‚‰å¯¾å¿œã™ã‚‹ index ã‚’æ¢ã™
        const target = trimmed;
        let found = -1;
        for (let i = currentIndex + 1; i < AICHECK_TEXT_LINES.length; i++) {
            const base = (AICHECK_TEXT_LINES[i] || "").trim();
            if (!base) continue;
            if (base === target) {
                found = i;
                break;
            }
        }
        if (found !== -1) {
            currentIndex = found;
        } else {
            // è¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã¯ã‚¹ã‚­ãƒƒãƒ—ï¼ˆAIå´ã§ä½™è¨ˆãªèª¬æ˜è¡ŒãŒå…¥ã£ãŸç­‰ï¼‰
        }
    }

    // å®Ÿéš›ã« DOM ã«ã‚³ãƒ¡ãƒ³ãƒˆè¡Œã‚’æŒ¿å…¥
    const body = AICHECK_DOC.body;

    Object.keys(commentsMap).forEach(key => {
        const idx = Number(key);
        const comments = commentsMap[idx];
        if (!comments || !comments.length) return;

        const selector = `[data-ai-line-index="${idx}"]`;
        const baseEl = body.querySelector(selector);
        if (!baseEl) return;

        // åŸºæº–è¦ç´ ã®æœ«å°¾ã« <br>ï¼‹<span> ã§ã‚³ãƒ¡ãƒ³ãƒˆã‚’è¿½è¨˜ã™ã‚‹
        comments.forEach(text => {
            // æ”¹è¡Œï¼ˆåŒã˜æ®µè½å†…ã§æ”¹è¡Œï¼‰
            const br = AICHECK_DOC.createElement("br");
            baseEl.appendChild(br);

            // ã‚³ãƒ¡ãƒ³ãƒˆæœ¬ä½“ï¼ˆèµ¤å­—ï¼‹é»„è‰²ã€æ–œä½“ã«ã¯ã—ãªã„ï¼‰
            const span = AICHECK_DOC.createElement("span");
            span.textContent = text;
            span.style.color = "red";
            span.style.backgroundColor = "yellow";
            span.style.fontStyle = "normal";  // â˜… æ–œä½“ç¦æ­¢

            baseEl.appendChild(span);
        });
    });
}

            
            

/* ---- å®‰å…¨ã‚¸ãƒ£ãƒ³ãƒ«æç”»ï¼ˆExcelå´ã§ã‚¸ãƒ£ãƒ³ãƒ«æŒ‡å®šç‰ˆï¼‰ ---- */

/**
 * RAW_DATA ã«ã¯ /api/manual-test ã‹ã‚‰
 *  { id, label, category, content,
 *    uiGenre, uiGenreOrder, uiItemOrder, uiHidden }
 * ãŒå…¥ã£ã¦ã„ã‚‹å‰æ
 */
function renderCheckboxes() {
    const gArea = document.getElementById("genreArea");
    const fArea = document.getElementById("funcArea");   // ç„¡ã„å ´åˆã‚‚ã‚ã‚‹
    gArea.innerHTML = "";
    if (fArea) fArea.innerHTML = "";

    if (!Array.isArray(RAW_DATA) || !RAW_DATA.length) {
        gArea.innerHTML = `
          <div class="w-full text-center text-sm text-gray-500 py-10">
            ãƒ‡ãƒ¼ã‚¿ãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“ã€‚
          </div>`;
        return;
    }

    // 1) ãƒ©ãƒ™ãƒ«å˜ä½ã«ã¾ã¨ã‚ã‚‹ï¼ˆè¡¨ç¤ºå¯¾è±¡ã®ã¿ï¼‰
    const labelMap = new Map();
    RAW_DATA.forEach(r => {
        if (r.uiHidden) return;            // è¡¨ç¤ºå¯¾è±¡å¤–ã¯ã‚¹ã‚­ãƒƒãƒ—
        const key = r.label || "";
        if (!key) return;

        if (!labelMap.has(key)) {
            labelMap.set(key, {
                label: key,
                uiGenre: r.uiGenre || "ãã®ä»–",
                uiGenreOrder: (typeof r.uiGenreOrder === "number" && !isNaN(r.uiGenreOrder))
                    ? r.uiGenreOrder
                    : 999,
                uiItemOrder: (typeof r.uiItemOrder === "number" && !isNaN(r.uiItemOrder))
                    ? r.uiItemOrder
                    : 9999
            });
        }
    });

    if (!labelMap.size) {
        gArea.innerHTML = `
          <div class="w-full text-center text-sm text-gray-500 py-10">
            è¡¨ç¤ºå¯¾è±¡ã®ãƒ©ãƒ™ãƒ«ãŒã‚ã‚Šã¾ã›ã‚“ã€‚
          </div>`;
        return;
    }

    // 2) ã‚¸ãƒ£ãƒ³ãƒ«ã”ã¨ã«ã‚°ãƒ«ãƒ¼ãƒ”ãƒ³ã‚°
    const genreMap = new Map();  // key: uiGenre
    labelMap.forEach(info => {
        const gName = info.uiGenre || "ãã®ä»–";
        if (!genreMap.has(gName)) {
            genreMap.set(gName, {
                name: gName,
                order: info.uiGenreOrder ?? 999,
                labels: []
            });
        }
        genreMap.get(gName).labels.push(info);
    });

    // 3) ã‚¸ãƒ£ãƒ³ãƒ«ã®ä¸¦ã³é †ã§ã‚½ãƒ¼ãƒˆ
    const genreList = Array.from(genreMap.values())
        .sort((a, b) => {
            const ao = a.order ?? 999;
            const bo = b.order ?? 999;
            if (ao !== bo) return ao - bo;
            return a.name.localeCompare(b.name, "ja");
        });

    // 4) ã‚¸ãƒ£ãƒ³ãƒ«å†…ã®ãƒ©ãƒ™ãƒ«ã‚‚ã€Œã‚¸ãƒ£ãƒ³ãƒ«å†…è¡¨ç¤ºé † â†’ ãƒ©ãƒ™ãƒ«åã€ã§ã‚½ãƒ¼ãƒˆ
    genreList.forEach(g => {
        g.labels.sort((a, b) => {
            const ao = a.uiItemOrder ?? 9999;
            const bo = b.uiItemOrder ?? 9999;
            if (ao !== bo) return ao - bo;
            return a.label.localeCompare(b.label, "ja");
        });
    });

    // 5) UI ã‚’å®Ÿéš›ã«æç”»
    genreList.forEach(g => {
        const div = document.createElement("div");
        div.className = "genre-group";

        div.innerHTML = `
            <div class="genre-group-header">
                <span>${g.name}</span>
                <span onclick="toggleGroup(this)"
                      class="cursor-pointer text-blue-600 text-[10px]">
                    è§£é™¤
                </span>
            </div>
        `;

        const body = document.createElement("div");
        body.className = "genre-group-content";

        g.labels.forEach(info => {
            body.appendChild(createCheck(info.label));
        });

        div.appendChild(body);
        gArea.appendChild(div);
    });
}

/** ãƒ©ãƒ™ãƒ«ç”¨ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã‚’ 1 å€‹ã¤ãã‚‹ */
function createCheck(label){
    const l = document.createElement("label");
    l.className = "checkbox-card";
    l.innerHTML = `<input type="checkbox" value="${label}"><span>${label}</span>`;
    return l;
}


/* ---- å„éƒ¨ã®åç§°ã‚¨ãƒ‡ã‚£ã‚¿ ---- */
function renumberBadges(img){
    img.badges.forEach((b,i) => { b.num = i+1; });
}

// ç”»åƒã”ã¨ã«ã€Œãƒãƒƒã‚¸æ•°ã€ã¨ã€Œåç§°è¡Œæ•°ã€ã‚’ãã‚ãˆã‚‹
function syncBadgesAndNames(img){
    if (!img) return;

    // åç§°ã‚’è¡Œå˜ä½ã«ã°ã‚‰ã™ï¼ˆç©ºè¡Œã¯é™¤å¤–ï¼‰
    const lines = (img.names || "")
        .split(/\r?\n/)
        .map(l => l.trim())
        .filter(l => l !== "");

    // ã©ã¡ã‚‰ã‹ãŒ 0 ã®ã¨ãã¯ç„¡ç†ã«åˆã‚ã›ãªã„ï¼ˆæ‰‹å‹•ç·¨é›†ä¸­ã®å¯èƒ½æ€§ã‚ã‚Šï¼‰
    if (!img.badges || img.badges.length === 0 || lines.length === 0) {
        img.names = lines.join("\n");
        return;
    }

// ãƒãƒƒã‚¸æ•°ã«åç§°è¡Œæ•°ã‚’åˆã‚ã›ã‚‹ï¼ˆãƒãƒƒã‚¸æ•°ã‚’çµ¶å¯¾å„ªå…ˆï¼‰
const badgeCount = img.badges.length;

// è¡Œæ•°ã‚’ badgeCount ã«ã‚ã‚ã›ã‚‹
let newLines = [];

for (let i = 0; i < badgeCount; i++) {
    newLines.push(lines[i] || "");   // è¡Œä¸è¶³ãªã‚‰ç©ºæ¬„
}

img.names = newLines.join("\n");

}
function normalizeNameText(text){
    if (!text) return "";

    // è¡Œå˜ä½ã«åˆ†å‰²
    const rawLines = text.split(/\r?\n/);

    const lines = [];

    for (const raw of rawLines) {
        let t = raw.trim();
        if (!t) continue;

        // ã€Œ1ã€ã€Œ1.ã€ã€Œï¼‘ï¼ã€ ãªã©æ•°å­—ã§å§‹ã¾ã‚‰ãªã„è¡Œã¯
        // èª¬æ˜æ–‡ã¨ã¿ãªã—ã¦å…¨éƒ¨æ¨ã¦ã‚‹
        if (!/^\d+/.test(t)) {
            continue;
        }

        // æ­£è¦åŒ–ï¼ˆå…¨è§’â†’åŠè§’ãªã©ï¼‰
        let l = raw.normalize("NFKC");

        // è¡Œé ­ã®ç©ºç™½ã‚’å‰Šé™¤
        l = l.replace(/^[\s\u3000\u00A0\uFEFF]+/, "");

        // å…ˆé ­ã®ç•ªå·è¡¨è¨˜ã‚’ã€Œ1. ã€å½¢å¼ã«ãã‚ãˆã‚‹
        // ä¾‹ï¼‰ã€Œï¼‘ï¼‰ã€ã€Œ1ï¼‰ã€ã€ŒNo.1  ã€â†’ã€Œ1. ã€
        l = l.replace(
            /^[^\d]*?(\d+)[\s\u3000\.ã€‚ã€ï¼)ï¼‰]*\s*/,
            "$1. "
        );

        // Markdown ã® ** ã‚’å‰Šé™¤
        l = l.replace(/\*\*/g, "");

        // ï¼ˆï¼‰å†…ã®èª¬æ˜æ–‡ã‚’å‰Šé™¤
        l = l.replace(/[ï¼ˆ\(][^ï¼‰\)]*[ï¼‰\)]/g, "");

        // ã€Œ- èª¬æ˜æ–‡ã€ä»¥é™ã‚’å‰Šé™¤ï¼ˆåå‰ã®å¾Œã‚ã®é•·ã„èª¬æ˜ã‚’æ¨ã¦ã‚‹ï¼‰
        // ä¾‹ï¼‰ã€Œ1. ã‚µã‚¤ãƒ‰ãƒœã‚¿ãƒ³ - å·¦å´é¢ã«ã‚ã‚‹â€¦ã€â†’ã€Œ1. ã‚µã‚¤ãƒ‰ãƒœã‚¿ãƒ³ã€
        l = l.replace(/\s*[-ï¼â€“â€”]\s*.+$/, "");

        // ä½™è¨ˆãªç©ºç™½ã‚’åœ§ç¸®
        l = l.replace(/[\s\u3000]{2,}/g, " ");

        l = l.trim();
        if (!l) continue;

        lines.push(l);
    }

    // ã€Œ1. åç§°ã€ã ã‘ã®è¡Œã‚’è¿”ã™
    return lines.join("\n");
}


function clearAllPartNames(){
    PARTS_IMAGES.forEach(img => {
        img.names  = "";
        img.badges = [];   // â˜… ãƒŠãƒ³ãƒãƒªãƒ³ã‚°ã‚‚åŒæ™‚ã«ã‚¯ãƒªã‚¢
    });
    renderImageEditors();
    showToast("åç§°ã¨ãƒŠãƒ³ãƒãƒªãƒ³ã‚°ã‚’ã™ã¹ã¦ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸ");
}

function clearSinglePartNames(idx){
    const img = PARTS_IMAGES[idx];
    if (!img) return;
    img.names  = "";
    img.badges = [];
    renderImageEditors();
}


// ç”»åƒ1æšåˆ†ã ã‘ åç§°ï¼†ãƒŠãƒ³ãƒãƒªãƒ³ã‚°ã‚’ã‚¯ãƒªã‚¢
function clearPartNames(idx){
    const img = PARTS_IMAGES[idx];
    if (!img) return;

    img.names  = "";
    img.badges = [];  // ç•ªå·ã‚‚ã‚¯ãƒªã‚¢

    renderImageEditors();
    showToast(`ç”»åƒ${idx+1}ã®åç§°ã¨ç•ªå·ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸ`);
}


function renderImageEditors(){
    const area = document.getElementById("editorArea");
    area.innerHTML = "";
    area.classList.remove("hidden");   // â˜… æœ€åˆã‹ã‚‰è¡¨ç¤ºã•ã›ã‚‹

    // ç”»åƒãŒã¾ã ãªã„ã¨ãï¼ˆã“ã“ã‚’è¿½åŠ ã™ã‚‹ï¼‰
    if(!PARTS_IMAGES.length){
        const header = document.createElement("div");
        header.className = "mb-1";
        header.innerHTML = `
            <div class="text-[11px] font-bold text-purple-800 flex justify-between items-center">
                <span>å„éƒ¨ã®åç§° ãƒŠãƒ³ãƒãƒªãƒ³ã‚°ï¼åç§°æ¡ˆ</span>
            </div>
            <p class="text-[10px] text-purple-700 mt-1 leading-relaxed">
                å·¦ã®ã€Œâ‘  å„éƒ¨åç§°ãƒ»ãƒŠãƒ³ãƒãƒªãƒ³ã‚°ã€ã«ç”»åƒã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ã¨ã€<br>
                ã“ã“ã§ç•ªå·ä»˜ã‘ã¨åç§°å…¥åŠ›ãŒã§ãã¾ã™ã€‚
            </p>`;
        area.appendChild(header);
        return;
    }

    // ------ ã“ã“ã‹ã‚‰å…ˆã¯å…ƒã®ã‚³ãƒ¼ãƒ‰ãã®ã¾ã¾ ------
    const header = document.createElement("div");
    header.className = "mb-1";
    header.innerHTML = `
        <div class="text-[11px] font-bold text-purple-800 flex justify-between items-center">
            <span>å„éƒ¨ã®åç§° ãƒŠãƒ³ãƒãƒªãƒ³ã‚°ï¼åç§°æ¡ˆ</span>
            <div class="flex gap-1">
                <button onclick="clearAllPartNames()"
                    class="text-[10px] px-2 py-1 bg-gray-200 text-gray-800 rounded border border-gray-300">
                    å…¨ã¦ã®ç”»åƒã®ãƒŠãƒ³ãƒãƒªãƒ³ã‚°ã¨åç§°ã‚’ã‚¯ãƒªã‚¢
                </button>
                <button onclick="generatePartsNamesAll()"
                    class="text-[10px] px-2 py-1 bg-purple-600 text-white rounded">
                    å…¨ç”»åƒ åç§°æ¡ˆã‚’ç”Ÿæˆ
                </button>
            </div>
        </div>
        <p class="text-[10px] text-purple-700 mt-1 leading-relaxed">
            å³ã‚¯ãƒªãƒƒã‚¯ï¼šç•ªå·è¿½åŠ ï¼ç•ªå·ãƒ‰ãƒ©ãƒƒã‚°ï¼šä½ç½®èª¿æ•´ï¼ãƒ€ãƒ–ãƒ«ã‚¯ãƒªãƒƒã‚¯ï¼šç•ªå·å‰Šé™¤ã€‚<br>
            å¿…ãšå…ˆã«ã€ç”»åƒä¸Šã®ã™ã¹ã¦ã®å¿…è¦ãªéƒ¨ä½ã¸æ‰‹å‹•ã§ãƒŠãƒ³ãƒãƒªãƒ³ã‚°ã‚’è¡Œã£ã¦ã‹ã‚‰ã€Œåç§°æ¡ˆã‚’ç”Ÿæˆã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚
            AIã«ã‚ˆã‚‹è‡ªå‹•ãƒŠãƒ³ãƒãƒªãƒ³ã‚°ã¯è¡Œã£ã¦ã„ã¾ã›ã‚“ã€‚<br>
            å„éƒ¨ã®åç§°ã ã‘ã‚’ä½œæˆã—ãŸã„å ´åˆã¯ã€ã“ã®ã‚¨ãƒªã‚¢ã ã‘ã‚’å˜ç‹¬ã§ä½¿ç”¨ã—ã¦ã‚‚å•é¡Œã‚ã‚Šã¾ã›ã‚“ã€‚
        </p>`;
    area.appendChild(header);

    // ä»¥é™ï¼ˆforEach ã§ç”»åƒã”ã¨ã®ã‚¨ãƒ‡ã‚£ã‚¿ã‚’ä½œã‚‹éƒ¨åˆ†ï¼‰ã¯æ—¢å­˜ã®ã¾ã¾

    PARTS_IMAGES.forEach((img,idx) => {
        renumberBadges(img);
    syncBadgesAndNames(img);   // â˜… ã“ã“ã§æ•°ã‚’ãã‚ãˆã‚‹

const cont = document.createElement("div");
cont.className = "editor-container";
cont.innerHTML = `
    <div class="editor-header">
        <span>ç”»åƒ${idx+1}</span>
        <div class="flex items-center gap-2">
            <button
                type="button"
                class="text-[10px] px-2 py-0.5 border border-purple-400 text-purple-700 bg-white rounded hover:bg-purple-50"
                onclick="copyNumberedImage(${idx})">
                ãƒŠãƒ³ãƒãƒªãƒ³ã‚°æ¸ˆã¿ç”»åƒã‚’ã‚³ãƒ”ãƒ¼
            </button>
            <button
                type="button"
                class="text-[10px] px-2 py-0.5 bg-gray-200 text-gray-800 rounded border border-gray-300"
                onclick="clearPartNames(${idx})">
                ã“ã®ç”»åƒã®ãƒŠãƒ³ãƒãƒªãƒ³ã‚°ã¨åç§°ã‚’ã‚¯ãƒªã‚¢
            </button>
            <span class="text-red-500 cursor-pointer" onclick="removeFile('parts',${idx})">Ã—</span>
        </div>
    </div>`;

        const row = document.createElement("div");
        row.className = "flex gap-2 items-start";

        const wrap = document.createElement("div");
        wrap.className = "editor-wrapper";
        wrap.innerHTML = `<img src="${img.dataUrl}" class="editor-img">`;

        img.badges.forEach((b,bi) => {
            const bg = document.createElement("div");
            bg.className = "badge";
            bg.innerText = b.num;
            bg.style.left = b.x + "%";
            bg.style.top  = b.y + "%";

            bg.onmousedown = e => {
                e.stopPropagation();
                e.preventDefault();
                const move = ev => {
                    const r = wrap.getBoundingClientRect();
                    b.x = Math.max(0, Math.min(100, (ev.clientX - r.left)/r.width*100));
                    b.y = Math.max(0, Math.min(100, (ev.clientY - r.top )/r.height*100));
                    bg.style.left = b.x + "%";
                    bg.style.top  = b.y + "%";
                };
                const up = () => {
                    document.removeEventListener("mousemove", move);
                    document.removeEventListener("mouseup", up);
                };
                document.addEventListener("mousemove", move);
                document.addEventListener("mouseup", up);
            };

            bg.ondblclick = e => {
                e.stopPropagation();
                img.badges.splice(bi,1);
                renderImageEditors();
            };

            wrap.appendChild(bg);
        });

        wrap.oncontextmenu = e => {
            e.preventDefault();
            const r = wrap.getBoundingClientRect();
            img.badges.push({
                num: img.badges.length + 1,
                x:  (e.clientX - r.left)/r.width*100,
                y:  (e.clientY - r.top )/r.height*100
            });
            renumberBadges(img);
            renderImageEditors();
        };

const side = document.createElement("div");
side.className = "flex-1 flex flex-col gap-1";

// å…ˆé ­ã®æ”¹è¡Œãƒ»ç©ºç™½ã‚’ã•ã‚‰ã«å¿µå…¥ã‚Šã«å‰Šã‚‹
const namesTextRaw = img.names || "";
const namesText = namesTextRaw
    .replace(/^\s+/, "")            // å…ˆé ­ã®ç©ºç™½ãƒ»æ”¹è¡Œã‚’å‰Šé™¤
    .replace(/\r?\n\s+\r?\n/g, "\n") // é€£ç¶šç©ºè¡Œã®åœ§ç¸®
    .trim();

// ä¸Šéƒ¨ï¼ˆãƒ©ãƒ™ãƒ«ï¼‹ãƒœã‚¿ãƒ³ï¼‰ã¯ innerHTML ã§ OKï¼ˆã“ã“ã¯ pre-wrap ã§ã¯ãªã„ï¼‰
side.innerHTML = `
    <label class="text-[10px] font-bold text-gray-600">
        åç§°æ¡ˆã¸ã®è¦æœ›
        <input type="text"
            class="w-full border rounded px-1 py-0.5 text-[10px] mt-0.5"
            placeholder="ä¾‹ï¼‰ãƒã‚¦ã‚¹ã®éƒ¨ä½åç§°ã¨ã—ã¦è‡ªç„¶ãªè¡¨ç¾ã«ã—ã¦ãã ã•ã„"
            value="${img.nameHint||""}"
            oninput="updateNameHint(${idx},this.value)">
    </label>
    <div class="flex justify-between items-center mt-1 mb-1">
        <span class="text-[10px] font-bold text-gray-600">åç§°æ¡ˆ</span>
        <button class="text-[10px] px-2 py-0.5 bg-purple-500 text-white rounded"
            onclick="regenPartNames(${idx})">
            ã“ã®ç”»åƒã®åç§°æ¡ˆã‚’ç”Ÿæˆ
        </button>
    </div>
`;

// åç§°æ¡ˆ textarea
const namesBox = document.createElement("textarea");
namesBox.className = "w-full border rounded p-1 text-[10px] leading-4 bg-white parts-names-box";
namesBox.rows = 6;
namesBox.value = namesText || "";
namesBox.placeholder = "ï¼ˆåç§°æ¡ˆãªã—ï¼‰";

// å…¥åŠ›ã—ãŸå†…å®¹ã‚’å³æ™‚åæ˜ 
namesBox.oninput = () => {
    PARTS_IMAGES[idx].names = namesBox.value;
};

side.appendChild(namesBox);



        row.appendChild(wrap);
        row.appendChild(side);
        cont.appendChild(row);
        area.appendChild(cont);
    });
}

function updateNameHint(idx, val){
    if(!PARTS_IMAGES[idx]) return;
    PARTS_IMAGES[idx].nameHint = val;
}

async function copyNumberedImage(idx){
    const img = PARTS_IMAGES[idx];
    if (!img) return;

    if (!navigator.clipboard || !window.ClipboardItem) {
        alert("ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã§ã¯ç”»åƒã®ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã‚³ãƒ”ãƒ¼ã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“ã€‚\nå¿…è¦ã«å¿œã˜ã¦ Word å‡ºåŠ›æ©Ÿèƒ½ãªã©ã‚’ã”åˆ©ç”¨ãã ã•ã„ã€‚");
        return;
    }

    const base = new Image();
    base.onload = () => {
        const canvas = document.getElementById("processCanvas");
        const ctx = canvas.getContext("2d");

        canvas.width  = base.width;
        canvas.height = base.height;

        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.drawImage(base, 0, 0);

        // ãƒŠãƒ³ãƒãƒªãƒ³ã‚°ã‚’æ›¸ãè¾¼ã¿
        if (img.badges && img.badges.length) {
            const sX = base.width / 100;
            const sY = base.height / 100;
            const r  = Math.max(20, base.width * 0.03);

            ctx.font = `bold ${r}px Arial`;
            ctx.textAlign = "center";
            ctx.textBaseline = "middle";

            img.badges.forEach(b => {
                ctx.beginPath();
                ctx.arc(b.x * sX, b.y * sY, r, 0, 2 * Math.PI);
                ctx.fillStyle = "red";
                ctx.fill();
                ctx.fillStyle = "white";
                ctx.fillText(b.num, b.x * sX, b.y * sY);
            });
        }

        canvas.toBlob(async blob => {
            if (!blob) {
                alert("ç”»åƒã®ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
                return;
            }
            try {
                await navigator.clipboard.write([
                    new ClipboardItem({ "image/png": blob })
                ]);
                showToast(`ç”»åƒ${idx+1}ã‚’ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ`);
            } catch (e) {
                console.error(e);
                alert("ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã¸ã®ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
            }
        });
    };
    base.src = img.dataUrl;
}


/* coords ãƒ†ã‚­ã‚¹ãƒˆåŒ– */
function coordsText(img){
    if(!img.badges || !img.badges.length) return "";
    return img.badges.map(b =>
        `${b.num}. x=${b.x.toFixed(1)}%, y=${b.y.toFixed(1)}%`
    ).join("\n");
}

async function generatePartsNamesAll(){
  if(!PARTS_IMAGES.length){
    alert("ç”»åƒãŒã‚ã‚Šã¾ã›ã‚“");
    return;
  }

  // â˜… ãƒŠãƒ³ãƒãƒªãƒ³ã‚°ã•ã‚Œã¦ã„ãªã„ç”»åƒãŒãªã„ã‹ãƒã‚§ãƒƒã‚¯
  const noBadgeList = PARTS_IMAGES
    .map((img, i) => (!img.badges || !img.badges.length) ? (i + 1) : null)
    .filter(v => v !== null);

  if (noBadgeList.length) {
    alert(
      "ä»¥ä¸‹ã®ç”»åƒã«ãƒŠãƒ³ãƒãƒªãƒ³ã‚°ãŒã‚ã‚Šã¾ã›ã‚“ã€‚\n" +
      "å…ˆã«å³ã‚¯ãƒªãƒƒã‚¯ã§ç•ªå·ã‚’ä»˜ã‘ã¦ãã ã•ã„ã€‚\n\n" +
      "ç”»åƒ" + noBadgeList.join(", ")
    );
    return;
  }

  document.getElementById("loadingOverlay").style.display = "flex";

  try {
    for(let i=0;i<PARTS_IMAGES.length;i++){
      await regenPartNames(i, true);
    }
    showToast("å„éƒ¨åç§°ã®åç§°æ¡ˆã‚’ç”Ÿæˆã—ã¾ã—ãŸ");
  } catch(e) {
    console.error(e);
    alert("åç§°æ¡ˆç”Ÿæˆä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: " + e.message);
  } finally {
    document.getElementById("loadingOverlay").style.display = "none";
  }
}



window.regenPartNames = async function(idx, silent){
  const img = PARTS_IMAGES[idx];
  if (!img) return;

  // â˜… è¿½åŠ ï¼šã“ã®ç”»åƒã«ãƒŠãƒ³ãƒãƒªãƒ³ã‚°ãŒç„¡ã‘ã‚Œã°æ³¨æ„ã‚’å‡ºã—ã¦çµ‚äº†
  if (!img.badges || img.badges.length === 0) {
    if (!silent) {
      alert("ã“ã®ç”»åƒã«ãƒŠãƒ³ãƒãƒªãƒ³ã‚°ãŒã‚ã‚Šã¾ã›ã‚“ã€‚\nå³ã‚¯ãƒªãƒƒã‚¯ã§ç•ªå·ã‚’ä»˜ã‘ã¦ã‹ã‚‰åç§°æ¡ˆã‚’ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚");
    }
    return;
  }

  const coordLines = coordsText(img);
  const hint = img.nameHint
    ? `ã€åç§°è¡¨ç¾ã«é–¢ã™ã‚‹è¦æœ›ã€‘\n${img.nameHint}\n`
    : "";

  const prompt = `
ã‚ãªãŸã¯å®¶é›»ãƒ»é›»å­æ©Ÿå™¨ã®æ—¥æœ¬èªå–æ‰±èª¬æ˜æ›¸ã‚’å°‚é–€ã«ä½œæˆã™ã‚‹
ãƒ†ã‚¯ãƒ‹ã‚«ãƒ«ãƒ©ã‚¤ã‚¿ãƒ¼å…¼ãƒ—ãƒ­ãƒ€ã‚¯ãƒˆãƒ‡ã‚¶ã‚¤ãƒŠãƒ¼ã§ã™ã€‚æ—¥æœ¬èªã ã‘ã§å›ç­”ã—ã¦ãã ã•ã„ã€‚

ã€ç›®çš„ã€‘
æ·»ä»˜ç”»åƒã«å†™ã£ã¦ã„ã‚‹è£½å“ã«ã¤ã„ã¦ã€
èµ¤ã„ç•ªå·ã€Œ1, 2, 3, ...ã€ãŒæŒ‡ã—ã¦ã„ã‚‹å„éƒ¨ã®æ­£å¼åç§°ã‚’é«˜ç²¾åº¦ã«ç‰¹å®šã—ã€
å–æ‰±èª¬æ˜æ›¸ã®ã€Œå„éƒ¨ã®åç§°ã€ã«ãã®ã¾ã¾æ²è¼‰ã§ãã‚‹å½¢ã§å‡ºåŠ›ã—ã¦ãã ã•ã„ã€‚

ã€ç•ªå·ã¨ä½ç½®ã«ã¤ã„ã¦ã€‘
- èµ¤ã„ä¸¸ç•ªå·ã¯ã€åã¥ã‘ã—ãŸã„éƒ¨å“ã®ã€ŒçœŸä¸Šã€ã¾ãŸã¯ã€Œã™ãè¿‘ãã€ã«é…ç½®ã•ã‚Œã¦ã„ã¾ã™ã€‚
- å°‘ã—ä½ç½®ãŒã‚ºãƒ¬ã¦ã„ã¦ã‚‚ã€ç•ªå·å‘¨è¾ºã§ã‚‚ã£ã¨ã‚‚è‡ªç„¶ã«å¯¾å¿œã™ã‚‹ã¨è€ƒãˆã‚‰ã‚Œã‚‹
  ã²ã¨ã¤ã®éƒ¨å“ï¼ˆãƒœã‚¿ãƒ³ï¼ãƒ›ã‚¤ãƒ¼ãƒ«ï¼ãƒ¬ãƒãƒ¼ï¼ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ï¼ç«¯å­ï¼LEDãªã©ï¼‰ã‚’é¸ã‚“ã§ãã ã•ã„ã€‚
- 1ã¤ã®ç•ªå·ã¯å¿…ãš1ã¤ã®éƒ¨å“ã ã‘ã‚’æŒ‡ã—ã€ç•ªå·ã®æŠœã‘ã‚„é‡è¤‡ãŒã‚ã£ã¦ã¯ã„ã‘ã¾ã›ã‚“ã€‚
- ç”»åƒå…¨ä½“ã®æ§‹é€ ï¼ˆå·¦å³ãƒ»å‰å¾Œã®å¯¾ç§°æ€§ã€ä¸€èˆ¬çš„ãªè£½å“ã®é…ç½®ï¼‰ã‚‚æ‰‹ãŒã‹ã‚Šã«ã—ã¦ã€
  ã€Œã“ã®ä½ç½®ãªã‚‰é€šå¸¸ã¯ã€‡ã€‡ãƒœã‚¿ãƒ³ã§ã‚ã‚‹ã¯ãšã€ã¨ã„ã†ç™ºæƒ³ã§è«–ç†çš„ã«åˆ¤æ–­ã—ã¦ãã ã•ã„ã€‚

ã€ç•ªå·ã”ã¨ã®ä½ç½®æƒ…å ±ï¼ˆè£œåŠ©ï¼‰ã€‘
${coordLines || "ï¼ˆåº§æ¨™æƒ…å ±ãªã—ï¼‰"}

${hint || ""}

ã€åç§°ã®ä»˜ã‘æ–¹ï¼ˆç²¾åº¦å‘ä¸Šã®ãŸã‚ã®ãƒ«ãƒ¼ãƒ«ï¼‰ã€‘
- ä¸€èˆ¬çš„ãªæ—¥æœ¬èªãƒãƒ‹ãƒ¥ã‚¢ãƒ«ã§ä½¿ã‚ã‚Œã‚‹è‡ªç„¶ãªåç§°ã«ã—ã¦ãã ã•ã„ã€‚
  ä¾‹ï¼‰å·¦ãƒœã‚¿ãƒ³ï¼å³ãƒœã‚¿ãƒ³ï¼ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒ›ã‚¤ãƒ¼ãƒ«ï¼DPIåˆ‡æ›¿ãƒœã‚¿ãƒ³ï¼ã‚µã‚¤ãƒ‰ãƒœã‚¿ãƒ³ï¼
      é›»æºã‚¹ã‚¤ãƒƒãƒï¼LEDã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ï¼USBå……é›»ç«¯å­ ãªã©
- å˜ã«ã€Œãƒœã‚¿ãƒ³ã€ã€Œã‚­ãƒ¼ã€ã®ã‚ˆã†ãªæ›–æ˜§ãªåç§°ã¯é¿ã‘ã€
  å·¦å³ãƒ»ä½ç½®ãƒ»æ©Ÿèƒ½ãŒã‚ã‹ã‚‹ä¿®é£¾èªã‚’ä»˜ã‘ã¦åŒºåˆ¥ã—ã¦ãã ã•ã„ã€‚
- ã€Œã‚»ãƒ³ã‚µãƒ¼ã€â†’ã€Œã‚»ãƒ³ã‚µã€ã€ã€Œãƒ¢ãƒ‹ã‚¿ãƒ¼ã€â†’ã€Œãƒ¢ãƒ‹ã‚¿ã€ã®ã‚ˆã†ã«ã€
  æ—¥æœ¬èªæŠ€è¡“æ–‡æ›¸ã§ä¸€èˆ¬çš„ãªè¡¨è¨˜ã«å¯„ã›ã¦ãã ã•ã„ã€‚
- æ©Ÿèƒ½èª¬æ˜ã‚„æ–‡ç« ã¯æ›¸ã‹ãªã„ã§ãã ã•ã„ã€‚
  ã€Œï½ã‚’æ“ä½œã™ã‚‹ãƒœã‚¿ãƒ³ã€ã€Œï½ã«ä½¿ã†éƒ¨åˆ†ã€ãªã©ã®èª¬æ˜æ–‡ã¯ç¦æ­¢ã§ã™ã€‚
- å‹ç•ªã‚„è‹±å˜èªãŒå°å­—ã•ã‚Œã¦ã„ã‚‹ç®‡æ‰€ã¯ã€
  å¿…è¦ã«å¿œã˜ã¦ã€ŒDPIãƒœã‚¿ãƒ³ã€ã€ŒON/OFFã‚¹ã‚¤ãƒƒãƒã€ã®ã‚ˆã†ã«
  å°å­—å†…å®¹ã‚’çŸ­ãå–ã‚Šå…¥ã‚Œã¦æ§‹ã„ã¾ã›ã‚“ã€‚
- ä¸æ˜ãªå ´åˆã§ã‚‚ã€Œä¸Šéƒ¨å³å´ã®ãƒœã‚¿ãƒ³ã€ãªã©ã€
  å®Ÿç‰©ã‚’è¦‹ãŸãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒæ··ä¹±ã—ãªã„ãƒ¬ãƒ™ãƒ«ã®ã€å¦¥å½“ãªåç§°ã‚’å¿…ãšä»˜ã‘ã¦ãã ã•ã„ã€‚
  ã€Œä¸æ˜ã€ã€Œ???ã€ãªã©ã¯çµ¶å¯¾ã«ä½¿ã‚ãªã„ã§ãã ã•ã„ã€‚

ã€å‡ºåŠ›å½¢å¼ï¼ˆå³å®ˆï¼‰ã€‘
- å‡ºåŠ›ã¯ã€Œç•ªå·. åç§°ã€ã®å½¢å¼ã ã‘ã«ã—ã¦ãã ã•ã„ã€‚
- 1è¡Œã«ã¤ã1ã¤ã®ç•ªå·ã®ã¿ã‚’æ›¸ã„ã¦ãã ã•ã„ã€‚
- ç•ªå·ã¯ 1 ã‹ã‚‰é †ç•ªã«ã€ç”»åƒä¸Šã®ç•ªå·ã®å€‹æ•°ã¨ä¸€è‡´ã•ã›ã¦ãã ã•ã„ã€‚
- ä½™è¨ˆãªå‰ç½®ãæ–‡ã€è¦‹å‡ºã—ã€ã‚³ãƒ¡ãƒ³ãƒˆã€èª¬æ˜æ–‡ã¯ä¸€åˆ‡æ›¸ã‹ãªã„ã§ãã ã•ã„ã€‚
- ä¾‹ï¼š
1. å·¦ãƒœã‚¿ãƒ³
2. å³ãƒœã‚¿ãƒ³
3. ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒ›ã‚¤ãƒ¼ãƒ«
4. DPIåˆ‡æ›¿ãƒœã‚¿ãƒ³
  `.trim();

  if (!silent) {
    document.getElementById("loadingOverlay").style.display = "flex";
  }

  try {
    const raw = await callAI(prompt, img.dataUrl, "image");
    img.names = normalizeNameText(raw);

    // ç•ªå·ã¯ 1 ã‹ã‚‰æŒ¯ã‚Šç›´ã—
    img.badges = img.badges
      .sort((a,b) => a.num - b.num)
      .map((b,i) => ({ ...b, num: i + 1 }));

    renderImageEditors();
    if (!silent) showToast(`ç”»åƒ${idx+1} ã®åç§°æ¡ˆã‚’æ›´æ–°ã—ã¾ã—ãŸ`);
  } catch (e) {
    console.error(e);
    if (!silent) alert("åç§°æ¡ˆç”Ÿæˆä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒèµ·ãã¾ã—ãŸ: " + e.message);
  } finally {
    if (!silent) {
      document.getElementById("loadingOverlay").style.display = "none";
    }
  }
};



// æ—¢å­˜ãƒ‰ãƒ©ãƒ•ãƒˆã¨æ„å‘³ãŒè¿‘ã„æ–‡ã‚’ã§ãã‚‹ã ã‘é™¤å¤–
function filterNewLinesByExisting(draft, blockText){
    if (!blockText) return "";
    const normDraft = draft.replace(/[ã€‚ã€ï¼ï¼Œ,ãƒ»\s]/g, "");

    const lines = blockText.split("\n")
        .map(l => l.trim())
        .filter(l => l && !l.startsWith("ã€"));

    const kept = [];
    for (const line of lines) {
        const pure = line.replace(/^ãƒ»/, "").trim();
        const normLine = pure.replace(/[ã€‚ã€ï¼ï¼Œ,ãƒ»\s]/g, "");
        if (normLine.length >= 8) {
            const sub = normLine.slice(0, Math.floor(normLine.length * 0.7));
            if (normDraft.includes(sub)) {
                continue;   // æ—¢å­˜ã¨ã‹ãªã‚Šä¼¼ã¦ã„ã‚‹ã®ã§æ¨ã¦ã‚‹
            }
        }
        kept.push(line);
    }
    return kept.join("\n");
}

// ãƒ©ãƒ™ãƒ«ã”ã¨ã«ãƒ–ãƒ­ãƒƒã‚¯ã‚’æŠœãå‡ºã™
function extractBlock(raw, label, nextLabels){
    const pos = raw.indexOf(label);
    if (pos === -1) return "";
    const start = pos + label.length;
    let end = raw.length;
    nextLabels.forEach(l => {
        const p = raw.indexOf(l, start);
        if (p !== -1 && p < end) end = p;
    });
    return raw.slice(start, end).trim();
}


// ã€Œâ– ä½¿ç”¨æ–¹æ³•ã€ãƒ–ãƒ­ãƒƒã‚¯ã®æœ«å°¾ã«è¿½è¨˜ã‚’å·®ã—è¾¼ã‚€
function insertUsageAppend(draft, usageBlock){
    if (!usageBlock) return draft;

    const marker = "â– ä½¿ç”¨æ–¹æ³•";
    const idx = draft.indexOf(marker);
    if (idx < 0) return draft + "\n\n" + usageBlock;

    const after = idx + marker.length;
    const nextHeadingIdx = draft.indexOf("â– ", after);
    const insertPos = nextHeadingIdx === -1 ? draft.length : nextHeadingIdx;

    const head = draft.slice(0, insertPos).replace(/\s*$/, "");
    const tail = draft.slice(insertPos);

    return head + "\n" + usageBlock + "\n" + tail;
}

// ã€Œâ– ä»•æ§˜ã€ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®ä¸­ã§ã€å‹ç•ªè¡Œã®ç›´å¾Œã«ä»•æ§˜æœ¬æ–‡ã‚’å·®ã—è¾¼ã‚€
function insertSpecCore(draft, specBlock){
    if (!specBlock) return draft;

    const lines = draft.split("\n");

    // ã¾ãšã€Œâ– ä»•æ§˜ã€ã®è¡Œã‚’æ¢ã™
    const specIdx = lines.findIndex(l => l.startsWith("â– ä»•æ§˜"));
    if (specIdx === -1) {
        // ä»•æ§˜ã‚»ã‚¯ã‚·ãƒ§ãƒ³è‡ªä½“ãŒãªã„å ´åˆã¯æœ«å°¾ã«è¶³ã™ã ã‘
        return draft + "\n" + specBlock;
    }

    // ã€Œâ– ä»•æ§˜ã€ä»¥é™ã§æœ€åˆã®ã€Œå‹ç•ªï¼šã€è¡Œã‚’æ¢ã™
    let typeLineIdx = -1;
    for (let i = specIdx + 1; i < lines.length; i++) {
        const t = lines[i].trim();
        if (t.startsWith("â– ")) break;              // æ¬¡ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã«åˆ°é”ã—ãŸã‚‰çµ‚äº†
        if (t.startsWith("å‹ç•ªï¼š")) {
            typeLineIdx = i;
            break;
        }
    }

    // å‹ç•ªè¡ŒãŒè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã¯ã€ã€Œâ– ä»•æ§˜ã€ã®ç›´å¾Œã«å…¥ã‚Œã‚‹
    const insertIdx = (typeLineIdx === -1) ? (specIdx + 1) : (typeLineIdx + 1);

    const insertLines = specBlock
        .split(/\r?\n/)
        .map(l => l.replace(/^ãƒ»\s*/, "").trim())    // è¡Œé ­ã®ã€Œãƒ»ã€ã¯å‰Šé™¤
        .filter(l => l !== "");

    lines.splice(insertIdx, 0, ...insertLines);

    return lines.join("\n");
}



// ä»»æ„ã®è¦‹å‡ºã—ï¼ˆä¾‹ï¼šâ– ä½¿ç”¨æ–¹æ³•ï¼‰ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’å·®ã—æ›¿ãˆã‚‹
function replaceSection(draft, title, body){
    const idx = draft.indexOf(title);
    if (idx < 0) return draft;
    const next = draft.indexOf("â– ", idx + title.length);
    const end  = next === -1 ? draft.length : next;
    const head = draft.slice(0, idx);
    const tail = draft.slice(end);
    const section = `${title}\n${body.trim()}\n\n`;
    return head + section + tail;
}

// è¦‹å‡ºã—ã‚¿ã‚¤ãƒˆãƒ«ã‹ã‚‰ã€ãã®ä¸­èº«ã ã‘ã‚’æŠœãå‡ºã™
function getSectionBody(draft, title){
    const idx = draft.indexOf(title);
    if (idx < 0) return "";
    const next = draft.indexOf("â– ", idx + title.length);
    const end  = next === -1 ? draft.length : next;
    return draft.slice(idx + title.length, end).trim();
}


// å‚è€ƒå…ƒãƒãƒ‹ãƒ¥ã‚¢ãƒ«(REF_TEXT)ã‹ã‚‰ã€Œâ– ä»•æ§˜ã€ãƒ–ãƒ­ãƒƒã‚¯ã ã‘æŠœãå‡ºã—ã¦ã€
// å•†å“åãƒ»å‹ç•ªã ã‘ç¾åœ¨ã®å€¤ã«å·®ã—æ›¿ãˆãŸæœ¬æ–‡ã‚’è¿”ã™ã€‚
// è¦‹ã¤ã‹ã‚‰ãªã‘ã‚Œã° null ã‚’è¿”ã™ã€‚
function buildSpecFromReference(pName, mNum){
    if (!REF_TEXT) return null;

    const lines = REF_TEXT.split(/\r?\n/);
    const idx = lines.findIndex(l => l.trim().startsWith("â– ä»•æ§˜"));
    if (idx === -1) return null;

    const body = [];
    for (let i = idx + 1; i < lines.length; i++) {
        const t = lines[i].trim();

        // æ¬¡ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ or å‚è€ƒãƒ•ã‚¡ã‚¤ãƒ«åˆ‡ã‚Šæ›¿ãˆã§çµ‚äº†
        if (t.startsWith("â– ") || t.startsWith("ã€å‚è€ƒ:")) break;

        body.push(lines[i]);
    }
    if (!body.length) return null;

    // å•†å“åãƒ»å‹ç•ªã‚’å·®ã—æ›¿ãˆ
    const nameLabel = `å•†å“åï¼š${pName || "ï¼ˆå•†å“åï¼‰"}`;
    const modelLabel = `å‹ç•ªï¼š${mNum || "ï¼ˆå‹ç•ªï¼‰"}`;

    let nameIdx  = body.findIndex(l => l.trim().startsWith("å•†å“å"));
    let modelIdx = body.findIndex(l => l.trim().startsWith("å‹ç•ª"));

    if (nameIdx === -1 && modelIdx === -1) {
        // å‚è€ƒå…ƒã«å•†å“åãƒ»å‹ç•ªãŒç„¡ã„å ´åˆã¯å…ˆé ­ã«è¿½åŠ 
        body.unshift(modelLabel);
        body.unshift(nameLabel);
    } else {
        if (nameIdx !== -1)  body[nameIdx]  = nameLabel;
        if (modelIdx !== -1) body[modelIdx] = modelLabel;
    }

    return body.join("\n");
}


// å‚è€ƒå…ƒãƒãƒ‹ãƒ¥ã‚¢ãƒ«ã‹ã‚‰ã€Œâ– ä½¿ç”¨æ–¹æ³•ã€ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã ã‘æŠœãå‡ºã™ï¼ˆã‚ã‚Œã°ï¼‰
function getRefUsageBlock() {
    if (!REF_TEXT) return "";

    const lines = REF_TEXT.split(/\r?\n/);
    const idx = lines.findIndex(raw => raw.trim().startsWith("â– ä½¿ç”¨æ–¹æ³•"));
    if (idx === -1) return "";

    const body = [];
    for (let i = idx + 1; i < lines.length; i++) {
        const t = lines[i].trim();
        // æ¬¡ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ or å‚è€ƒãƒ•ã‚¡ã‚¤ãƒ«åˆ‡ã‚Šæ›¿ãˆã§çµ‚äº†
        if (t.startsWith("â– ") || t.startsWith("ã€å‚è€ƒ:")) break;
        body.push(lines[i]);
    }
    return body.join("\n").trim();
}


// REF_TEXT ã‹ã‚‰ã€Œâ– ä»•æ§˜ã€ãƒ–ãƒ­ãƒƒã‚¯ã ã‘ã‚’æŠœãå‡ºã™
function getRefSpecBlock() {
    if (!REF_TEXT) return "";

    const src = REF_TEXT;

    // è¦‹å‡ºã—å€™è£œï¼ˆPDF/Word ã§å¾®å¦™ã«é•ã†å¯èƒ½æ€§ã‚‚è€ƒæ…®ï¼‰
    const heads = ["â– ä»•æ§˜", "â–  ä»•æ§˜", "[ä»•æ§˜]", "ã€ä»•æ§˜ã€‘"];
    let start = -1;
    for (const h of heads) {
        start = src.indexOf(h);
        if (start !== -1) break;
    }

    // è¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã¯å…¨ä½“ã®å…ˆé ­ã ã‘ã‚’å‚è€ƒã«ã™ã‚‹
    if (start === -1) {
        return src.substring(0, 1500);
    }

    // æ¬¡ã®ã€Œâ– ã€è¦‹å‡ºã—ã¾ã§ã‚’ä»•æ§˜ãƒ–ãƒ­ãƒƒã‚¯ã¨ã¿ãªã™
    let end = src.indexOf("â– ", start + 2);
    if (end === -1) end = src.length;

    // ãƒˆãƒ¼ã‚¯ãƒ³æ•°ã‚’æŠ‘ãˆã‚‹ãŸã‚ã«æœ€å¤§ 2000 æ–‡å­—ãã‚‰ã„ã§ã‚«ãƒƒãƒˆ
    return src.slice(start, Math.min(end, start + 2000));
}

// å‚è€ƒå…ƒãƒãƒ‹ãƒ¥ã‚¢ãƒ«ã‹ã‚‰ã€Œâ– ä»•æ§˜ã€ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã ã‘ã‚’ãã®ã¾ã¾å–ã‚Šå‡ºã™
// ãƒ»â– ä»•æ§˜ ã®è¡Œã®æ¬¡ã®è¡Œã‹ã‚‰ã€æ¬¡ã®ã€Œâ– ã€è¦‹å‡ºã—ã¾ã§ã‚’ä»•æ§˜ã¨ã¿ãªã™
// ãƒ»å•†å“åï¼è£½å“åï¼å‹ç•ªã®è¡Œã¯é™¤å¤–
// ãƒ»æœ€å¾Œã«ã€Œå‚è€ƒå…ƒã®ä»•æ§˜ã§ã‚ã‚‹ã€æ—¨ã®æ³¨æ„æ›¸ãã‚’è¿½åŠ 
function buildVerbatimSpecFromReference() {
    if (!REF_TEXT) return null;

    const allLines = REF_TEXT.split(/\r?\n/);

    // ã€Œâ– ä»•æ§˜ã€ã€Œâ–  ä»•æ§˜ã€ã€Œã€ä»•æ§˜ã€‘ã€ã€Œï¼»ä»•æ§˜ï¼½ã€ã®ã„ãšã‚Œã‹ã‚’æ¢ã™
    const specHeadIdx = allLines.findIndex(raw => {
        const t = raw.trim();
        if (!t) return false;
        if (t.startsWith("â– ä»•æ§˜")) return true;
        if (t.startsWith("â–  ä»•æ§˜")) return true;
        if (/^[ã€ï¼»]\s*ä»•æ§˜\s*[ã€‘ï¼½]/.test(t)) return true;
        return false;
    });

    if (specHeadIdx === -1) {
        // å‚è€ƒå…ƒã«ã€Œä»•æ§˜ã€ã®è¦‹å‡ºã—ãŒè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã¯ä½•ã‚‚ã—ãªã„
        return null;
    }

    // è¦‹å‡ºã—ã®æ¬¡ã®è¡Œã‹ã‚‰ã€æ¬¡ã®ã€Œâ– ã€ã¾ãŸã¯ã€Œã€å‚è€ƒ:ã€ã¾ã§ã‚’ä»•æ§˜æœ¬æ–‡ã¨ã™ã‚‹
    const bodyLines = [];
    for (let i = specHeadIdx + 1; i < allLines.length; i++) {
        const t = allLines[i].trim();

        if (!t) {
            bodyLines.push(allLines[i]);
            continue;
        }

        // æ¬¡ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³é–‹å§‹ã§çµ‚äº†
        if (t.startsWith("â– ") || t.startsWith("ã€å‚è€ƒ:")) {
            break;
        }

        bodyLines.push(allLines[i]);
    }

    if (!bodyLines.length) return null;

    // â–¼ å•†å“åï¼è£½å“åï¼å‹ç•ªã®è¡Œã¯é™¤å¤–
    let lines = bodyLines.filter(raw => {
        const t = raw.trim();
        if (!t) return false;
        if (t.startsWith("å•†å“å")) return false;
        if (t.startsWith("è£½å“å")) return false;
        if (t.startsWith("å‹ç•ª"))   return false;
        return true;
    });

    // å…ˆé ­ãƒ»æœ«å°¾ã®ç©ºè¡Œã‚’æ•´ç†
    while (lines.length && !lines[0].trim()) lines.shift();
    while (lines.length && !lines[lines.length - 1].trim()) lines.pop();

    if (!lines.length) return null;

    // æœ€å¾Œã«æ³¨æ„æ›¸ãã‚’è¿½åŠ 
    lines.push(
        "",
        "â€»ä¸Šè¨˜ä»•æ§˜å€¤ã¯å‚è€ƒå…ƒã®å–æ‰±èª¬æ˜æ›¸ã«è¨˜è¼‰ã•ã‚ŒãŸæƒ…å ±ã§ã‚ã‚Šã€æœ¬è£½å“ã®æœ€çµ‚ä»•æ§˜ã¨ã¯ç•°ãªã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ã€‚å¿…ãšæœ€æ–°ã®ä»•æ§˜ã‚’ã”ç¢ºèªãã ã•ã„ã€‚"
    );

    return lines.join("\n");
}




/* ---- åŸç¨¿ç”Ÿæˆ ---- */
async function runGenerationProcess(){
    if(!RAW_DATA.length){ alert("Excelã‚’èª­ã¿è¾¼ã‚“ã§ãã ã•ã„"); return; }
    if(!SELECTED_COMPANY){ alert("åç¾©ã‚’é¸æŠã—ã¦ãã ã•ã„"); return; }

    // å„éƒ¨åç§°ã®ãƒŠãƒ³ãƒãƒªãƒ³ã‚°ç¢ºèª
    const hasParts  = PARTS_IMAGES.length > 0;
    const hasBadges = PARTS_IMAGES.some(img => img.badges && img.badges.length > 0);

    if (hasParts && !hasBadges) {
        const ok = confirm("ã€Œå„éƒ¨ã®åç§°ã€ã®ç”»åƒã«ãƒŠãƒ³ãƒãƒªãƒ³ã‚°ãŒã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚\nã“ã®ã¾ã¾åŸç¨¿ã‚’ç”Ÿæˆã—ã¦ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ");
        if (!ok) return;
    }

    document.getElementById("loadingOverlay").style.display = "flex";

    try{
        await new Promise(r => setTimeout(r, 50));
        let draft = buildDraft();

        // â˜… å‚è€ƒå…ƒã®ä»•æ§˜ã‚’ãã®ã¾ã¾ä»•æ§˜ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã«æŒ¿å…¥
        const verbSpec = buildVerbatimSpecFromReference();
        if (verbSpec) {
            draft = insertSpecCore(draft, verbSpec);
        }

        // å„éƒ¨åç§°ï¼ˆç”»åƒ1ã€œï¼‰ã‚’ã€Œâ– å„éƒ¨ã®åç§°ã€ã«å·®ã—è¾¼ã‚€
        if(PARTS_IMAGES.length){
            let pTxt = "";
            PARTS_IMAGES.forEach((img,i) => {
                if(img.names){
                    pTxt += `\n(ç”»åƒ${i+1})\n${img.names}\n`;
                }
            });
            if(pTxt){
                draft = draft.replace("â– å„éƒ¨ã®åç§°",
                    "â– å„éƒ¨ã®åç§°\n" + pTxt.trim() + "\n");
            }
        }

    // --- AI ã«ã‚ˆã‚‹ã€Œä½¿ç”¨æ–¹æ³•ã€ã€Œä»•æ§˜ã€ã€Œå®‰å…¨ä¸Šã®ã”æ³¨æ„è¿½è¨˜ã€ã®ä½œæˆï¼å·®ã—æ›¿ãˆ ---
    const memo = document.getElementById("productFeatures").value || "";

    // å„éƒ¨åç§°ï¼ˆç”»åƒå´ã§å…¥åŠ›ã—ãŸåç§°ï¼‰ã‚’ã¾ã¨ã‚ã‚‹
    const partsNamesText = PARTS_IMAGES.map((img, idx) => {
        const names = (img.names || "").trim();
        if (!names) return "";
        return `ã€ç”»åƒ${idx + 1} å„éƒ¨ã®åç§°ã€‘\n${names}`;
    }).filter(Boolean).join("\n\n");

if (memo || REF_TEXT || USAGE_IMAGES.length || partsNamesText) {
  const usageDraft = getSectionBody(draft, "â– ä½¿ç”¨æ–¹æ³•");
        const refUsage   = getRefUsageBlock();   // â˜…è¿½åŠ 

        const prompt =
`ã‚ãªãŸã¯æ—¥æœ¬èªãƒãƒ‹ãƒ¥ã‚¢ãƒ«ã®å°‚é–€ãƒ©ã‚¤ã‚¿ãƒ¼ã§ã™ã€‚æ—¥æœ¬èªã ã‘ã§å›ç­”ã—ã¦ãã ã•ã„ã€‚

ç›®çš„ï¼š
1. å‚è€ƒå…ƒãƒãƒ‹ãƒ¥ã‚¢ãƒ«ã‚’ã§ãã‚‹ã ã‘å°Šé‡ã—ã¤ã¤ã€
   ãƒ»ã€Œâ– ä½¿ç”¨æ–¹æ³•ã€ã‚’ã€ã€‘ä»˜ãã®é …ç›®è¦‹å‡ºã—ã”ã¨ã«æ•´ç†ã—ãŸå…¨æ–‡ã«æ›¸ãç›´ã™
2. è¿½åŠ ã§å¿…è¦ãã†ãªå®‰å…¨ä¸Šã®æ³¨æ„ãŒã‚ã‚Œã°ã€ã€Œå®‰å…¨ä¸Šã®ã”æ³¨æ„ï¼ˆè¿½è¨˜æ¡ˆï¼‰ã€ã¨ã—ã¦ææ¡ˆã™ã‚‹ã€‚

ã€è£œè¶³ãƒ¡ãƒ¢ãƒ»æŒ‡ç¤ºã€‘
${memo || "ï¼ˆç‰¹ã«ãªã—ï¼‰"}

ã€å‚è€ƒè³‡æ–™ï¼ˆæŠœç²‹ï¼‰ã€‘
${(REF_TEXT || "ï¼ˆãªã—ï¼‰").substring(0, 3000)}

ã€å„éƒ¨ã®åç§°ï¼ˆç”»åƒã‹ã‚‰å…¥åŠ›æ¸ˆã¿ã®ã‚‚ã®ï¼‰ã€‘
${partsNamesText || "ï¼ˆæœªå…¥åŠ›ï¼‰"}

ã€æ—¢å­˜ãƒ‰ãƒ©ãƒ•ãƒˆã®ã€ä½¿ç”¨æ–¹æ³•ã€æœ¬æ–‡ã€‘
${usageDraft || "ï¼ˆã¾ã æœ¬æ–‡ãªã—ï¼‰"}

ã€å‚è€ƒå…ƒã®ã€ä½¿ç”¨æ–¹æ³•ã€æœ¬æ–‡ï¼ˆã‚ã‚Œã°ï¼‰ã€‘
${refUsage || "ï¼ˆè©²å½“ç®‡æ‰€ãªã—ï¼‰"}

æ¡ä»¶ï¼š
- ä½¿ç”¨æ–¹æ³•ã®é …ç›®åã¯ã€Œã€é›»æ± ã‚’å–ã‚Šä»˜ã‘ã‚‹ã€‘ã€ã®ã‚ˆã†ã«ã€ã€‘ã§å›²ã¿ã€
  ã§ãã‚‹ã ã‘å‚è€ƒå…ƒãƒãƒ‹ãƒ¥ã‚¢ãƒ«ã®è¦‹å‡ºã—åã«æƒãˆã¦ãã ã•ã„ã€‚
- ä½¿ç”¨æ–¹æ³•ã§å‡ºã¦ãã‚‹éƒ¨å“åã¯ã€å¿…ãšã€Œå„éƒ¨ã®åç§°ã€ã§ä½¿ã‚ã‚Œã¦ã„ã‚‹åç§°ã«æƒãˆã¦ãã ã•ã„ã€‚
- ä»•æ§˜ã«é–¢ã™ã‚‹å‡ºåŠ›ã¯ä¸€åˆ‡è¡Œã‚ãªã„ã§ãã ã•ã„ã€‚
- **å‚è€ƒå…ƒã®ã€ä½¿ç”¨æ–¹æ³•ã€ãŒå­˜åœ¨ã™ã‚‹å ´åˆã¯ã€è¡Œæ•°ã‚„æ–‡å­—æ•°ã®ãƒœãƒªãƒ¥ãƒ¼ãƒ ãŒå¤§ããå¤‰ã‚ã‚‰ãªã„ã‚ˆã†ã«ã—ã¦ãã ã•ã„ï¼ˆÂ±30ï¼…ç¨‹åº¦ã®ç¯„å›²ã«åã‚ã‚‹ã‚¤ãƒ¡ãƒ¼ã‚¸ï¼‰ã€‚**

å‡ºåŠ›å½¢å¼ï¼ˆå³å®ˆï¼‰ï¼š
ä¸‹è¨˜ã®2ãƒ–ãƒ­ãƒƒã‚¯ã ã‘ã‚’ã“ã®é †ç•ªã§å‡ºåŠ›ã—ã¦ãã ã•ã„ã€‚

ã€ä½¿ç”¨æ–¹æ³•å…¨æ–‡ã€‘
ï¼ˆã“ã“ã«ã€Œâ– ä½¿ç”¨æ–¹æ³•ã€ã®è¦‹å‡ºã—ã¯å«ã‚ãšã€ç›´ä¸‹ã«å…¥ã‚‹æœ¬æ–‡ã ã‘ã‚’æ›¸ãã€‚
ã€€ã€ã€‘ä»˜ãã®é …ç›®è¦‹å‡ºã—ã¨ã€ãã®ä¸‹ã®ç®‡æ¡æ›¸ãã§æ§‹æˆã™ã‚‹ã“ã¨ï¼‰

ã€å®‰å…¨ä¸Šã®ã”æ³¨æ„è¿½è¨˜ã€‘
ï¼ˆå¿…è¦ã ã¨æ€ã†è¿½è¨˜ã ã‘ã€Œãƒ»ã€ä»˜ãç®‡æ¡æ›¸ãã§æ›¸ãã€‚ä¸è¦ãªã‚‰ç©ºæ¬„ã®ã¾ã¾ã§ã‚ˆã„ï¼‰
`;
const imgContext = USAGE_IMAGES[0]?.dataUrl || null;

// ç”»åƒãŒã‚ã‚‹æ™‚ã ã‘ "image"ã€ç„¡ã„æ™‚ã¯ "check"
const aiText = await callAI(prompt, imgContext, imgContext ? "image" : "check");

        const raw = aiText.trim();

        const usageLabelAll = "ã€ä½¿ç”¨æ–¹æ³•å…¨æ–‡ã€‘";
        const safetyLabel   = "ã€å®‰å…¨ä¸Šã®ã”æ³¨æ„è¿½è¨˜ã€‘";

        const usageBody  = extractBlock(raw, usageLabelAll, [safetyLabel]);
        let   safetyBody = extractBlock(raw, safetyLabel,   [usageLabelAll]);

        // å®‰å…¨è¿½è¨˜ã ã‘ã¯æ—¢å­˜ãƒ‰ãƒ©ãƒ•ãƒˆã¨ã»ã¼åŒã˜æ–‡ã‚’å¼¾ã
        safetyBody = filterNewLinesByExisting(draft, safetyBody);

        // ä½¿ç”¨æ–¹æ³•ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’ã¾ã‚‹ã”ã¨å·®ã—æ›¿ãˆ
        if (usageBody) {
            draft = replaceSection(draft, "â– ä½¿ç”¨æ–¹æ³•", usageBody);
        }

        // å®‰å…¨ä¸Šã®ã”æ³¨æ„ã®è¿½è¨˜æ¡ˆã‚’æœ«å°¾ã«è¿½åŠ 
        if (safetyBody) {
            draft += `

â– å®‰å…¨ä¸Šã®ã”æ³¨æ„ï¼ˆè¿½è¨˜æ¡ˆï¼‰
${safetyBody}
`;
        }
    }
        document.getElementById("previewArea").value = draft;
        showToast("åŸç¨¿ã‚’ç”Ÿæˆã—ã¾ã—ãŸ");
    }catch(e){
        console.error(e);
        alert("åŸç¨¿ç”Ÿæˆä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: " + e.message);
    }finally{
        document.getElementById("loadingOverlay").style.display = "none";
    }
}

function buildDraft(){
    const pName   = document.getElementById("productName").value;
    const mNum    = document.getElementById("modelNumber").value;
    const warranty = document.getElementById("warrantyPeriod").value;

    // --- å®šå‹æ–‡ï¼ˆãƒ†ãƒ³ãƒ—ãƒ¬ï¼‰ã‚°ãƒ«ãƒ¼ãƒ— ----
    const introTpl        = getTemplateTexts("Intro");        // å†’é ­ã‚ã„ã•ã¤
    const commonNoteTpl   = getTemplateTexts("CommonNote");   // å…±é€šæ³¨æ„æ›¸ã
    const maintDefaultTpl = getTemplateTexts("DefaultMaint"); // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãŠæ‰‹å…¥ã‚Œ
    const support3RTpl    = getTemplateTexts("Support_3R");
    const support3RSTpl   = getTemplateTexts("Support_3RS");
    const supportOtherTpl = getTemplateTexts("Support_OTHER");
    const supportCommonTpl= getTemplateTexts("SupportCommon"); // â˜…ä¿è¨¼æœŸé–“ã®ç›´ä¸‹
    const partsRulesTpl   = getTemplateTexts("PartsRules");
    const editionTpl      = getTemplateTexts("Edition");

    const checked = Array.from(document.querySelectorAll('input[type="checkbox"]:checked'))
        .map(c => c.value);
    const hasLi = checked.some(s => s.includes("ãƒªãƒã‚¦ãƒ "));

    const rows = RAW_DATA
        .filter(r => {
            if (r.label.includes("å…±é€š") || r.label.includes("ä¸€èˆ¬")) return true;
            if (r.category.includes("å»ƒæ£„") && !hasLi && !checked.includes(r.label)) return false;
            return checked.includes(r.label);
        })
        .sort((a,b) => {
            const aT = a.label.includes("å…±é€šå†’é ­");
            const bT = b.label.includes("å…±é€šå†’é ­");
            if (aT && !bT) return -1;
            if (!aT && bT) return 1;
            const aB = a.label.includes("å…±é€šæœ«å°¾");
            const bB = b.label.includes("å…±é€šæœ«å°¾");
            if (aB && !bB) return 1;
            if (!aB && bB) return -1;
            return a.id - b.id;
        });

    const s = {
        Intro:[], Danger:[], Warning:[], Caution:[],
        UsageC:[], Giteki:[], Radio:[],
        Parts:[], Usage:[], Maint:[], Disp:[], Spec:[], Other:[]
    };
    const seen = new Set();

    rows.forEach(r => {
        let t = r.content;
        TERMINOLOGY.forEach(x => t = t.replace(x.p, x.r));
        if (seen.has(t)) return;
        seen.add(t);

     const c = r.category || "";
if (c.includes("æŠ€é©")) s.Giteki.push(t);
else if (c.includes("é›»æ³¢")) s.Radio.push(t);
else if (c.includes("å±é™º")) s.Danger.push(t);
else if (c.includes("è­¦å‘Š")) s.Warning.push(t);
else if (c.includes("æ³¨æ„") && !c.includes("ä½¿ç”¨")) s.Caution.push(t);

// â˜…ã“ã“ã‚’å…ˆã«åˆ¤å®šï¼ˆã€Œã”ä½¿ç”¨æ¸ˆã¿â€¦ã€ã§ã€Œä½¿ç”¨ã€ã«èª¤çˆ†ã—ãªã„ã‚ˆã†ã«ã™ã‚‹ï¼‰
else if (c.includes("å»ƒæ£„")) s.Disp.push(t);

else if (c.includes("ä½¿ç”¨")) s.UsageC.push(t);
else if (c.includes("å„éƒ¨")) s.Parts.push(t);
else if (c.includes("ä½¿ç”¨æ–¹æ³•")) s.Usage.push(t);
else if (c.includes("ãŠæ‰‹å…¥ã‚Œ")) s.Maint.push(t);
else if (c.includes("ä»•æ§˜")) s.Spec.push(t);
else if (r.label.includes("å…±é€šå†’é ­")) s.Intro.push(t);
else s.Other.push(t);

    });

    const L = [
        "ä½¿ç”¨ç”»åƒãƒªãƒ³ã‚¯",
        `å•†å“åï¼š${pName}`,
        `å‹ç•ªï¼š${mNum}`,
        "è£½å“å†™çœŸ",
        // â˜… å†’é ­ãƒ»å…±é€šæ³¨æ„ã¯ãƒ†ãƒ³ãƒ—ãƒ¬ã®ã¿ï¼ˆãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ãªã—ï¼‰
        ...introTpl,
        ...commonNoteTpl,
        ...s.Intro,
        ""
    ];

    // â– å®‰å…¨ä¸Šã®ã”æ³¨æ„
    L.push("â– å®‰å…¨ä¸Šã®ã”æ³¨æ„");
    if (s.Danger.length)  L.push("<å±é™º>", ...s.Danger.map(t => "ãƒ»" + t));
    if (s.Warning.length) L.push("<è­¦å‘Š>", ...s.Warning.map(t => "ãƒ»" + t));
    if (s.Caution.length) L.push("<æ³¨æ„>", ...s.Caution.map(t => "ãƒ»" + t));
    L.push("");

    // â– ä½¿ç”¨ä¸Šã®ã”æ³¨æ„
    if (s.UsageC.length){
        L.push("â– ä½¿ç”¨ä¸Šã®ã”æ³¨æ„", ...s.UsageC.map(t => "ãƒ»" + t), "");
    }
    if (s.Giteki.length){
        L.push("â– æŠ€é©ãƒãƒ¼ã‚¯", ...s.Giteki, "");
    }
    if (s.Radio.length){
        L.push("â– é›»æ³¢ã«é–¢ã™ã‚‹æ³¨æ„äº‹é …", ...s.Radio, "");
    }

    // â– å„éƒ¨ã®åç§°ï¼ˆãƒ«ãƒ¼ãƒ«ã¯ PartsRules ãƒ†ãƒ³ãƒ—ãƒ¬ã‹ã‚‰ã®ã¿ï¼‰
    L.push("â– å„éƒ¨ã®åç§°");
    if (partsRulesTpl.length){
        L.push(...partsRulesTpl);
    }
    L.push(...s.Parts.map(t => "ãƒ»" + t), "");

    // â– ä½¿ç”¨æ–¹æ³•ï¼ˆã“ã“ã¯å¾“æ¥é€šã‚Š Excel ç”±æ¥ï¼‰
    L.push("â– ä½¿ç”¨æ–¹æ³•", ...s.Usage.map(t => "ãƒ»" + t), "");

    // â– ãŠæ‰‹å…¥ã‚Œæ–¹æ³•
    L.push("â– ãŠæ‰‹å…¥ã‚Œæ–¹æ³•");
    if (s.Maint.length){
        L.push(...s.Maint);
    } else if (maintDefaultTpl.length){
        // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãŠæ‰‹å…¥ã‚Œã¯ãƒ†ãƒ³ãƒ—ãƒ¬ãŒã‚ã‚Œã°åˆ©ç”¨
        L.push(...maintDefaultTpl);
    }
    L.push("");

    // â– å»ƒæ£„
    if (s.Disp.length){
        L.push("â– ã”ä½¿ç”¨æ¸ˆã¿ã®è£½å“ã®å»ƒæ£„ã«é–¢ã—ã¦", ...s.Disp, "");
    }

    // â– ä»•æ§˜ï¼ˆä¸­èº«ã¯åˆ¥ãƒ­ã‚¸ãƒƒã‚¯ã§å¾Œã‹ã‚‰æŒ¿å…¥ï¼‰
    L.push(
        "â– ä»•æ§˜",
        "â€»ä»˜å±å“ã¯æœ«å°¾ã«ã—ã¾ã™â€»",
        `å•†å“åï¼š${pName}`,
        `å‹ç•ªï¼š${mNum}`,
        ""
    );

    if (s.Other.length){
        L.push("â– ãã®ä»–", ...s.Other.map(t => "ãƒ»" + t), "");
    }

    // â– ã‚µãƒãƒ¼ãƒˆãƒ»ä¼æ¥­æƒ…å ±
    L.push(
        "â– ã‚µãƒãƒ¼ãƒˆãƒ»ä¼æ¥­æƒ…å ±",
        `ä¿è¨¼æœŸé–“ã€€${warranty}`
    );

    // â˜… SupportCommonï¼šä¿è¨¼æœŸé–“ã®ç›´ä¸‹
    if (supportCommonTpl.length){
        L.push(...supportCommonTpl);
    }

    if (SELECTED_COMPANY === "OTHER") {
        // OTHER åç¾©ï¼šSupport_OTHER ãƒ†ãƒ³ãƒ—ãƒ¬ã®ã¿
        if (supportOtherTpl.length){
            L.push(...supportOtherTpl);
        }
    } else {
        // 3R / 3RS åç¾©
        if (SELECTED_COMPANY === "3RS") {
            if (support3RSTpl.length){
                L.push(...support3RSTpl);
            }
        } else { // "3R"
            if (support3RTpl.length){
                L.push(...support3RTpl);
            }
        }
    }

    // ç‰ˆæ•°ï¼ˆEdition ã‚‚ãƒ†ãƒ³ãƒ—ãƒ¬ã®ã¿ï¼‰
    if (editionTpl.length){
        L.push(...editionTpl);
    }

    return L.join("\n");
}

function filterAiCheckOutput(text) {
  const lines = String(text || "").split(/\r?\n/);

  const filtered = lines.filter(line => {
    const s = line.trim();
    if (!s) return true;

    // â‘  è¦‹å‡ºã—ã«é–¢ã™ã‚‹æŒ‡æ‘˜ã£ã½ã„ã‚‚ã®ã‚’é™¤å¤–
    if (/(è¦‹å‡ºã—|ã‚¿ã‚¤ãƒˆãƒ«|é …ç›®å|ç« ç«‹ã¦|æ§‹æˆ|å±é™ºè¦‹å‡ºã—|è­¦å‘Šè¦‹å‡ºã—)/.test(s)) return false;

    // â‘¡ å˜èªã ã‘ï¼ˆç”»åƒ1 ç­‰ï¼‰ã¸ã®æŒ‡æ‘˜ã‚’é™¤å¤–
    if (/^[ï¼ˆ(]?\s*ç”»åƒ\s*\d+\s*[)ï¼‰]?$/.test(s)) return false;

    // â‘¢ â– ä»•æ§˜ã¸ã®æŒ‡æ‘˜ã‚’é™¤å¤–
    if (/(â– \s*ä»•æ§˜|ä»•æ§˜ã‚»ã‚¯ã‚·ãƒ§ãƒ³|ä»•æ§˜æ¬„|ä»•æ§˜ã®è¨˜è¼‰)/.test(s)) return false;

    return true;
  });
const out = filtered.join("\n").trim();
return out; // ä½•ã‚‚ç„¡ã‘ã‚Œã°ç©ºæ–‡å­—ã‚’è¿”ã™

}


    
async function callAI(prompt, img, mode = "check") {
  const payload = {
    prompt,
    mode, // "check" | "image"
    image: (typeof img === "string" && img.length > 0) ? img : null
  };

  const res = await fetch("/api/manual-ai", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(payload)
  });

  if (!res.ok) {
    const txt = await res.text();
    console.error("[callAI] manual-ai error:", txt);
    throw new Error("manual-ai API error: " + txt);
  }

  const data = await res.json();
  if (!data || typeof data.text !== "string") {
    console.error("[callAI] unexpected response:", data);
    throw new Error("manual-ai API response format error");
  }

  return data.text;
}

/* ---- Wordå‡ºåŠ› ---- */
window.exportToWord = async function () {
    try {
        const text = document.getElementById("previewArea").value;
        if (!text) {
            alert("ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãŒç©ºã§ã™");
            return;
        }

        const lines = text.split("\n");
// å‚è€ƒå…ƒä»•æ§˜ãƒ–ãƒ­ãƒƒã‚¯ã‹ã‚‰ã€Œå¼•ç”¨ä»•æ§˜è¡Œã‚»ãƒƒãƒˆã€ã‚’ä½œæˆ
const verbSpec = buildVerbatimSpecFromReference();
const quotedSpecSet = new Set(
    verbSpec
        ? verbSpec.split(/\r?\n/).map(l => l.trim()).filter(Boolean)
        : []
);
        // ç”»åƒ â†’ docx.ImageRun
        const processImg = async (arr, burnBadges) => {
            return Promise.all(arr.map(async img => {
                const c = document.createElement("canvas");
                const ctx = c.getContext("2d");
                const i = new Image();
                await new Promise(r => { i.onload = r; i.src = img.dataUrl || img.data; });

                c.width = i.width;
                c.height = i.height;
                ctx.drawImage(i, 0, 0);

                // å¿…è¦ãªã‚‰ãƒŠãƒ³ãƒãƒªãƒ³ã‚°ã‚’æ›¸ãè¾¼ã‚€
                if (burnBadges && img.badges) {
                    const sX = i.width / 100;
                    const sY = i.height / 100;
                    const r = Math.max(20, i.width * 0.03);
                    ctx.font = `bold ${r}px Arial`;
                    ctx.textAlign = "center";
                    ctx.textBaseline = "middle";
                    img.badges.forEach(b => {
                        ctx.beginPath();
                        ctx.arc(b.x * sX, b.y * sY, r, 0, 2 * Math.PI);
                        ctx.fillStyle = "red";
                        ctx.fill();
                        ctx.fillStyle = "white";
                        ctx.fillText(b.num, b.x * sX, b.y * sY);
                    });
                }

                const blob = await new Promise(r => c.toBlob(r));
                const ab = await blob.arrayBuffer();
                return new docx.ImageRun({
                    data: ab,
                    transformation: {
                        width: 300,
                        height: (300 * i.height) / i.width
                    }
                });
            }));
        };

        const partBlobs  = await processImg(PARTS_IMAGES, true);
        const usageBlobs = await processImg(USAGE_IMAGES, false);


        const children = [];

// â– ä»•æ§˜ å†…ã®çŠ¶æ…‹ç®¡ç†ç”¨ãƒ•ãƒ©ã‚°
let inSpecSection = false;   // ã€Œâ– ä»•æ§˜ã€ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®ä¸­ã‹ã©ã†ã‹
// å¼•ç”¨ä»•æ§˜è¡Œã‹ã©ã†ã‹ã¯ quotedSpecSet ã§åˆ¤å®šã™ã‚‹ã®ã§ inQuotedSpec ã¯å»ƒæ­¢


        for (const line of lines) {
            const trimmed = line.trim();



     // â– è¦‹å‡ºã—è¡Œã®å‡¦ç†
if (trimmed.startsWith("â– ")) {

    // ã€Œâ– ä»•æ§˜ã€é–‹å§‹ï¼çµ‚äº†ã‚’åˆ¤å®š
    if (trimmed === "â– ä»•æ§˜") {
        inSpecSection = true;
    } else {
        // åˆ¥ã®è¦‹å‡ºã—ã«æ¥ãŸã‚‰ä»•æ§˜ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã¯æŠœã‘ã‚‹
        inSpecSection = false;
    }

    // ã€Œâ– å„éƒ¨ã®åç§°ã€ã ã‘ã¯å¾Œã§ç”»åƒã‚’æŒ¿å…¥ã™ã‚‹ã®ã§åˆ¥å‡¦ç†
                if (trimmed.includes("â– å„éƒ¨ã®åç§°")) {
                    // è¦‹å‡ºã—
                    children.push(
                        new docx.Paragraph({
                            children: [
                                new docx.TextRun({
                                    text: trimmed,
                                    font: "Meiryo UI",
                                    bold: true,
                                    size: 24
                                })
                            ],
                            spacing: { before: 200, after: 100 }
                        })
                    );

                    // ç”»åƒ1, ç”»åƒ2...
                    if (partBlobs.length) {
                        partBlobs.forEach((b, index) => {
                            // ãƒ©ãƒ™ãƒ«
                            children.push(
                                new docx.Paragraph({
                                    children: [
                                        new docx.TextRun({
                                            text: `ç”»åƒ${index + 1}`,
                                            font: "Meiryo UI",
                                            bold: true,
                                            size: 21
                                        })
                                    ],
                                    spacing: { after: 50 }
                                })
                            );
                            // ç”»åƒæœ¬ä½“
                            children.push(
                                new docx.Paragraph({
                                    children: [b],
                                    spacing: { after: 200 }
                                })
                            );
                        });
                    }
                    continue; // ã“ã®è¡Œã¯å‡¦ç†æ¸ˆã¿
                }

                // é€šå¸¸ã®è¦‹å‡ºã—
                children.push(
                    new docx.Paragraph({
                        children: [
                            new docx.TextRun({
                                text: trimmed,
                                font: "Meiryo UI",
                                bold: true,
                                size: 24
                            })
                        ],
                        spacing: { before: 200, after: 100 }
                    })
                );
                continue;
            }

            // ã“ã“ã‹ã‚‰å…ˆã¯è¦‹å‡ºã—ä»¥å¤–

            // ç©ºè¡Œ
            if (!trimmed) {
                children.push(new docx.Paragraph({ text: "" }));
                continue;
            }



   // ãƒ†ã‚­ã‚¹ãƒˆãƒ©ãƒ³ã®åŸºæœ¬ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£
const makeRunProps = () => {
    const base = {
        text: trimmed,
        font: "Meiryo UI",
        size: 21
    };

    // â–¼ ã“ã®è¡ŒãŒã€Œå¼•ç”¨ä»•æ§˜ã€ã‹ã©ã†ã‹ã‚’åˆ¤å®š
    // ãƒ»ä»Šã€Œâ– ä»•æ§˜ã€ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®ä¸­ã«ã„ã‚‹ï¼ˆinSpecSection === trueï¼‰
    // ãƒ»ã‹ã¤ quotedSpecSet ã«å«ã¾ã‚Œã¦ã„ã‚‹è¡Œï¼ˆå‚è€ƒä»•æ§˜ãã®ã‚‚ã®ï¼‰
    const isQuotedSpecLine =
        inSpecSection && quotedSpecSet.has(trimmed);

    if (isQuotedSpecLine) {
        base.color = "FF0000";        // èµ¤å­—
        if (trimmed === SPEC_WARNING_LINE) {
            base.bold = true;         // ã“ã®è¡Œã ã‘å¤ªå­—
        }
    }

    return base;
};

            // ç®‡æ¡æ›¸ã
            if (trimmed.startsWith("ãƒ»")) {
                children.push(
                    new docx.Paragraph({
                        children: [
                            new docx.TextRun(makeRunProps())
                        ],
                        spacing: { after: 50 }
                    })
                );
                continue;
            }

            // ã€Œ<å±é™º>ã€ãªã©
            if (trimmed.startsWith("<") && trimmed.endsWith(">")) {
                children.push(
                    new docx.Paragraph({
                        children: [
                            new docx.TextRun({
                                text: trimmed,
                                font: "Meiryo UI",
                                bold: true,
                                size: 22
                            })
                        ],
                        spacing: { before: 100, after: 50 }
                    })
                );
                continue;
            }

            // é€šå¸¸æ–‡
            children.push(
                new docx.Paragraph({
                    children: [
                        new docx.TextRun(makeRunProps())
                    ],
                    spacing: { after: 50 }
                })
            );
        }

        // å‚è€ƒç”»åƒã¯æœ€å¾Œã«ã¾ã¨ã‚ã‚‹
        if (usageBlobs.length) {
            children.push(
                new docx.Paragraph({
                    children: [
                        new docx.TextRun({
                            text: "ã€å‚è€ƒç”»åƒã€‘",
                            font: "Meiryo UI",
                            bold: true
                        })
                    ],
                    pageBreakBefore: true
                })
            );

            usageBlobs.forEach((b, index) => {
                children.push(
                    new docx.Paragraph({
                        children: [
                            new docx.TextRun({
                                text: `å‚è€ƒç”»åƒ${index + 1}`,
                                font: "Meiryo UI",
                                bold: true,
                                size: 21
                            })
                        ],
                        spacing: { after: 50 }
                    })
                );
                children.push(
                    new docx.Paragraph({
                        children: [b],
                        spacing: { after: 200 }
                    })
                );
            });
        }

        const doc = new docx.Document({ sections:[{ children }] });
        const blob = await docx.Packer.toBlob(doc);

        const pName = document.getElementById("productName").value.trim();
        const mNum  = document.getElementById("modelNumber").value.trim();

        let fileName = "manual.docx";
        if (mNum && pName) {
            fileName = `${mNum} ${pName}.docx`;
        } else if (mNum || pName) {
            fileName = `${mNum || pName}.docx`;
        }

        saveAs(blob, fileName);
        showToast("Wordãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä¿å­˜ã—ã¾ã—ãŸ");
    } catch (e) {
        console.error(e);
        alert("Wordå‡ºåŠ›ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: " + e.message);
    }
};

/* ---- ãã®ä»– UI ---- */
function toggleGroup(el){
    const body = el.parentElement.nextElementSibling;
    const checks = body.querySelectorAll("input[type='checkbox']");
    checks.forEach(c => c.checked = false);   // è§£é™¤ã®ã¿
}

function clearChecks(id){
    document.getElementById(id).querySelectorAll("input[type='checkbox']")
        .forEach(c => c.checked = false);
}
function filterFunc(v){
    document.querySelectorAll("#funcArea .checkbox-card").forEach(c => {
        c.style.display = c.innerText.includes(v) ? "flex" : "none";
    });
}
</script>
</body>
</html>
