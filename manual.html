<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AIãƒãƒ‹ãƒ¥ã‚¢ãƒ«åŸç¨¿ä½œæˆæ”¯æ´ãƒ„ãƒ¼ãƒ« (æœ€æ–°ç‰ˆ)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/docx@7.1.0/build/index.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.4.2/mammoth.browser.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.10.377/pdf.min.js"></script>
    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.10.377/pdf.worker.min.js";
    </script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <style>
        body {
            font-family: "Meiryo UI", "Helvetica Neue", Arial, sans-serif;
        }
        .grid-layout {
            display: grid;
            grid-template-columns: 320px 1fr 380px;
            gap: 12px;
        }
        .col-panel {
            padding: 16px;
            display: flex;
            flex-direction: column;
        }
        .section-label {
            font-size: 0.75rem;
            font-weight: bold;
            border-left: 4px solid;
            padding-left: 6px;
            margin-bottom: 6px;
            display: block;
        }
        .border-green-500 { border-color:#22c55e; color:#15803d; }
        .border-blue-500  { border-color:#3b82f6; color:#1d4ed8; }
        .border-purple-500{ border-color:#a855f7; color:#7e22ce; }

        .drop-zone {
            border: 2px dashed #cbd5e1;
            border-radius: 6px;
            padding: 12px;
            text-align: center;
            transition: all 0.2s;
            cursor: pointer;
            background: #f8fafc;
            position: relative;
            display: flex;
            flex-direction: column;
            justify-content: center;
            min-height: 80px;
        }
        .drop-zone:hover {
            border-color: #9ca3af;
            background: #f1f5f9;
        }
        .drop-zone.dragover {
            border-color: #3b82f6;
            background: #eff6ff;
            transform: scale(1.02);
        }
        .file-overlay {
            position:absolute;
            top:0; left:0;
            width:100%; height:100%;
            opacity:0;
            cursor:pointer;
            z-index:10;
        }

        .genre-wrap-area {
            flex:1;
            overflow-y:auto;
            padding:8px;
            background:#f3f4f6;
            display:flex;
            flex-wrap:wrap;
            gap:8px;
            align-content:flex-start;
            min-height:200px;
        }
        .genre-group {
            width:calc(25% - 6px);
            min-width:160px;
            background:#fff;
            border:1px solid #d1d5db;
            border-radius:6px;
            display:flex;
            flex-direction:column;
            flex-shrink:0;
        }
        @media (max-width:1400px){ .genre-group{ width:calc(33.33% - 6px);} }
        @media (max-width:1100px){ .genre-group{ width:calc(50% - 4px);} }

        .genre-group-header {
            padding:6px 8px;
            font-size:.7rem;
            font-weight:bold;
            background:#f9fafb;
            border-bottom:1px solid #e5e7eb;
            color:#374151;
            display:flex;
            justify-content:space-between;
            align-items:center;
            border-top:3px solid transparent;
        }
        .genre-group-content {
            padding:4px;
            display:flex;
            flex-direction:column;
            gap:2px;
        }
        .checkbox-card {
            background:#fff;
            border:1px solid #f3f4f6;
            border-radius:3px;
            padding:3px 6px;
            display:flex;
            align-items:flex-start;
            font-size:.75rem;
            cursor:pointer;
            transition:.1s;
        }
        .checkbox-card:hover {
            border-color:#2563eb;
            background:#eff6ff;
        }
        .checkbox-card input {
            margin-right:6px;
            margin-top:3px;
            transform:scale(.9);
            flex-shrink:0;
            position:relative;
            z-index:5;
        }

        .company-card {
            background:#fff;
            border:1px solid #d1d5db;
            border-radius:6px;
            padding:8px;
            display:flex;
            align-items:center;
            justify-content:center;
            cursor:pointer;
            font-size:.8rem;
            font-weight:bold;
            color:#374151;
            transition:.2s;
            user-select:none;
        }
        .company-card.selected {
            border-color:#2563eb;
            background:#eff6ff;
            color:#1d4ed8;
            box-shadow:0 0 0 1px #2563eb;
        }
        .company-card i { margin-right:6px; }

        .editor-container {
            margin-bottom:8px;
            border:1px solid #e5e7eb;
            padding:6px;
            background:#fff;
            border-radius:4px;
        }
        .editor-header {
            font-size:.7rem;
            font-weight:bold;
            color:#6b7280;
            margin-bottom:4px;
            display:flex;
            justify-content:space-between;
            align-items:center;
        }
        .editor-wrapper {
            position:relative;
            display:inline-block;
            max-width:420px;
            max-height:320px;
            overflow:hidden;
            border:1px solid #ccc;
            border-radius:4px;
            background:#f9fafb;
        }
        .editor-img {
            display:block;
            max-width:100%;
            max-height:320px;
            height:auto;
            user-select:none;
        }
        .badge {
            position:absolute;
            width:20px;
            height:20px;
            background:rgba(255,0,0,.85);
            color:#fff;
            border-radius:50%;
            font-size:12px;
            font-weight:bold;
            display:flex;
            justify-content:center;
            align-items:center;
            cursor:grab;
            transform:translate(-50%,-50%);
            z-index:10;
            border:1px solid #fff;
        }

     .image-drop-zone {
    border:2px dashed #a78bfa;
    background:#faf5ff;
    transition:.2s;
    text-align:center;
    padding:12px;          /* 8 â†’ 12 */
    border-radius:6px;
    cursor:pointer;
    position:relative;
    min-height:120px;      /* 60 â†’ 120 ã§ã ã„ã¶å¤§ãã */
    display:flex;
    flex-direction:column;
    justify-content:center;
    align-items:center;    /* æ¨ªæ–¹å‘ã‚‚ä¸­å¤®å¯„ã› */
    margin-bottom:10px;    /* å°‘ã—ä½™ç™½ã‚’å¢—ã‚„ã™ */
}

        .image-drop-zone.dragover {
            background:#f3e8ff;
            border-color:#7c3aed;
        }
        .preview-grid {
            display:grid;
            grid-template-columns:repeat(auto-fill,minmax(50px,1fr));
            gap:4px;
            margin-top:4px;
        }
        .preview-thumb {
            width:100%;
            height:50px;
            object-fit:cover;
            border-radius:4px;
            border:1px solid #ddd;
        }

        #loadingOverlay {
            position:fixed;
            top:0; left:0;
            width:100%; height:100%;
            background:rgba(255,255,255,.9);
            z-index:9998;
            display:none;
            justify-content:center;
            align-items:center;
            flex-direction:column;
        }
        .spinner {
            width:40px;
            height:40px;
            border:4px solid #e5e7eb;
            border-top-color:#3b82f6;
            border-radius:50%;
            animation:spin 1s linear infinite;
        }
        @keyframes spin {
            0%{transform:rotate(0deg);}
            100%{transform:rotate(360deg);}
        }

.parts-names-box {
    font-size:.7rem;
    line-height:1.4;
    border:1px solid #e5e7eb;
    border-radius:4px;
    padding:4px 6px;
    background:#f9fafb;
    white-space:pre-wrap;
    /* å†…éƒ¨ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’ã‚„ã‚ã‚‹ */
    max-height:none;
    overflow-y:visible;
}

/* --- ãƒ•ã‚©ãƒ³ãƒˆå…¨ä½“ã‚’å°‘ã—å¤§ããã™ã‚‹ --- */
body {
    font-family: "Meiryo UI", "Helvetica Neue", Arial, sans-serif;
    font-size: 14px;   /* ãƒ™ãƒ¼ã‚¹ãƒ•ã‚©ãƒ³ãƒˆã‚¢ãƒƒãƒ— */
}

/* Tailwind ã® text-[10px], text-[11px] ã‚’ä¸Šæ›¸ãã—ã¦å°‘ã—å¤§ããã™ã‚‹ */
.text-\[10px\] {
    font-size: 0.8rem !important;   /* ã ã„ãŸã„ 12.8px ç›¸å½“ */
}
.text-\[11px\] {
    font-size: 0.85rem !important;
}

/* ãƒ©ãƒ™ãƒ«ãªã©ã‚‚å°‘ã—å¤§ãã */
.section-label {
    font-size: 0.8rem;
}
.genre-group-header {
    font-size: 0.8rem;
}
.checkbox-card {
    font-size: 0.8rem;
}
.company-card {
    font-size: 0.85rem;
}

        

        #toast {
            position:fixed;
            bottom:16px;
            right:16px;
            background:#111827;
            color:#f9fafb;
            font-size:.75rem;
            padding:6px 10px;
            border-radius:6px;
            box-shadow:0 10px 15px rgba(0,0,0,.25);
            opacity:0;
            pointer-events:none;
            transition:opacity .25s ease;
            z-index:9999;
        }
        #toast.show { opacity:1; }
    </style>
</head>

<body class="bg-gray-100 text-gray-800">
<div id="loadingOverlay">
    <div class="spinner"></div>
    <div class="mt-4 text-blue-600 font-bold text-lg">å‡¦ç†ä¸­...</div>
</div>
<div id="toast"></div>

<div class="flex-none bg-white shadow z-10 p-3 border-b relative">
    <div class="container mx-auto max-w-full px-4 flex justify-between items-center">
        <h1 class="text-lg font-bold text-gray-800 flex items-center gap-2">
            <i class="fas fa-check-circle text-green-600"></i> ãƒãƒ‹ãƒ¥ã‚¢ãƒ«ä½œæˆ Tool
        </h1>
        <div class="flex gap-2 items-center">

        </div>
    </div>
</div>

<div class="flex-1 container mx-auto max-w-full px-4 py-3 grid-layout">
    <!-- å·¦ã‚«ãƒ©ãƒ  -->
    <div class="col-panel bg-white rounded-lg shadow-sm">



        <div class="mb-6">
    <h3 class="section-label border-blue-500 text-blue-700">1. è£½å“æƒ…å ±</h3>
    <div class="space-y-2">

        <label class="text-[10px] font-bold text-gray-600 block">
            å•†å“å
            <input type="text" id="productName"
                   class="w-full border rounded px-2 py-1.5 text-xs mt-0.5"
                   placeholder="å•†å“å">
        </label>

        <label class="text-[10px] font-bold text-gray-600 block">
            å‹ç•ª
            <input type="text" id="modelNumber"
                   class="w-full border rounded px-2 py-1.5 text-xs mt-0.5"
                   placeholder="å‹ç•ª">
        </label>

        <label class="text-[10px] font-bold text-gray-600 block">
            ä¿è¨¼æœŸé–“
            <select id="warrantyPeriod"
                    class="w-full border rounded px-2 py-1.5 text-xs bg-gray-50 mt-0.5"></select>
        </label>
    </div>
</div>


        <div class="mb-4">
            <h3 class="section-label border-purple-500 text-purple-700">2. AIè§£æãƒ»è³‡æ–™</h3>

            <!-- â‘  å„éƒ¨åç§°ãƒ»ãƒŠãƒ³ãƒãƒªãƒ³ã‚°ï¼ˆãã®ã¾ã¾ï¼‰ -->
            <div class="mb-2">
                <div class="image-drop-zone border-purple-300 bg-purple-50" id="partsImgDrop">
                    <h4 class="text-[10px] font-bold text-purple-700">â‘  å„éƒ¨åç§°ãƒ»ãƒŠãƒ³ãƒãƒªãƒ³ã‚°</h4>
                    <input type="file" id="partsImgInput" accept="image/*" multiple class="file-overlay">
                </div>
                <div id="partsPreview" class="preview-grid"></div>
            </div>

            <!-- â‘¡ å‚è€ƒè³‡æ–™ï¼šç”»åƒ + PDF/Word/TXT ã‚’ã¾ã¨ã‚ã¦æ‰±ã† -->
            <div class="mb-2">
                <div class="image-drop-zone border-blue-300 bg-blue-50" id="refDrop">
                    <h4 class="text-[10px] font-bold text-blue-700">
                        â‘¡ å‚è€ƒè³‡æ–™ï¼ˆç”»åƒ / PDF / Word / ãƒ†ã‚­ã‚¹ãƒˆï¼‰
                    </h4>
                    <input type="file" id="refInput"
                           accept=".pdf,.docx,.txt,image/*"
                           multiple class="file-overlay">
                </div>
                <div id="refFileList" class="mt-1 text-[10px] space-y-1"></div>
            </div>

            <!-- å‚è€ƒè³‡æ–™ã®åˆ©ç”¨æ–¹é‡ãªã©ã®ãƒ¡ãƒ¢ -->
            <label class="text-xs font-bold block mt-2 mb-1 text-gray-500">
                è£œè¶³ãƒ¡ãƒ¢ / å‚è€ƒè³‡æ–™ã®åˆ©ç”¨æ–¹é‡
            </label>
<textarea id="productFeatures" rows="5"
          class="w-full border rounded px-2 py-1.5 text-xs"
          style="min-height: 110px;"
          placeholder="ä¾‹ï¼‰è‡ªç¤¾æ—§ãƒ¢ãƒ‡ãƒ«ãƒãƒ‹ãƒ¥ã‚¢ãƒ«ï¼šæ§‹æˆã¨è¡¨ç¾ã¯ã»ã¼è¸è¥²ã—ã€ä»•æ§˜æ•°å€¤ã ã‘ä»Šå›ã®è£½å“ã«åˆã‚ã›ã¦ãã ã•ã„ã€‚
ä¾‹ï¼‰ä»–ç¤¾ãƒãƒ‹ãƒ¥ã‚¢ãƒ«ï¼šå®‰å…¨ä¸Šã®æ³¨æ„ã ã‘å‚è€ƒã«ã—ã€è¡¨ç¾ã¯å¤‰ãˆã¦ãã ã•ã„ã€‚"></textarea>
        </div>

    </div>

    <!-- ä¸­å¤®ã‚«ãƒ©ãƒ  -->
    <div class="col-panel bg-gray-50">
        <div class="mb-4 bg-white p-3 rounded shadow-sm">
            <div class="flex justify-between mb-2">
                <span class="text-xs font-bold">åç¾©é¸æŠ (å¿…é ˆ)</span>
            </div>
                 <div class="flex gap-2">
                <div class="company-card flex-1" onclick="selectCompany('3R', this)">
                    <i class="far fa-circle"></i> ã‚¹ãƒªãƒ¼ã‚¢ãƒ¼ãƒ«
                </div>
                <div class="company-card flex-1" onclick="selectCompany('3RS', this)">
                    <i class="far fa-circle"></i> ã‚½ãƒªãƒ¥ãƒ¼ã‚·ãƒ§ãƒ³
                </div>
                <div class="company-card flex-1" onclick="selectCompany('OTHER', this)">
                    <i class="far fa-circle"></i> ãã®ä»–
                </div>
            </div>

        </div>

        <div class="flex-1 overflow-hidden flex flex-col">
            <div class="flex justify-between items-center mb-2 px-1">
                <span class="text-xs font-bold text-gray-700">å®‰å…¨ãƒ»æ³¨æ„ã‚¸ãƒ£ãƒ³ãƒ«</span>
                <button onclick="clearChecks('genreArea')"
                        class="text-[10px] text-red-500 hover:underline">å…¨è§£é™¤</button>
            </div>
<div id="genreArea" class="genre-wrap-area border rounded flex-1 mb-3">
    <div class="w-full text-center text-sm text-gray-500 py-10 flex flex-col items-center justify-center gap-2">
        <i class="fas fa-spinner fa-spin text-xl text-blue-500"></i>
        <div>SharePoint ã‹ã‚‰åŸæœ¬ Excel ã‚’èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™...</div>
    </div>
</div>



        </div>

        <!-- å„éƒ¨åç§°ã‚¨ãƒ‡ã‚£ã‚¿ -->
<div id="editorArea"
     class="bg-purple-50 p-2 rounded shadow-sm hidden mb-2 border border-purple-200">
</div>


        <button onclick="runGenerationProcess()" id="genBtn"
                class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 rounded shadow text-sm flex-none flex justify-center items-center gap-2">
            <i class="fas fa-pen-fancy"></i> åŸç¨¿ã‚’ç”Ÿæˆã™ã‚‹
        </button>
    </div>

    <!-- å³ã‚«ãƒ©ãƒ  -->
    <div class="col-panel bg-white rounded-lg shadow-sm flex flex-col">
        <div class="flex justify-between items-center mb-2">
            <h3 class="font-bold text-sm text-gray-700">ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</h3>
            <div class="flex gap-2">
                <button onclick="document.getElementById('previewArea').value=''"
                        class="text-xs bg-gray-200 px-2 py-1 rounded hover:bg-gray-300">ã‚¯ãƒªã‚¢</button>
                <button onclick="exportToWord()"
                        class="text-xs bg-blue-600 text-white px-3 py-1 rounded font-bold hover:bg-blue-700">
                    <i class="fas fa-file-word"></i> Wordä¿å­˜
                </button>
            </div>
        </div>
        <textarea id="previewArea"
                  class="flex-1 w-full border rounded p-3 font-mono text-xs resize-none bg-gray-50 leading-relaxed"></textarea>
    </div>
</div>

<canvas id="processCanvas" style="display:none;"></canvas>

<script>
/* ---- ã‚°ãƒ­ãƒ¼ãƒãƒ« ---- */
let RAW_DATA = [];
let SELECTED_COMPANY = "";
let PARTS_IMAGES = [];
let USAGE_IMAGES = [];
let REF_TEXT = "";
let LIB_READY = false;
let toastTimer = null;

/* ---- å®šæ•° ---- */
const SAFETY_KEYS = ["å±é™º","è­¦å‘Š","æ³¨æ„","ä½¿ç”¨ä¸Šã®"];
const EXCLUDE = ["ãŠæ‰‹å…¥ã‚Œæ–¹æ³•","ã‚¹ãƒªãƒ¼ã‚¢ãƒ¼ãƒ«","ä¼æ¥­æƒ…å ±"];

const UI_GENRES = [
    {
        title: "ğŸ  ç”Ÿæ´»å®¶é›»ãƒ»ç©ºèª¿ãƒ»å—œå¥½å“",
        color: "#f97316",
        keywords: [
            "æ‰‡é¢¨æ©Ÿ","ãƒ•ã‚¡ãƒ³","æƒé™¤æ©Ÿ","ã‚¯ãƒªãƒ¼ãƒŠãƒ¼","åŠ æ¹¿","é™¤æ¹¿","ãƒ’ãƒ¼ã‚¿ãƒ¼","æš–æˆ¿",
            "ä¹¾ç‡¥","ã‚¢ã‚¤ãƒ­ãƒ³","ãƒ¢ã‚¹ã‚­ãƒ¼ãƒˆ","èšŠ","ã‚»ãƒ«ã‚«","ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼",
            "ã‚¿ãƒã‚³","ã‚¢ã‚¤ã‚³ã‚¹","IQOS","é›»å­ã‚¿ãƒã‚³","vape","å–«ç…™",
            "å†·é¢¨æ‰‡","å†·é¢¨æ©Ÿ","ã‚¹ãƒãƒƒãƒˆã‚¯ãƒ¼ãƒ©ãƒ¼",
            "ç©ºæ°—æ¸…æµ„æ©Ÿ","ç©ºæ°—æ¸…æµ„å™¨","ç©ºæ°—æ¸…æµ„"
        ]
    },
    {
        title: "ğŸ”‹ é›»æºãƒ»é›»æ± ãƒ»å……é›»",
        color: "#ef4444",
        keywords: [
            "ãƒªãƒã‚¦ãƒ ","å……é›»æ± ","ä¹¾é›»æ± ","é›»æ± ","ãƒãƒƒãƒ†ãƒªãƒ¼","å……é›»",
            "AC","ã‚¢ãƒ€ãƒ—ã‚¿","é›»æº","ãƒ—ãƒ©ã‚°","ã‚³ãƒ³ã‚»ãƒ³ãƒˆ","USB","é›»åœ§",
            "é…ç·š","ã‚³ãƒ¼ãƒ‰","ã‚±ãƒ¼ãƒ–ãƒ«","é›»åŠ›","ã‚·ãƒ§ãƒ¼ãƒˆ","é™é›»æ°—","é›·",
            "ã‚«ãƒ¼ãƒãƒ£ãƒ¼ã‚¸ãƒ£ãƒ¼","ã‚·ã‚¬ãƒ¼"
        ]
    },
    {
        title: "ğŸ“¡ é€šä¿¡ãƒ»PCãƒ»ç„¡ç·š",
        color: "#8b5cf6",
        keywords: [
            "ç„¡ç·šLAN","Wi-Fi","Bluetooth","ç„¡ç·š","é€šä¿¡","é›»æ³¢","ãƒšã‚¢ãƒªãƒ³ã‚°",
            "ã‚¤ãƒ¤ãƒ›ãƒ³","PCã‚¹ã‚¿ãƒ³ãƒ‰","ãƒã‚¦ã‚¹","ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰","PC","ã‚¹ãƒãƒ›","ã‚¢ãƒ—ãƒª",
            "ãƒ¡ãƒ¢ãƒª","SD","ãƒ‡ãƒ¼ã‚¿","è¨˜éŒ²","IC","ãƒãƒƒãƒ—"
        ]
    },
    {
        title: "ğŸ‘ï¸ å…‰å­¦ãƒ»è¨ˆæ¸¬ãƒ»ç²¾å¯†",
        color: "#eab308",
        keywords: [
            "å·¥æ¥­ç”¨å†…è¦–é¡","å†…è¦–é¡","ã‚«ãƒ¡ãƒ©","ãƒ¬ãƒ³ã‚º","å…‰","LED","ãƒ¬ãƒ¼ã‚¶ãƒ¼","UV",
            "ç›´è¦–","ç¶²è†œ","é¡•å¾®é¡","æ¸¬å®š","è¨ˆæ¸¬","ç²¾å¯†","ç£æ°—",
            "ãƒ©ã‚¤ãƒˆ","ç…§æ˜","æŠ•å…‰å™¨","æ‡ä¸­é›»ç¯",
            "æ‹¡å¤§é¡","ãƒ«ãƒ¼ãƒš",
            "CO2ãƒ¢ãƒ‹ã‚¿","CO2ãƒ¢ãƒ‹ã‚¿ãƒ¼","COâ‚‚","äºŒé…¸åŒ–ç‚­ç´ æ¿ƒåº¦è¨ˆ",
            "ã‚¢ãƒ«ã‚³ãƒ¼ãƒ«ãƒã‚§ãƒƒã‚«ãƒ¼","ã‚¢ãƒ«ã‚³ãƒ¼ãƒ«æ¤œçŸ¥å™¨","ã‚¢ãƒ«ã‚³ãƒ¼ãƒ«ã‚»ãƒ³ã‚µãƒ¼"
        ]
    },
    {
        title: "ğŸ› ï¸ æœ¬ä½“ãƒ»è¨­ç½®ãƒ»æ§‹é€ ",
        color: "#64748b",
        keywords: [
            "ã‚¹ãƒãƒ›ãƒªãƒ³ã‚°","ã‚¹ã‚¿ãƒ³ãƒ‰","ã‚¢ãƒ¼ãƒ ","ãƒ›ãƒ«ãƒ€ãƒ¼","ãƒã‚¦ãƒ³ãƒˆ","ã‚±ãƒ¼ã‚¹","ã‚¹ãƒˆãƒ©ãƒƒãƒ—",
            "æœ¬ä½“","ç­ä½“","å›ºå®š","å¸ç›¤","ç²˜ç€","åˆ†è§£","æ”¹é€ ","ä¿®ç†","è½ä¸‹","è¡æ’ƒ",
            "å¯å‹•","éš™é–“","æŒ‡","æŒŸ","è·é‡","é‹­åˆ©","ã‚¬ãƒ©ã‚¹","è»¢å€’",
            "ãƒ«ãƒ¼ãƒãƒ¼"
        ]
    },
    {
        title: "ğŸ’§ æ°´ãƒ»ç†±ãƒ»ç’°å¢ƒ",
        color: "#3b82f6",
        keywords: [
            "æ°´","æ¶²ä½“","æ¿¡","æ¹¿æ°—","çµéœ²","é˜²æ°´","é›¨","æµ´å®¤","è–¬å“","æ´—å‰¤","æ²¹","è…é£Ÿ",
            "æ¸©åº¦","é«˜æ¸©","ä½æ¸©","å‡çµ","ç«æ°—","ç›´å°„æ—¥å…‰","ä¿ç®¡","å±‹å¤–","ã‚¬ã‚¹","å¼•ç«",
            "ç™ºç†±","éç†±","ç‡ƒãˆ","çˆ†ç™º",
            "ãƒ†ãƒ³ãƒˆ","ã‚¿ãƒ¼ãƒ—","ã‚¢ã‚¦ãƒˆãƒ‰ã‚¢"
        ]
    },
    {
        title: "ğŸ‘¶ å¥åº·ãƒ»å®‰å…¨",
        color: "#ec4899",
        keywords: [
            "å­ä¾›","å¹¼å…","ä¹³å¹¼å…","ãƒšãƒƒãƒˆ","èª¤é£²","çª’æ¯","æ€ªæˆ‘","çš®è†š","èº«ä½“",
            "ã‚¢ãƒ¬ãƒ«ã‚®ãƒ¼","ä½æ¸©ã‚„ã‘ã©","åŒ»ç™‚","ãƒšãƒ¼ã‚¹ãƒ¡ãƒ¼ã‚«ãƒ¼"
        ]
    },
    {
        title: "âš–ï¸ æ³•è¦ãƒ»ç•°å¸¸ãƒ»ãã®ä»–",
        color: "#4b5563",
        keywords: [
            "æŠ€é©","æ³•ä»¤","æ³•å¾‹","å»ƒæ£„","ãƒªã‚µã‚¤ã‚¯ãƒ«","ã‚´ãƒŸ","å…¬åºè‰¯ä¿—","ãƒãƒŠãƒ¼","å…è²¬",
            "è²¬ä»»","æå®³","æ¨©åˆ©","è‘—ä½œ","è­²æ¸¡","ç´›å¤±","ç›—é›£","ç…™","ç•°è‡­","ç•°éŸ³",
            "æ•…éšœ","äº‹æ•…","ä¸­æ­¢","ç•°å¸¸","å®‰å…¨","ç”¨é€”","ç‚¹æ¤œ","å¯¿å‘½"
        ]
    }
];


const TERMINOLOGY = [
    {p:/ã‚»ãƒ³ã‚µãƒ¼/g,r:"ã‚»ãƒ³ã‚µ"},
    {p:/ãƒ¢ãƒ‹ã‚¿ãƒ¼/g,r:"ãƒ¢ãƒ‹ã‚¿"},
    {p:/ãƒãƒƒãƒ†ãƒªãƒ¼/g,r:"ãƒãƒƒãƒ†ãƒª"},
    {p:/ã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ã‚¿ãƒ¼/g,r:"ã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ã‚¿"},
    {p:/ãƒ—ãƒªãƒ³ã‚¿ãƒ¼/g,r:"ãƒ—ãƒªãƒ³ã‚¿"},
    {p:/ã‚¢ãƒ€ãƒ—ã‚¿ãƒ¼/g,r:"ã‚¢ãƒ€ãƒ—ã‚¿"}
];

const SPEC_WARNING_LINE =
"â€»ä¸Šè¨˜ä»•æ§˜å€¤ã¯å‚è€ƒå…ƒã®å–æ‰±èª¬æ˜æ›¸ã«è¨˜è¼‰ã•ã‚ŒãŸæƒ…å ±ã§ã‚ã‚Šã€æœ¬è£½å“ã®æœ€çµ‚ä»•æ§˜ã¨ã¯ç•°ãªã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ã€‚å¿…ãšæœ€æ–°ã®ä»•æ§˜ã‚’ã”ç¢ºèªãã ã•ã„ã€‚";


/* ---- åˆæœŸåŒ– ---- */
window.onload = () => {
    const checkLib = setInterval(() => {
        if (typeof XLSX !== "undefined") {
            clearInterval(checkLib);
            LIB_READY = true;
            document.getElementById("loadingOverlay").style.display = "none";
            document.getElementById("genBtn").disabled = false;
        }
    }, 500);

    setTimeout(() => {
        if (!LIB_READY) {
            clearInterval(checkLib);
            alert("ã€é‡è¦ã€‘Excelèª­è¾¼ãƒ—ãƒ­ã‚°ãƒ©ãƒ ãŒãƒ­ãƒ¼ãƒ‰ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚");
            document.getElementById("loadingOverlay").style.display = "none";
        }
    }, 8000);

    const sel = document.getElementById("warrantyPeriod");
    ["æœªå®š(è¦ç¢ºèª)", "7æ—¥é–“", ...[...Array(11)].map((_, i) => `${i + 1}ã‚«æœˆé–“`), "1å¹´é–“"]
        .flat()
        .forEach(t => {
            const opt = document.createElement("option");
            opt.value = t.includes("æœªå®š") ? "ï¼ˆä¿è¨¼æœŸé–“ï¼‰" : `ã”è³¼å…¥ã‹ã‚‰${t}`;
            opt.innerText = t;
            if (t === "1å¹´é–“") opt.selected = true;
            sel.appendChild(opt);
        });

    // Excel ãƒ‰ãƒ­ãƒƒãƒ—ã¯å»ƒæ­¢ã—ãŸã®ã§ã“ã“ã¯ä½•ã‚‚å‘¼ã°ãªã„
    // setupOverlayDrop("excelDrop", "excelInput", loadExcel);

    setupOverlayDrop("partsImgDrop", "partsImgInput", f => loadImages(f, "parts"));
    setupOverlayDrop("refDrop", "refInput", loadRefs);

    window.addEventListener("paste", e => {
        const items = e.clipboardData.items;
        for (let i = 0; i < items.length; i++) {
            if (items[i].type.indexOf("image") !== -1) {
                loadImages([items[i].getAsFile()], "parts");
                break;
            }
        }
    });

    const saved = localStorage.getItem("manual_tool_api_key");
    if (saved) {
        API_KEY = saved;
        const keyInput = document.getElementById("apiKey");
        if (keyInput) keyInput.value = "********";
    }

    renderImageEditors();

    // â˜… ãƒšãƒ¼ã‚¸è¡¨ç¤ºæ™‚ã«è‡ªå‹•ã§ SharePoint ã‹ã‚‰ Excel ã‚’èª­è¾¼
    loadExcelFromServer();
};


async function loadExcelFromServer() {
  const statusEl = document.getElementById("excelStatus");
  const gArea = document.getElementById("genreArea");

  // å·¦å´ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒæ®‹ã£ã¦ã„ã‚Œã°æ›´æ–°ï¼ˆå‰Šé™¤ã•ã‚Œã¦ã„ãŸã‚‰ç„¡è¦–ï¼‰
  if (statusEl) statusEl.innerText = "SharePoint ã‹ã‚‰èª­ã¿è¾¼ã¿ä¸­...";

  // â˜… å®‰å…¨ãƒ»æ³¨æ„ã‚¸ãƒ£ãƒ³ãƒ«ã®ä¸­å¤®ã«ã€Œèª­ã¿è¾¼ã¿ä¸­ã€è¡¨ç¤º
  if (gArea) {
    gArea.innerHTML = `
      <div class="w-full text-center text-sm text-gray-500 py-10 flex flex-col items-center justify-center gap-2">
        <i class="fas fa-spinner fa-spin text-2xl text-blue-500"></i>
        <div>SharePoint ã‹ã‚‰åŸæœ¬ Excel ã‚’èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™...</div>
      </div>`;
  }

  try {
    const res = await fetch("/api/manual-test");
    const data = await res.json();

    console.log("[loadExcelFromServer] response:", data);

    // å·¦æ¬„ãŒæ®‹ã£ã¦ã„ã‚Œã°
    if (statusEl) {
      statusEl.innerText = `èª­è¾¼å®Œäº†: ${data.rows.length}ä»¶`;
      statusEl.classList.add("text-green-600");
    }

    // å…¨è¡Œãƒ‡ãƒ¼ã‚¿ã‚’ä¿æŒ
    RAW_DATA = data.rows || [];

    // ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹æç”»
    renderCheckboxes(RAW_DATA);

  } catch (err) {
    console.error("[loadExcelFromServer] error:", err);

    if (statusEl) statusEl.innerText = "èª­è¾¼ã‚¨ãƒ©ãƒ¼";

    // â˜… èª­è¾¼å¤±æ•—æ™‚ã®è¡¨ç¤º
    if (gArea) {
      gArea.innerHTML = `
        <div class="w-full text-center text-red-500 text-sm py-10">
          åŸæœ¬ Excel ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚<br>
          ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚
        </div>`;
    }

    alert("Excel èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼: " + err.message);
  }
}





/* ---- å…±é€šãƒ˜ãƒ«ãƒ‘ãƒ¼ ---- */
function showToast(msg){
    const t = document.getElementById("toast");
    t.textContent = msg;
    t.classList.add("show");
    if(toastTimer) clearTimeout(toastTimer);
    toastTimer = setTimeout(()=>t.classList.remove("show"), 2500);
}

function saveKey() {
  alert("ã“ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã§ã¯ãƒ–ãƒ©ã‚¦ã‚¶å´ã§ã® APIã‚­ãƒ¼è¨­å®šã¯ä¸è¦ã§ã™ï¼ˆã‚µãƒ¼ãƒãƒ¼å´ã§ç®¡ç†ã—ã¦ã„ã¾ã™ï¼‰ã€‚");
}


function selectCompany(code, el){
    SELECTED_COMPANY = code;

    document.querySelectorAll(".company-card").forEach(c => {
        c.classList.remove("selected");
        const icon = c.querySelector("i");
        if(icon){
            icon.className = "far fa-circle";   // ç©ºã®ä¸¸ã«æˆ»ã™
        }
    });

    el.classList.add("selected");
    const icon = el.querySelector("i");
    if(icon){
        icon.className = "fas fa-check-circle"; // å¡—ã‚Šã¤ã¶ã—ä¸¸ã«å¤‰æ›´
    }
}

/* ---- ãƒ‰ãƒ­ãƒƒãƒ—è¨­å®š ---- */
function setupOverlayDrop(zoneId, inputId, handler) {
    const z = document.getElementById(zoneId);
    const i = document.getElementById(inputId);
    if (!z || !i) return;

    // â–¼ ã‚¾ãƒ¼ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ãŸã‚‰ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’é–‹ãï¼ˆå¿µã®ãŸã‚ï¼‰
    z.addEventListener("click", () => i.click());

    // â–¼ ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠï¼ˆclick/ãƒ‰ãƒ­ãƒƒãƒ—ã®ä¸¡æ–¹ï¼‰ã§ç™ºç«
    i.addEventListener("change", e => {
        const files = e.target.files;
        if (files && files.length > 0) {
            handler(files);
        }
        // åŒã˜ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç¶šã‘ã¦é¸ã¹ã‚‹ã‚ˆã†ã«ãƒªã‚»ãƒƒãƒˆ
        i.value = "";
    });

    // â–¼ dragenter / dragoverï¼ˆã‚¾ãƒ¼ãƒ³ + input ä¸¡æ–¹ã§æ‹¾ã†ï¼‰
    ["dragenter","dragover"].forEach(ev => {
        [z, i].forEach(el => {
            el.addEventListener(ev, e => {
                e.preventDefault();
                e.stopPropagation();
                z.classList.add("dragover");
            });
        });
    });

    // â–¼ dragleave / dropï¼ˆã‚¾ãƒ¼ãƒ³ + input ä¸¡æ–¹ã§æ‹¾ã†ï¼‰
    ["dragleave","drop"].forEach(ev => {
        [z, i].forEach(el => {
            el.addEventListener(ev, e => {
                e.preventDefault();
                e.stopPropagation();
                z.classList.remove("dragover");
            });
        });
    });

    // â–¼ å®Ÿéš›ã® drop ã§ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ handler ã«æ¸¡ã™ï¼ˆã‚¾ãƒ¼ãƒ³ + input ä¸¡æ–¹ï¼‰
    const handleDrop = e => {
        e.preventDefault();
        e.stopPropagation();
        const files = (e.dataTransfer && e.dataTransfer.files) || (e.target && e.target.files);
        if (files && files.length > 0) {
            handler(files);
        }
    };

    z.addEventListener("drop", handleDrop);
    i.addEventListener("drop", handleDrop);
}


/* ---- Excel èª­è¾¼ï¼ˆå¼·åŒ–ç‰ˆï¼‰ ---- */
function loadExcel(files){
    const statusEl = document.getElementById("excelStatus");

    console.log("[loadExcel] å‘¼ã³å‡ºã—:", files);

    if (!files || !files.length) {
        console.error("[loadExcel] files ãŒç©º");
        statusEl.innerText = "ãƒ•ã‚¡ã‚¤ãƒ«ãŒèª­ã¿è¾¼ã‚ã¾ã›ã‚“";
        return;
    }

    const file = files[0];
    if (!file) {
        console.error("[loadExcel] files[0] ãŒ undefined");
        statusEl.innerText = "ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼";
        return;
    }

    statusEl.innerText = "èª­è¾¼ä¸­...";

    const reader = new FileReader();

    reader.onerror = e => {
        console.error("[loadExcel] FileReader ã‚¨ãƒ©ãƒ¼:", e);
        statusEl.innerText = "ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ";
        alert("Excel ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸï¼ˆFileReader errorï¼‰");
    };

    reader.onload = e => {
        try {
            const arr = e.target.result;
            console.log("[loadExcel] FileReader success");

            if (typeof XLSX === "undefined") {
                throw new Error("XLSX ãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“ï¼ˆCDN ã®èª­ã¿è¾¼ã¿å¤±æ•—ï¼‰");
            }

            const wb = XLSX.read(arr, { type: "array" });

            if (!wb || !wb.SheetNames || wb.SheetNames.length === 0) {
                throw new Error("Excel ã«ã‚·ãƒ¼ãƒˆãŒã‚ã‚Šã¾ã›ã‚“");
            }

            const sheet = wb.Sheets[wb.SheetNames[0]];
            if (!sheet) {
                throw new Error("æœ€åˆã®ã‚·ãƒ¼ãƒˆãŒèª­ã¿å–ã‚Œã¾ã›ã‚“");
            }

            const data = XLSX.utils.sheet_to_json(sheet, { header: 1 });

            if (!Array.isArray(data) || data.length === 0) {
                throw new Error("Excel ã®å†…å®¹ã‚’èª­ã¿å–ã‚Œã¾ã›ã‚“");
            }

            console.log("[loadExcel] ã‚·ãƒ¼ãƒˆè¡Œæ•°:", data.length);

            let lastLabel = "";
            RAW_DATA = data.slice(1).map((row, idx) => {
                if (!row || (row[1] == null && row[2] == null)) return null;

                let label = (row[0] || "").toString().trim();
                if (label === "") label = lastLabel; else lastLabel = label;

                const category = (row[1] || "").toString().trim();
                const content  = (row[2] || "").toString().trim();

                return { id: idx, label, category, content };
            }).filter(r =>
                r !== null &&
                r.label &&
                r.content &&
                r.label !== "é …ç›®å"
            );

            console.log("[loadExcel] ãƒ‘ãƒ¼ã‚¹å¾Œä»¶æ•°:", RAW_DATA.length);

            renderCheckboxes();

            statusEl.innerText = `å®Œäº†: ${RAW_DATA.length}ä»¶`;
        }
        catch (err) {
            console.error("[loadExcel] èª­è¾¼ã‚¨ãƒ©ãƒ¼:", err);
            statusEl.innerText = "èª­è¾¼ã‚¨ãƒ©ãƒ¼";
            alert("Excel èª­è¾¼ã‚¨ãƒ©ãƒ¼: " + err.message);
        }
    };

    reader.readAsArrayBuffer(file);
}






/* ---- ç”»åƒãƒ»è³‡æ–™ ---- */
function loadImages(files, type){
    Array.from(files).forEach(f => {
        const r = new FileReader();
        r.onload = e => {
            if(type === "parts"){
                PARTS_IMAGES.push({
                    id:Date.now()+Math.random(),
                    name:f.name,
                    dataUrl:e.target.result,
                    badges:[],
                    names:"",
                    nameHint:""
                });
                renderImageEditors();
                updateFileList("partsPreview", PARTS_IMAGES, "parts");
            }else{
                USAGE_IMAGES.push({ name:f.name, dataUrl:e.target.result });
                updateFileList("usageImgList", USAGE_IMAGES, "usage");
            }
        };
        r.readAsDataURL(f);
    });
}

function updateFileList(elId, list, type){
    const el = document.getElementById(elId);
    if(type === "parts"){
        el.innerHTML = list.map((f,i) =>
            `<div class="inline-block relative m-1">
                <img src="${f.dataUrl}" class="preview-thumb">
                <span onclick="removeFile('parts',${i})"
                      class="absolute top-0 right-0 bg-red-500 text-white text-[8px] px-1 cursor-pointer">Ã—</span>
            </div>`
        ).join("");
    }else{
        el.innerHTML = list.map((f,i) =>
            `<div class="file-item text-[10px] flex justify-between items-center">
                <span>${f.name}</span>
                <span class="text-red-500 cursor-pointer" onclick="removeFile('usage',${i})">Ã—</span>
            </div>`
        ).join("");
    }
}

window.removeFile = function(type, idx){
    if(type === "parts"){
        PARTS_IMAGES.splice(idx,1);
        renderImageEditors();
        updateFileList("partsPreview", PARTS_IMAGES, "parts");
    }else{
        USAGE_IMAGES.splice(idx,1);
        updateFileList("usageImgList", USAGE_IMAGES, "usage");
    }
};

async function loadRefs(files){
    const el = document.getElementById("refFileList");

    for (let f of files) {
        try {
            // ç”»åƒãƒ•ã‚¡ã‚¤ãƒ« â†’ USAGE_IMAGES ã«ä¿å­˜ï¼ˆWordå‡ºåŠ›ã‚„AIã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆç”¨ï¼‰
            if (f.type && f.type.startsWith("image/")) {
                const dataUrl = await new Promise((resolve, reject) => {
                    const r = new FileReader();
                    r.onload = e => resolve(e.target.result);
                    r.onerror = reject;
                    r.readAsDataURL(f);
                });

                USAGE_IMAGES.push({ name: f.name, dataUrl });
                el.innerHTML += `
                    <div class="file-item text-[10px] flex items-center gap-1">
                        <span>[ç”»åƒ] ${f.name}</span>
                        <i class="fas fa-check text-green-500"></i>
                    </div>`;
                continue;
            }

            // ç”»åƒä»¥å¤– â†’ ãƒ†ã‚­ã‚¹ãƒˆåŒ–ã—ã¦ REF_TEXT ã«è¿½è¨˜
            let txt = "";
            if (f.name.endsWith(".pdf")) {
                const ab = await f.arrayBuffer();
                const pdf = await pdfjsLib.getDocument(ab).promise;
                for (let i = 1; i <= pdf.numPages; i++) {
                    const page = await pdf.getPage(i);
                    const content = await page.getTextContent();
                    txt += content.items.map(s => s.str).join(" ");
                }
            } else if (f.name.endsWith(".docx")) {
                const res = await mammoth.extractRawText({ arrayBuffer: await f.arrayBuffer() });
                txt = res.value;
            } else {
                txt = await f.text();
            }

            // â˜…å…¨æ–‡ã‚’ä¿æŒã™ã‚‹ï¼ˆãƒˆãƒ¼ã‚¯ãƒ³é‡ã¯ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆå´ã§åˆ¶é™ã™ã‚‹ï¼‰
REF_TEXT += `\nã€å‚è€ƒ:${f.name}ã€‘\n${txt}\n`;


            el.innerHTML += `
                <div class="file-item text-[10px] flex items-center gap-1">
                    <span>[æ–‡æ›¸] ${f.name}</span>
                    <i class="fas fa-check text-green-500"></i>
                </div>`;
        } catch(e) {
            console.error(e);
            alert("ãƒ•ã‚¡ã‚¤ãƒ«èª­è¾¼å¤±æ•—: " + f.name);
        }
    }
}

/* ---- å®‰å…¨ã‚¸ãƒ£ãƒ³ãƒ«æç”» ---- */
function normalizeForGenre(text){
    return text.toLowerCase()
        .replace(/[â€\-â€“â€”ãƒ¼_ï¼\s]/g,"")
        .replace(/ãƒ»/g,"");
}

function renderCheckboxes() {
    const gArea = document.getElementById("genreArea");
    const fArea = document.getElementById("funcArea");   // ç„¡ã„å ´åˆã‚‚ã‚ã‚‹
    gArea.innerHTML = "";
    if (fArea) fArea.innerHTML = "";

    // ãƒ©ãƒ™ãƒ«ã”ã¨ã«ã€Œå®‰å…¨ç³»ã‹ã©ã†ã‹ã€ã‚’åˆ¤å®š
    const map = new Map();
    RAW_DATA.forEach(r => {
        if (
            r.label.includes("å…±é€š") ||
            r.label.includes("ã‚¹ãƒªãƒ¼ã‚¢ãƒ¼ãƒ«") ||
            EXCLUDE.some(e => r.label.includes(e)) ||
            r.category === "ãŠæ‰‹å…¥ã‚Œæ–¹æ³•"
        ) {
            return;
        }
        if (!map.has(r.label)) map.set(r.label, { isSafe: false, category: r.category || "" });
        if (r.category && SAFETY_KEYS.some(k => r.category.includes(k))) {
            map.get(r.label).isSafe = true;
        }
    });

    const buckets = {};
    UI_GENRES.forEach(g => buckets[g.title] = []);
    const funcs = [];

    map.forEach((v, k) => {
        if (v.isSafe) {
            const norm = normalizeForGenre(k + " " + (v.category || ""));
            let matched = false;
            for (const g of UI_GENRES) {
                if (g.keywords.some(kw => norm.includes(normalizeForGenre(kw)))) {
                    buckets[g.title].push(k);
                    matched = true;
                    break;
                }
            }
            if (!matched) {
                const last = UI_GENRES[UI_GENRES.length - 1];
                buckets[last.title].push(k);
            }
        } else {
            funcs.push(k);
        }
    });

    // å®‰å…¨ã‚¸ãƒ£ãƒ³ãƒ«å´
    UI_GENRES.forEach(g => {
        const list = buckets[g.title];
        if (list && list.length) {
            const div = document.createElement("div");
            div.className = "genre-group";
            div.innerHTML = `
                <div class="genre-group-header" style="border-top-color:${g.color}">
                    <span>${g.title}</span>
                    <span onclick="toggleGroup(this)" class="cursor-pointer text-blue-600 text-[10px]">
                        è§£é™¤
                    </span>
                </div>`;
            const body = document.createElement("div");
            body.className = "genre-group-content";
            list.sort().forEach(l => body.appendChild(createCheck(l)));
            div.appendChild(body);
            gArea.appendChild(div);
        }
    });

    // æ§‹æˆãƒ»ãã®ä»–å´ã¯ä»Šã¯ç”»é¢ã«ç„¡ã„ã®ã§ä½•ã‚‚ã—ãªã„
    // ï¼ˆfArea ãŒå­˜åœ¨ã™ã‚‹ç’°å¢ƒã§ã ã‘ä½¿ã„ãŸããªã£ãŸã‚‰ã“ã“ã§ appendï¼‰
}

function createCheck(label){
    const l = document.createElement("label");
    l.className = "checkbox-card";
    l.innerHTML = `<input type="checkbox" value="${label}"><span>${label}</span>`;
    return l;
}


/* ---- å„éƒ¨ã®åç§°ã‚¨ãƒ‡ã‚£ã‚¿ ---- */
function renumberBadges(img){
    img.badges.forEach((b,i) => { b.num = i+1; });
}

// ç”»åƒã”ã¨ã«ã€Œãƒãƒƒã‚¸æ•°ã€ã¨ã€Œåç§°è¡Œæ•°ã€ã‚’ãã‚ãˆã‚‹
function syncBadgesAndNames(img){
    if (!img) return;

    // åç§°ã‚’è¡Œå˜ä½ã«ã°ã‚‰ã™ï¼ˆç©ºè¡Œã¯é™¤å¤–ï¼‰
    const lines = (img.names || "")
        .split(/\r?\n/)
        .map(l => l.trim())
        .filter(l => l !== "");

    // ã©ã¡ã‚‰ã‹ãŒ 0 ã®ã¨ãã¯ç„¡ç†ã«åˆã‚ã›ãªã„ï¼ˆæ‰‹å‹•ç·¨é›†ä¸­ã®å¯èƒ½æ€§ã‚ã‚Šï¼‰
    if (!img.badges || img.badges.length === 0 || lines.length === 0) {
        img.names = lines.join("\n");
        return;
    }

// ãƒãƒƒã‚¸æ•°ã«åç§°è¡Œæ•°ã‚’åˆã‚ã›ã‚‹ï¼ˆãƒãƒƒã‚¸æ•°ã‚’çµ¶å¯¾å„ªå…ˆï¼‰
const badgeCount = img.badges.length;

// è¡Œæ•°ã‚’ badgeCount ã«ã‚ã‚ã›ã‚‹
let newLines = [];

for (let i = 0; i < badgeCount; i++) {
    newLines.push(lines[i] || "");   // è¡Œä¸è¶³ãªã‚‰ç©ºæ¬„
}

img.names = newLines.join("\n");

}
function normalizeNameText(text){
    if (!text) return "";

    // â‘  è¡Œã”ã¨ã«åˆ†å‰²
    const rawLines = text.split(/\r?\n/);

    // â‘¡ ã€Œç”»åƒã®éƒ¨å“åç§°ï½ã€ã®ã‚ˆã†ãªå‰ç½®ãæ–‡ã‚’ 1 è¡Œã ã‘ã‚¹ã‚­ãƒƒãƒ—
    const lines = [];
    let skippedDesc = false;
    for (const raw of rawLines) {
        const t = raw.trim();
        if (
            !skippedDesc &&
            t &&
            /ç”»åƒã®éƒ¨å“åç§°|éƒ¨å“åç§°\(ä¸Šé¢ã‹ã‚‰è¦‹ãˆã‚‹ã‚‚ã®\)ã‚’ç‰¹å®š/.test(t)
        ) {
            skippedDesc = true;
            continue;   // ã“ã®è¡Œã¯åç§°æ¡ˆã‹ã‚‰é™¤å¤–
        }
        lines.push(raw);
    }

    // â‘¢ å„è¡Œã‚’æ•´å½¢
    return lines
        .map(line => {
            if (!line.trim()) return "";

            // å…¨è§’â†’åŠè§’ãªã©ã®æ­£è¦åŒ–
            let l = line.normalize("NFKC");

            // è¡Œé ­ã®ç©ºç™½é¡ã‚’ã™ã¹ã¦å‰Šé™¤
            l = l.replace(/^[\s\u3000\u00A0\uFEFF]+/, "");

            // ã€Œâ€»1ï¼‰ã€ã€Œâ— ï¼‘. ã€ãªã©ã‚’ã€Œ1. ã€å½¢å¼ã«ãã‚ãˆã‚‹
            l = l.replace(
                /^[^\d]*?(\d+)[\s\u3000\.ã€‚ã€ï¼)ï¼‰]*\s*/,
                "$1. "
            );

            // ï¼ˆï¼‰å†…ã®èª¬æ˜æ–‡ã‚’å‰Šé™¤ï¼ˆå…¨è§’ãƒ»åŠè§’ã©ã¡ã‚‰ã‚‚ï¼‰
            l = l.replace(/[ï¼ˆ\(][^ï¼‰\)]*[ï¼‰\)]/g, "");

            // 2 å€‹ä»¥ä¸Šã®ç©ºç™½ã‚’ 1 å€‹ã«
            l = l.replace(/[\s\u3000]{2,}/g, " ");

            return l.trim();
        })
        .filter(l => l !== "")
        .join("\n");
}


function clearAllPartNames(){
    PARTS_IMAGES.forEach(img => {
        img.names  = "";
        img.badges = [];   // â˜… ãƒŠãƒ³ãƒãƒªãƒ³ã‚°ã‚‚åŒæ™‚ã«ã‚¯ãƒªã‚¢
    });
    renderImageEditors();
    showToast("åç§°ã¨ãƒŠãƒ³ãƒãƒªãƒ³ã‚°ã‚’ã™ã¹ã¦ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸ");
}

function clearSinglePartNames(idx){
    const img = PARTS_IMAGES[idx];
    if (!img) return;
    img.names  = "";
    img.badges = [];
    renderImageEditors();
}


// ç”»åƒ1æšåˆ†ã ã‘ åç§°ï¼†ãƒŠãƒ³ãƒãƒªãƒ³ã‚°ã‚’ã‚¯ãƒªã‚¢
function clearPartNames(idx){
    const img = PARTS_IMAGES[idx];
    if (!img) return;

    img.names  = "";
    img.badges = [];  // ç•ªå·ã‚‚ã‚¯ãƒªã‚¢

    renderImageEditors();
    showToast(`ç”»åƒ${idx+1}ã®åç§°ã¨ç•ªå·ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸ`);
}


function renderImageEditors(){
    const area = document.getElementById("editorArea");
    area.innerHTML = "";
    area.classList.remove("hidden");   // â˜… æœ€åˆã‹ã‚‰è¡¨ç¤ºã•ã›ã‚‹

    // ç”»åƒãŒã¾ã ãªã„ã¨ãï¼ˆã“ã“ã‚’è¿½åŠ ã™ã‚‹ï¼‰
    if(!PARTS_IMAGES.length){
        const header = document.createElement("div");
        header.className = "mb-1";
        header.innerHTML = `
            <div class="text-[11px] font-bold text-purple-800 flex justify-between items-center">
                <span>å„éƒ¨ã®åç§° ãƒŠãƒ³ãƒãƒªãƒ³ã‚°ï¼åç§°æ¡ˆ</span>
            </div>
            <p class="text-[10px] text-purple-700 mt-1 leading-relaxed">
                å·¦ã®ã€Œâ‘  å„éƒ¨åç§°ãƒ»ãƒŠãƒ³ãƒãƒªãƒ³ã‚°ã€ã«ç”»åƒã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ã¨ã€<br>
                ã“ã“ã§ç•ªå·ä»˜ã‘ã¨åç§°å…¥åŠ›ãŒã§ãã¾ã™ã€‚
            </p>`;
        area.appendChild(header);
        return;
    }

    // ------ ã“ã“ã‹ã‚‰å…ˆã¯å…ƒã®ã‚³ãƒ¼ãƒ‰ãã®ã¾ã¾ ------
    const header = document.createElement("div");
    header.className = "mb-1";
    header.innerHTML = `
        <div class="text-[11px] font-bold text-purple-800 flex justify-between items-center">
            <span>å„éƒ¨ã®åç§° ãƒŠãƒ³ãƒãƒªãƒ³ã‚°ï¼åç§°æ¡ˆ</span>
            <div class="flex gap-1">
                <button onclick="clearAllPartNames()"
                    class="text-[10px] px-2 py-1 bg-gray-200 text-gray-800 rounded border border-gray-300">
                    å…¨ã¦ã®ç”»åƒã®ãƒŠãƒ³ãƒãƒªãƒ³ã‚°ã¨åç§°ã‚’ã‚¯ãƒªã‚¢
                </button>
                <button onclick="generatePartsNamesAll()"
                    class="text-[10px] px-2 py-1 bg-purple-600 text-white rounded">
                    å…¨ç”»åƒ åç§°æ¡ˆã‚’ç”Ÿæˆ
                </button>
            </div>
        </div>
        <p class="text-[10px] text-purple-700 mt-1 leading-relaxed">
            å³ã‚¯ãƒªãƒƒã‚¯ï¼šç•ªå·è¿½åŠ ï¼ç•ªå·ãƒ‰ãƒ©ãƒƒã‚°ï¼šä½ç½®èª¿æ•´ï¼ãƒ€ãƒ–ãƒ«ã‚¯ãƒªãƒƒã‚¯ï¼šç•ªå·å‰Šé™¤ã€‚<br>
            å¿…ãšå…ˆã«ã€ç”»åƒä¸Šã®ã™ã¹ã¦ã®å¿…è¦ãªéƒ¨ä½ã¸æ‰‹å‹•ã§ãƒŠãƒ³ãƒãƒªãƒ³ã‚°ã‚’è¡Œã£ã¦ã‹ã‚‰ã€Œåç§°æ¡ˆã‚’ç”Ÿæˆã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚
            AIã«ã‚ˆã‚‹è‡ªå‹•ãƒŠãƒ³ãƒãƒªãƒ³ã‚°ã¯è¡Œã£ã¦ã„ã¾ã›ã‚“ã€‚<br>
            å„éƒ¨ã®åç§°ã ã‘ã‚’ä½œæˆã—ãŸã„å ´åˆã¯ã€ã“ã®ã‚¨ãƒªã‚¢ã ã‘ã‚’å˜ç‹¬ã§ä½¿ç”¨ã—ã¦ã‚‚å•é¡Œã‚ã‚Šã¾ã›ã‚“ã€‚
        </p>`;
    area.appendChild(header);

    // ä»¥é™ï¼ˆforEach ã§ç”»åƒã”ã¨ã®ã‚¨ãƒ‡ã‚£ã‚¿ã‚’ä½œã‚‹éƒ¨åˆ†ï¼‰ã¯æ—¢å­˜ã®ã¾ã¾

    PARTS_IMAGES.forEach((img,idx) => {
        renumberBadges(img);
    syncBadgesAndNames(img);   // â˜… ã“ã“ã§æ•°ã‚’ãã‚ãˆã‚‹

const cont = document.createElement("div");
cont.className = "editor-container";
cont.innerHTML = `
    <div class="editor-header">
        <span>ç”»åƒ${idx+1}</span>
        <div class="flex items-center gap-2">
            <button
                type="button"
                class="text-[10px] px-2 py-0.5 border border-purple-400 text-purple-700 bg-white rounded hover:bg-purple-50"
                onclick="copyNumberedImage(${idx})">
                ãƒŠãƒ³ãƒãƒªãƒ³ã‚°æ¸ˆã¿ç”»åƒã‚’ã‚³ãƒ”ãƒ¼
            </button>
            <button
                type="button"
                class="text-[10px] px-2 py-0.5 bg-gray-200 text-gray-800 rounded border border-gray-300"
                onclick="clearPartNames(${idx})">
                ã“ã®ç”»åƒã®ãƒŠãƒ³ãƒãƒªãƒ³ã‚°ã¨åç§°ã‚’ã‚¯ãƒªã‚¢
            </button>
            <span class="text-red-500 cursor-pointer" onclick="removeFile('parts',${idx})">Ã—</span>
        </div>
    </div>`;

        const row = document.createElement("div");
        row.className = "flex gap-2 items-start";

        const wrap = document.createElement("div");
        wrap.className = "editor-wrapper";
        wrap.innerHTML = `<img src="${img.dataUrl}" class="editor-img">`;

        img.badges.forEach((b,bi) => {
            const bg = document.createElement("div");
            bg.className = "badge";
            bg.innerText = b.num;
            bg.style.left = b.x + "%";
            bg.style.top  = b.y + "%";

            bg.onmousedown = e => {
                e.stopPropagation();
                e.preventDefault();
                const move = ev => {
                    const r = wrap.getBoundingClientRect();
                    b.x = Math.max(0, Math.min(100, (ev.clientX - r.left)/r.width*100));
                    b.y = Math.max(0, Math.min(100, (ev.clientY - r.top )/r.height*100));
                    bg.style.left = b.x + "%";
                    bg.style.top  = b.y + "%";
                };
                const up = () => {
                    document.removeEventListener("mousemove", move);
                    document.removeEventListener("mouseup", up);
                };
                document.addEventListener("mousemove", move);
                document.addEventListener("mouseup", up);
            };

            bg.ondblclick = e => {
                e.stopPropagation();
                img.badges.splice(bi,1);
                renderImageEditors();
            };

            wrap.appendChild(bg);
        });

        wrap.oncontextmenu = e => {
            e.preventDefault();
            const r = wrap.getBoundingClientRect();
            img.badges.push({
                num: img.badges.length + 1,
                x:  (e.clientX - r.left)/r.width*100,
                y:  (e.clientY - r.top )/r.height*100
            });
            renumberBadges(img);
            renderImageEditors();
        };

const side = document.createElement("div");
side.className = "flex-1 flex flex-col gap-1";

// å…ˆé ­ã®æ”¹è¡Œãƒ»ç©ºç™½ã‚’ã•ã‚‰ã«å¿µå…¥ã‚Šã«å‰Šã‚‹
const namesTextRaw = img.names || "";
const namesText = namesTextRaw
    .replace(/^\s+/, "")            // å…ˆé ­ã®ç©ºç™½ãƒ»æ”¹è¡Œã‚’å‰Šé™¤
    .replace(/\r?\n\s+\r?\n/g, "\n") // é€£ç¶šç©ºè¡Œã®åœ§ç¸®
    .trim();

// ä¸Šéƒ¨ï¼ˆãƒ©ãƒ™ãƒ«ï¼‹ãƒœã‚¿ãƒ³ï¼‰ã¯ innerHTML ã§ OKï¼ˆã“ã“ã¯ pre-wrap ã§ã¯ãªã„ï¼‰
side.innerHTML = `
    <label class="text-[10px] font-bold text-gray-600">
        åç§°æ¡ˆã¸ã®è¦æœ›
        <input type="text"
            class="w-full border rounded px-1 py-0.5 text-[10px] mt-0.5"
            placeholder="ä¾‹ï¼‰ãƒã‚¦ã‚¹ã®éƒ¨ä½åç§°ã¨ã—ã¦è‡ªç„¶ãªè¡¨ç¾ã«ã—ã¦ãã ã•ã„"
            value="${img.nameHint||""}"
            oninput="updateNameHint(${idx},this.value)">
    </label>
    <div class="flex justify-between items-center mt-1 mb-1">
        <span class="text-[10px] font-bold text-gray-600">åç§°æ¡ˆ</span>
        <button class="text-[10px] px-2 py-0.5 bg-purple-500 text-white rounded"
            onclick="regenPartNames(${idx})">
            ã“ã®ç”»åƒã®åç§°æ¡ˆã‚’ç”Ÿæˆ
        </button>
    </div>
`;

// åç§°æ¡ˆ textarea
const namesBox = document.createElement("textarea");
namesBox.className = "w-full border rounded p-1 text-[10px] leading-4 bg-white parts-names-box";
namesBox.rows = 6;
namesBox.value = namesText || "";
namesBox.placeholder = "ï¼ˆåç§°æ¡ˆãªã—ï¼‰";

// å…¥åŠ›ã—ãŸå†…å®¹ã‚’å³æ™‚åæ˜ 
namesBox.oninput = () => {
    PARTS_IMAGES[idx].names = namesBox.value;
};

side.appendChild(namesBox);



        row.appendChild(wrap);
        row.appendChild(side);
        cont.appendChild(row);
        area.appendChild(cont);
    });
}

function updateNameHint(idx, val){
    if(!PARTS_IMAGES[idx]) return;
    PARTS_IMAGES[idx].nameHint = val;
}

async function copyNumberedImage(idx){
    const img = PARTS_IMAGES[idx];
    if (!img) return;

    if (!navigator.clipboard || !window.ClipboardItem) {
        alert("ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã§ã¯ç”»åƒã®ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã‚³ãƒ”ãƒ¼ã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“ã€‚\nå¿…è¦ã«å¿œã˜ã¦ Word å‡ºåŠ›æ©Ÿèƒ½ãªã©ã‚’ã”åˆ©ç”¨ãã ã•ã„ã€‚");
        return;
    }

    const base = new Image();
    base.onload = () => {
        const canvas = document.getElementById("processCanvas");
        const ctx = canvas.getContext("2d");

        canvas.width  = base.width;
        canvas.height = base.height;

        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.drawImage(base, 0, 0);

        // ãƒŠãƒ³ãƒãƒªãƒ³ã‚°ã‚’æ›¸ãè¾¼ã¿
        if (img.badges && img.badges.length) {
            const sX = base.width / 100;
            const sY = base.height / 100;
            const r  = Math.max(20, base.width * 0.03);

            ctx.font = `bold ${r}px Arial`;
            ctx.textAlign = "center";
            ctx.textBaseline = "middle";

            img.badges.forEach(b => {
                ctx.beginPath();
                ctx.arc(b.x * sX, b.y * sY, r, 0, 2 * Math.PI);
                ctx.fillStyle = "red";
                ctx.fill();
                ctx.fillStyle = "white";
                ctx.fillText(b.num, b.x * sX, b.y * sY);
            });
        }

        canvas.toBlob(async blob => {
            if (!blob) {
                alert("ç”»åƒã®ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
                return;
            }
            try {
                await navigator.clipboard.write([
                    new ClipboardItem({ "image/png": blob })
                ]);
                showToast(`ç”»åƒ${idx+1}ã‚’ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ`);
            } catch (e) {
                console.error(e);
                alert("ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã¸ã®ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
            }
        });
    };
    base.src = img.dataUrl;
}


/* coords ãƒ†ã‚­ã‚¹ãƒˆåŒ– */
function coordsText(img){
    if(!img.badges || !img.badges.length) return "";
    return img.badges.map(b =>
        `${b.num}. x=${b.x.toFixed(1)}%, y=${b.y.toFixed(1)}%`
    ).join("\n");
}

async function generatePartsNamesAll(){
  if(!PARTS_IMAGES.length){
    alert("ç”»åƒãŒã‚ã‚Šã¾ã›ã‚“");
    return;
  }

  // â˜… ãƒŠãƒ³ãƒãƒªãƒ³ã‚°ã•ã‚Œã¦ã„ãªã„ç”»åƒãŒãªã„ã‹ãƒã‚§ãƒƒã‚¯
  const noBadgeList = PARTS_IMAGES
    .map((img, i) => (!img.badges || !img.badges.length) ? (i + 1) : null)
    .filter(v => v !== null);

  if (noBadgeList.length) {
    alert(
      "ä»¥ä¸‹ã®ç”»åƒã«ãƒŠãƒ³ãƒãƒªãƒ³ã‚°ãŒã‚ã‚Šã¾ã›ã‚“ã€‚\n" +
      "å…ˆã«å³ã‚¯ãƒªãƒƒã‚¯ã§ç•ªå·ã‚’ä»˜ã‘ã¦ãã ã•ã„ã€‚\n\n" +
      "ç”»åƒ" + noBadgeList.join(", ")
    );
    return;
  }

  document.getElementById("loadingOverlay").style.display = "flex";

  try {
    for(let i=0;i<PARTS_IMAGES.length;i++){
      await regenPartNames(i, true);
    }
    showToast("å„éƒ¨åç§°ã®åç§°æ¡ˆã‚’ç”Ÿæˆã—ã¾ã—ãŸ");
  } catch(e) {
    console.error(e);
    alert("åç§°æ¡ˆç”Ÿæˆä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: " + e.message);
  } finally {
    document.getElementById("loadingOverlay").style.display = "none";
  }
}



window.regenPartNames = async function(idx, silent){
  const img = PARTS_IMAGES[idx];
  if (!img) return;

  // â˜…ã“ã“ã‹ã‚‰å…ˆã¯å…ƒã®ã¾ã¾ï¼ˆcoordsText / callAI ãªã©ï¼‰
  const coordLines = coordsText(img);
  const hint = img.nameHint ? `ï¼ˆåç§°è¡¨ç¾ã®è¦æœ›ï¼š${img.nameHint}ï¼‰\n` : "";

  const prompt = `ä»¥ä¸‹ã®ç”»åƒã®éƒ¨å“åç§°ã‚’ã€é«˜ç²¾åº¦ã§ç‰¹å®šã—ã¦ãã ã•ã„ã€‚
  ...ï¼ˆä¸­ç•¥ï¼šå…ƒã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãã®ã¾ã¾ï¼‰...`;

  if (!silent) {
    document.getElementById("loadingOverlay").style.display = "flex";
  }
  try {
    const raw = await callAI(prompt, img.dataUrl);
    img.names = normalizeNameText(raw);
    img.badges = img.badges
      .sort((a,b) => a.num - b.num)
      .map((b,i) => ({...b, num:i+1}));
    renderImageEditors();
    if (!silent) showToast(`ç”»åƒ${idx+1} ã®åç§°æ¡ˆã‚’æ›´æ–°ã—ã¾ã—ãŸ`);
  } catch(e) {
    console.error(e);
    if (!silent) alert("åç§°æ¡ˆç”Ÿæˆä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒèµ·ãã¾ã—ãŸ: " + e.message);
  } finally {
    if (!silent) document.getElementById("loadingOverlay").style.display = "none";
  }
};


// æ—¢å­˜ãƒ‰ãƒ©ãƒ•ãƒˆã¨æ„å‘³ãŒè¿‘ã„æ–‡ã‚’ã§ãã‚‹ã ã‘é™¤å¤–
function filterNewLinesByExisting(draft, blockText){
    if (!blockText) return "";
    const normDraft = draft.replace(/[ã€‚ã€ï¼ï¼Œ,ãƒ»\s]/g, "");

    const lines = blockText.split("\n")
        .map(l => l.trim())
        .filter(l => l && !l.startsWith("ã€"));

    const kept = [];
    for (const line of lines) {
        const pure = line.replace(/^ãƒ»/, "").trim();
        const normLine = pure.replace(/[ã€‚ã€ï¼ï¼Œ,ãƒ»\s]/g, "");
        if (normLine.length >= 8) {
            const sub = normLine.slice(0, Math.floor(normLine.length * 0.7));
            if (normDraft.includes(sub)) {
                continue;   // æ—¢å­˜ã¨ã‹ãªã‚Šä¼¼ã¦ã„ã‚‹ã®ã§æ¨ã¦ã‚‹
            }
        }
        kept.push(line);
    }
    return kept.join("\n");
}

// ãƒ©ãƒ™ãƒ«ã”ã¨ã«ãƒ–ãƒ­ãƒƒã‚¯ã‚’æŠœãå‡ºã™
function extractBlock(raw, label, nextLabels){
    const pos = raw.indexOf(label);
    if (pos === -1) return "";
    const start = pos + label.length;
    let end = raw.length;
    nextLabels.forEach(l => {
        const p = raw.indexOf(l, start);
        if (p !== -1 && p < end) end = p;
    });
    return raw.slice(start, end).trim();
}


// ã€Œâ– ä½¿ç”¨æ–¹æ³•ã€ãƒ–ãƒ­ãƒƒã‚¯ã®æœ«å°¾ã«è¿½è¨˜ã‚’å·®ã—è¾¼ã‚€
function insertUsageAppend(draft, usageBlock){
    if (!usageBlock) return draft;

    const marker = "â– ä½¿ç”¨æ–¹æ³•";
    const idx = draft.indexOf(marker);
    if (idx < 0) return draft + "\n\n" + usageBlock;

    const after = idx + marker.length;
    const nextHeadingIdx = draft.indexOf("â– ", after);
    const insertPos = nextHeadingIdx === -1 ? draft.length : nextHeadingIdx;

    const head = draft.slice(0, insertPos).replace(/\s*$/, "");
    const tail = draft.slice(insertPos);

    return head + "\n" + usageBlock + "\n" + tail;
}

// ã€Œâ– ä»•æ§˜ã€ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®ä¸­ã§ã€å‹ç•ªè¡Œã®ç›´å¾Œã«ä»•æ§˜æœ¬æ–‡ã‚’å·®ã—è¾¼ã‚€
function insertSpecCore(draft, specBlock){
    if (!specBlock) return draft;

    const lines = draft.split("\n");

    // ã¾ãšã€Œâ– ä»•æ§˜ã€ã®è¡Œã‚’æ¢ã™
    const specIdx = lines.findIndex(l => l.startsWith("â– ä»•æ§˜"));
    if (specIdx === -1) {
        // ä»•æ§˜ã‚»ã‚¯ã‚·ãƒ§ãƒ³è‡ªä½“ãŒãªã„å ´åˆã¯æœ«å°¾ã«è¶³ã™ã ã‘
        return draft + "\n" + specBlock;
    }

    // ã€Œâ– ä»•æ§˜ã€ä»¥é™ã§æœ€åˆã®ã€Œå‹ç•ªï¼šã€è¡Œã‚’æ¢ã™
    let typeLineIdx = -1;
    for (let i = specIdx + 1; i < lines.length; i++) {
        const t = lines[i].trim();
        if (t.startsWith("â– ")) break;              // æ¬¡ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã«åˆ°é”ã—ãŸã‚‰çµ‚äº†
        if (t.startsWith("å‹ç•ªï¼š")) {
            typeLineIdx = i;
            break;
        }
    }

    // å‹ç•ªè¡ŒãŒè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã¯ã€ã€Œâ– ä»•æ§˜ã€ã®ç›´å¾Œã«å…¥ã‚Œã‚‹
    const insertIdx = (typeLineIdx === -1) ? (specIdx + 1) : (typeLineIdx + 1);

    const insertLines = specBlock
        .split(/\r?\n/)
        .map(l => l.replace(/^ãƒ»\s*/, "").trim())    // è¡Œé ­ã®ã€Œãƒ»ã€ã¯å‰Šé™¤
        .filter(l => l !== "");

    lines.splice(insertIdx, 0, ...insertLines);

    return lines.join("\n");
}



// ä»»æ„ã®è¦‹å‡ºã—ï¼ˆä¾‹ï¼šâ– ä½¿ç”¨æ–¹æ³•ï¼‰ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’å·®ã—æ›¿ãˆã‚‹
function replaceSection(draft, title, body){
    const idx = draft.indexOf(title);
    if (idx < 0) return draft;
    const next = draft.indexOf("â– ", idx + title.length);
    const end  = next === -1 ? draft.length : next;
    const head = draft.slice(0, idx);
    const tail = draft.slice(end);
    const section = `${title}\n${body.trim()}\n\n`;
    return head + section + tail;
}

// è¦‹å‡ºã—ã‚¿ã‚¤ãƒˆãƒ«ã‹ã‚‰ã€ãã®ä¸­èº«ã ã‘ã‚’æŠœãå‡ºã™
function getSectionBody(draft, title){
    const idx = draft.indexOf(title);
    if (idx < 0) return "";
    const next = draft.indexOf("â– ", idx + title.length);
    const end  = next === -1 ? draft.length : next;
    return draft.slice(idx + title.length, end).trim();
}


// å‚è€ƒå…ƒãƒãƒ‹ãƒ¥ã‚¢ãƒ«(REF_TEXT)ã‹ã‚‰ã€Œâ– ä»•æ§˜ã€ãƒ–ãƒ­ãƒƒã‚¯ã ã‘æŠœãå‡ºã—ã¦ã€
// å•†å“åãƒ»å‹ç•ªã ã‘ç¾åœ¨ã®å€¤ã«å·®ã—æ›¿ãˆãŸæœ¬æ–‡ã‚’è¿”ã™ã€‚
// è¦‹ã¤ã‹ã‚‰ãªã‘ã‚Œã° null ã‚’è¿”ã™ã€‚
function buildSpecFromReference(pName, mNum){
    if (!REF_TEXT) return null;

    const lines = REF_TEXT.split(/\r?\n/);
    const idx = lines.findIndex(l => l.trim().startsWith("â– ä»•æ§˜"));
    if (idx === -1) return null;

    const body = [];
    for (let i = idx + 1; i < lines.length; i++) {
        const t = lines[i].trim();

        // æ¬¡ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ or å‚è€ƒãƒ•ã‚¡ã‚¤ãƒ«åˆ‡ã‚Šæ›¿ãˆã§çµ‚äº†
        if (t.startsWith("â– ") || t.startsWith("ã€å‚è€ƒ:")) break;

        body.push(lines[i]);
    }
    if (!body.length) return null;

    // å•†å“åãƒ»å‹ç•ªã‚’å·®ã—æ›¿ãˆ
    const nameLabel = `å•†å“åï¼š${pName || "ï¼ˆå•†å“åï¼‰"}`;
    const modelLabel = `å‹ç•ªï¼š${mNum || "ï¼ˆå‹ç•ªï¼‰"}`;

    let nameIdx  = body.findIndex(l => l.trim().startsWith("å•†å“å"));
    let modelIdx = body.findIndex(l => l.trim().startsWith("å‹ç•ª"));

    if (nameIdx === -1 && modelIdx === -1) {
        // å‚è€ƒå…ƒã«å•†å“åãƒ»å‹ç•ªãŒç„¡ã„å ´åˆã¯å…ˆé ­ã«è¿½åŠ 
        body.unshift(modelLabel);
        body.unshift(nameLabel);
    } else {
        if (nameIdx !== -1)  body[nameIdx]  = nameLabel;
        if (modelIdx !== -1) body[modelIdx] = modelLabel;
    }

    return body.join("\n");
}


// å‚è€ƒå…ƒãƒãƒ‹ãƒ¥ã‚¢ãƒ«ã‹ã‚‰ã€Œâ– ä½¿ç”¨æ–¹æ³•ã€ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã ã‘æŠœãå‡ºã™ï¼ˆã‚ã‚Œã°ï¼‰
function getRefUsageBlock() {
    if (!REF_TEXT) return "";

    const lines = REF_TEXT.split(/\r?\n/);
    const idx = lines.findIndex(raw => raw.trim().startsWith("â– ä½¿ç”¨æ–¹æ³•"));
    if (idx === -1) return "";

    const body = [];
    for (let i = idx + 1; i < lines.length; i++) {
        const t = lines[i].trim();
        // æ¬¡ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ or å‚è€ƒãƒ•ã‚¡ã‚¤ãƒ«åˆ‡ã‚Šæ›¿ãˆã§çµ‚äº†
        if (t.startsWith("â– ") || t.startsWith("ã€å‚è€ƒ:")) break;
        body.push(lines[i]);
    }
    return body.join("\n").trim();
}


// REF_TEXT ã‹ã‚‰ã€Œâ– ä»•æ§˜ã€ãƒ–ãƒ­ãƒƒã‚¯ã ã‘ã‚’æŠœãå‡ºã™
function getRefSpecBlock() {
    if (!REF_TEXT) return "";

    const src = REF_TEXT;

    // è¦‹å‡ºã—å€™è£œï¼ˆPDF/Word ã§å¾®å¦™ã«é•ã†å¯èƒ½æ€§ã‚‚è€ƒæ…®ï¼‰
    const heads = ["â– ä»•æ§˜", "â–  ä»•æ§˜", "[ä»•æ§˜]", "ã€ä»•æ§˜ã€‘"];
    let start = -1;
    for (const h of heads) {
        start = src.indexOf(h);
        if (start !== -1) break;
    }

    // è¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã¯å…¨ä½“ã®å…ˆé ­ã ã‘ã‚’å‚è€ƒã«ã™ã‚‹
    if (start === -1) {
        return src.substring(0, 1500);
    }

    // æ¬¡ã®ã€Œâ– ã€è¦‹å‡ºã—ã¾ã§ã‚’ä»•æ§˜ãƒ–ãƒ­ãƒƒã‚¯ã¨ã¿ãªã™
    let end = src.indexOf("â– ", start + 2);
    if (end === -1) end = src.length;

    // ãƒˆãƒ¼ã‚¯ãƒ³æ•°ã‚’æŠ‘ãˆã‚‹ãŸã‚ã«æœ€å¤§ 2000 æ–‡å­—ãã‚‰ã„ã§ã‚«ãƒƒãƒˆ
    return src.slice(start, Math.min(end, start + 2000));
}

// å‚è€ƒå…ƒãƒãƒ‹ãƒ¥ã‚¢ãƒ«ã‹ã‚‰ã€Œâ– ä»•æ§˜ã€ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã ã‘ã‚’ãã®ã¾ã¾å–ã‚Šå‡ºã™
// ãƒ»â– ä»•æ§˜ ã®è¡Œã®æ¬¡ã®è¡Œã‹ã‚‰ã€æ¬¡ã®ã€Œâ– ã€è¦‹å‡ºã—ã¾ã§ã‚’ä»•æ§˜ã¨ã¿ãªã™
// ãƒ»å•†å“åï¼è£½å“åï¼å‹ç•ªã®è¡Œã¯é™¤å¤–
// ãƒ»æœ€å¾Œã«ã€Œå‚è€ƒå…ƒã®ä»•æ§˜ã§ã‚ã‚‹ã€æ—¨ã®æ³¨æ„æ›¸ãã‚’è¿½åŠ 
function buildVerbatimSpecFromReference() {
    if (!REF_TEXT) return null;

    const allLines = REF_TEXT.split(/\r?\n/);

    // ã€Œâ– ä»•æ§˜ã€ã€Œâ–  ä»•æ§˜ã€ã€Œã€ä»•æ§˜ã€‘ã€ã€Œï¼»ä»•æ§˜ï¼½ã€ã®ã„ãšã‚Œã‹ã‚’æ¢ã™
    const specHeadIdx = allLines.findIndex(raw => {
        const t = raw.trim();
        if (!t) return false;
        if (t.startsWith("â– ä»•æ§˜")) return true;
        if (t.startsWith("â–  ä»•æ§˜")) return true;
        if (/^[ã€ï¼»]\s*ä»•æ§˜\s*[ã€‘ï¼½]/.test(t)) return true;
        return false;
    });

    if (specHeadIdx === -1) {
        // å‚è€ƒå…ƒã«ã€Œä»•æ§˜ã€ã®è¦‹å‡ºã—ãŒè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã¯ä½•ã‚‚ã—ãªã„
        return null;
    }

    // è¦‹å‡ºã—ã®æ¬¡ã®è¡Œã‹ã‚‰ã€æ¬¡ã®ã€Œâ– ã€ã¾ãŸã¯ã€Œã€å‚è€ƒ:ã€ã¾ã§ã‚’ä»•æ§˜æœ¬æ–‡ã¨ã™ã‚‹
    const bodyLines = [];
    for (let i = specHeadIdx + 1; i < allLines.length; i++) {
        const t = allLines[i].trim();

        if (!t) {
            bodyLines.push(allLines[i]);
            continue;
        }

        // æ¬¡ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³é–‹å§‹ã§çµ‚äº†
        if (t.startsWith("â– ") || t.startsWith("ã€å‚è€ƒ:")) {
            break;
        }

        bodyLines.push(allLines[i]);
    }

    if (!bodyLines.length) return null;

    // â–¼ å•†å“åï¼è£½å“åï¼å‹ç•ªã®è¡Œã¯é™¤å¤–
    let lines = bodyLines.filter(raw => {
        const t = raw.trim();
        if (!t) return false;
        if (t.startsWith("å•†å“å")) return false;
        if (t.startsWith("è£½å“å")) return false;
        if (t.startsWith("å‹ç•ª"))   return false;
        return true;
    });

    // å…ˆé ­ãƒ»æœ«å°¾ã®ç©ºè¡Œã‚’æ•´ç†
    while (lines.length && !lines[0].trim()) lines.shift();
    while (lines.length && !lines[lines.length - 1].trim()) lines.pop();

    if (!lines.length) return null;

    // æœ€å¾Œã«æ³¨æ„æ›¸ãã‚’è¿½åŠ 
    lines.push(
        "",
        "â€»ä¸Šè¨˜ä»•æ§˜å€¤ã¯å‚è€ƒå…ƒã®å–æ‰±èª¬æ˜æ›¸ã«è¨˜è¼‰ã•ã‚ŒãŸæƒ…å ±ã§ã‚ã‚Šã€æœ¬è£½å“ã®æœ€çµ‚ä»•æ§˜ã¨ã¯ç•°ãªã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ã€‚å¿…ãšæœ€æ–°ã®ä»•æ§˜ã‚’ã”ç¢ºèªãã ã•ã„ã€‚"
    );

    return lines.join("\n");
}




/* ---- åŸç¨¿ç”Ÿæˆ ---- */
async function runGenerationProcess(){
    if(!RAW_DATA.length){ alert("Excelã‚’èª­ã¿è¾¼ã‚“ã§ãã ã•ã„"); return; }
    if(!SELECTED_COMPANY){ alert("åç¾©ã‚’é¸æŠã—ã¦ãã ã•ã„"); return; }

    // å„éƒ¨åç§°ã®ãƒŠãƒ³ãƒãƒªãƒ³ã‚°ç¢ºèª
    const hasParts  = PARTS_IMAGES.length > 0;
    const hasBadges = PARTS_IMAGES.some(img => img.badges && img.badges.length > 0);

    if (hasParts && !hasBadges) {
        const ok = confirm("ã€Œå„éƒ¨ã®åç§°ã€ã®ç”»åƒã«ãƒŠãƒ³ãƒãƒªãƒ³ã‚°ãŒã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚\nã“ã®ã¾ã¾åŸç¨¿ã‚’ç”Ÿæˆã—ã¦ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ");
        if (!ok) return;
    }

    document.getElementById("loadingOverlay").style.display = "flex";

    try{
        await new Promise(r => setTimeout(r, 50));
        let draft = buildDraft();

        // â˜… å‚è€ƒå…ƒã®ä»•æ§˜ã‚’ãã®ã¾ã¾ä»•æ§˜ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã«æŒ¿å…¥
        const verbSpec = buildVerbatimSpecFromReference();
        if (verbSpec) {
            draft = insertSpecCore(draft, verbSpec);
        }

        // å„éƒ¨åç§°ï¼ˆç”»åƒ1ã€œï¼‰ã‚’ã€Œâ– å„éƒ¨ã®åç§°ã€ã«å·®ã—è¾¼ã‚€
        if(PARTS_IMAGES.length){
            let pTxt = "";
            PARTS_IMAGES.forEach((img,i) => {
                if(img.names){
                    pTxt += `\n(ç”»åƒ${i+1})\n${img.names}\n`;
                }
            });
            if(pTxt){
                draft = draft.replace("â– å„éƒ¨ã®åç§°",
                    "â– å„éƒ¨ã®åç§°\n" + pTxt.trim() + "\n");
            }
        }

    // --- AI ã«ã‚ˆã‚‹ã€Œä½¿ç”¨æ–¹æ³•ã€ã€Œä»•æ§˜ã€ã€Œå®‰å…¨ä¸Šã®ã”æ³¨æ„è¿½è¨˜ã€ã®ä½œæˆï¼å·®ã—æ›¿ãˆ ---
    const memo = document.getElementById("productFeatures").value || "";

    // å„éƒ¨åç§°ï¼ˆç”»åƒå´ã§å…¥åŠ›ã—ãŸåç§°ï¼‰ã‚’ã¾ã¨ã‚ã‚‹
    const partsNamesText = PARTS_IMAGES.map((img, idx) => {
        const names = (img.names || "").trim();
        if (!names) return "";
        return `ã€ç”»åƒ${idx + 1} å„éƒ¨ã®åç§°ã€‘\n${names}`;
    }).filter(Boolean).join("\n\n");

if (memo || REF_TEXT || USAGE_IMAGES.length || partsNamesText) {
  const usageDraft = getSectionBody(draft, "â– ä½¿ç”¨æ–¹æ³•");
        const refUsage   = getRefUsageBlock();   // â˜…è¿½åŠ 

        const prompt =
`ã‚ãªãŸã¯æ—¥æœ¬èªãƒãƒ‹ãƒ¥ã‚¢ãƒ«ã®å°‚é–€ãƒ©ã‚¤ã‚¿ãƒ¼ã§ã™ã€‚æ—¥æœ¬èªã ã‘ã§å›ç­”ã—ã¦ãã ã•ã„ã€‚

ç›®çš„ï¼š
1. å‚è€ƒå…ƒãƒãƒ‹ãƒ¥ã‚¢ãƒ«ã‚’ã§ãã‚‹ã ã‘å°Šé‡ã—ã¤ã¤ã€
   ãƒ»ã€Œâ– ä½¿ç”¨æ–¹æ³•ã€ã‚’ã€ã€‘ä»˜ãã®é …ç›®è¦‹å‡ºã—ã”ã¨ã«æ•´ç†ã—ãŸå…¨æ–‡ã«æ›¸ãç›´ã™
2. è¿½åŠ ã§å¿…è¦ãã†ãªå®‰å…¨ä¸Šã®æ³¨æ„ãŒã‚ã‚Œã°ã€ã€Œå®‰å…¨ä¸Šã®ã”æ³¨æ„ï¼ˆè¿½è¨˜æ¡ˆï¼‰ã€ã¨ã—ã¦ææ¡ˆã™ã‚‹ã€‚

ã€è£œè¶³ãƒ¡ãƒ¢ãƒ»æŒ‡ç¤ºã€‘
${memo || "ï¼ˆç‰¹ã«ãªã—ï¼‰"}

ã€å‚è€ƒè³‡æ–™ï¼ˆæŠœç²‹ï¼‰ã€‘
${(REF_TEXT || "ï¼ˆãªã—ï¼‰").substring(0, 3000)}

ã€å„éƒ¨ã®åç§°ï¼ˆç”»åƒã‹ã‚‰å…¥åŠ›æ¸ˆã¿ã®ã‚‚ã®ï¼‰ã€‘
${partsNamesText || "ï¼ˆæœªå…¥åŠ›ï¼‰"}

ã€æ—¢å­˜ãƒ‰ãƒ©ãƒ•ãƒˆã®ã€ä½¿ç”¨æ–¹æ³•ã€æœ¬æ–‡ã€‘
${usageDraft || "ï¼ˆã¾ã æœ¬æ–‡ãªã—ï¼‰"}

ã€å‚è€ƒå…ƒã®ã€ä½¿ç”¨æ–¹æ³•ã€æœ¬æ–‡ï¼ˆã‚ã‚Œã°ï¼‰ã€‘
${refUsage || "ï¼ˆè©²å½“ç®‡æ‰€ãªã—ï¼‰"}

æ¡ä»¶ï¼š
- ä½¿ç”¨æ–¹æ³•ã®é …ç›®åã¯ã€Œã€é›»æ± ã‚’å–ã‚Šä»˜ã‘ã‚‹ã€‘ã€ã®ã‚ˆã†ã«ã€ã€‘ã§å›²ã¿ã€
  ã§ãã‚‹ã ã‘å‚è€ƒå…ƒãƒãƒ‹ãƒ¥ã‚¢ãƒ«ã®è¦‹å‡ºã—åã«æƒãˆã¦ãã ã•ã„ã€‚
- ä½¿ç”¨æ–¹æ³•ã§å‡ºã¦ãã‚‹éƒ¨å“åã¯ã€å¿…ãšã€Œå„éƒ¨ã®åç§°ã€ã§ä½¿ã‚ã‚Œã¦ã„ã‚‹åç§°ã«æƒãˆã¦ãã ã•ã„ã€‚
- ä»•æ§˜ã«é–¢ã™ã‚‹å‡ºåŠ›ã¯ä¸€åˆ‡è¡Œã‚ãªã„ã§ãã ã•ã„ã€‚
- **å‚è€ƒå…ƒã®ã€ä½¿ç”¨æ–¹æ³•ã€ãŒå­˜åœ¨ã™ã‚‹å ´åˆã¯ã€è¡Œæ•°ã‚„æ–‡å­—æ•°ã®ãƒœãƒªãƒ¥ãƒ¼ãƒ ãŒå¤§ããå¤‰ã‚ã‚‰ãªã„ã‚ˆã†ã«ã—ã¦ãã ã•ã„ï¼ˆÂ±30ï¼…ç¨‹åº¦ã®ç¯„å›²ã«åã‚ã‚‹ã‚¤ãƒ¡ãƒ¼ã‚¸ï¼‰ã€‚**

å‡ºåŠ›å½¢å¼ï¼ˆå³å®ˆï¼‰ï¼š
ä¸‹è¨˜ã®2ãƒ–ãƒ­ãƒƒã‚¯ã ã‘ã‚’ã“ã®é †ç•ªã§å‡ºåŠ›ã—ã¦ãã ã•ã„ã€‚

ã€ä½¿ç”¨æ–¹æ³•å…¨æ–‡ã€‘
ï¼ˆã“ã“ã«ã€Œâ– ä½¿ç”¨æ–¹æ³•ã€ã®è¦‹å‡ºã—ã¯å«ã‚ãšã€ç›´ä¸‹ã«å…¥ã‚‹æœ¬æ–‡ã ã‘ã‚’æ›¸ãã€‚
ã€€ã€ã€‘ä»˜ãã®é …ç›®è¦‹å‡ºã—ã¨ã€ãã®ä¸‹ã®ç®‡æ¡æ›¸ãã§æ§‹æˆã™ã‚‹ã“ã¨ï¼‰

ã€å®‰å…¨ä¸Šã®ã”æ³¨æ„è¿½è¨˜ã€‘
ï¼ˆå¿…è¦ã ã¨æ€ã†è¿½è¨˜ã ã‘ã€Œãƒ»ã€ä»˜ãç®‡æ¡æ›¸ãã§æ›¸ãã€‚ä¸è¦ãªã‚‰ç©ºæ¬„ã®ã¾ã¾ã§ã‚ˆã„ï¼‰
`;
        const imgContext = USAGE_IMAGES[0]?.dataUrl;
        const aiText = await callAI(prompt, imgContext);
        const raw = aiText.trim();

        const usageLabelAll = "ã€ä½¿ç”¨æ–¹æ³•å…¨æ–‡ã€‘";
        const safetyLabel   = "ã€å®‰å…¨ä¸Šã®ã”æ³¨æ„è¿½è¨˜ã€‘";

        const usageBody  = extractBlock(raw, usageLabelAll, [safetyLabel]);
        let   safetyBody = extractBlock(raw, safetyLabel,   [usageLabelAll]);

        // å®‰å…¨è¿½è¨˜ã ã‘ã¯æ—¢å­˜ãƒ‰ãƒ©ãƒ•ãƒˆã¨ã»ã¼åŒã˜æ–‡ã‚’å¼¾ã
        safetyBody = filterNewLinesByExisting(draft, safetyBody);

        // ä½¿ç”¨æ–¹æ³•ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’ã¾ã‚‹ã”ã¨å·®ã—æ›¿ãˆ
        if (usageBody) {
            draft = replaceSection(draft, "â– ä½¿ç”¨æ–¹æ³•", usageBody);
        }

        // å®‰å…¨ä¸Šã®ã”æ³¨æ„ã®è¿½è¨˜æ¡ˆã‚’æœ«å°¾ã«è¿½åŠ 
        if (safetyBody) {
            draft += `

â– å®‰å…¨ä¸Šã®ã”æ³¨æ„ï¼ˆè¿½è¨˜æ¡ˆï¼‰
${safetyBody}
`;
        }
    }
        document.getElementById("previewArea").value = draft;
        showToast("åŸç¨¿ã‚’ç”Ÿæˆã—ã¾ã—ãŸ");
    }catch(e){
        console.error(e);
        alert("åŸç¨¿ç”Ÿæˆä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: " + e.message);
    }finally{
        document.getElementById("loadingOverlay").style.display = "none";
    }
}

/* ---- Draftæ§‹ç¯‰ ---- */
function buildDraft(){
    const pName = document.getElementById("productName").value;
    const mNum  = document.getElementById("modelNumber").value;
    const warranty = document.getElementById("warrantyPeriod").value;
    const isSol = SELECTED_COMPANY === "3RS";


    const checked = Array.from(document.querySelectorAll('input[type="checkbox"]:checked'))
        .map(c => c.value);
    const hasLi = checked.some(s => s.includes("ãƒªãƒã‚¦ãƒ "));

    const rows = RAW_DATA.filter(r => {
        if(r.label.includes("å…±é€š") || r.label.includes("ä¸€èˆ¬")) return true;
        if(r.category.includes("å»ƒæ£„") && !hasLi && !checked.includes(r.label)) return false;
        return checked.includes(r.label);
    }).sort((a,b) => {
        const aT = a.label.includes("å…±é€šå†’é ­");
        const bT = b.label.includes("å…±é€šå†’é ­");
        if(aT && !bT) return -1;
        if(!aT && bT) return 1;
        const aB = a.label.includes("å…±é€šæœ«å°¾");
        const bB = b.label.includes("å…±é€šæœ«å°¾");
        if(aB && !bB) return 1;
        if(!aB && bB) return -1;
        return a.id - b.id;
    });

    const s = {
        Intro:[], Danger:[], Warning:[], Caution:[],
        UsageC:[], Giteki:[], Radio:[],
        Parts:[], Usage:[], Maint:[], Disp:[], Spec:[], Other:[]
    };
    const seen = new Set();

    rows.forEach(r => {
        let t = r.content;
        TERMINOLOGY.forEach(x => t = t.replace(x.p, x.r));
        if(seen.has(t)) return;
        seen.add(t);

        const c = r.category;
        if(c.includes("æŠ€é©")) s.Giteki.push(t);
        else if(c.includes("é›»æ³¢")) s.Radio.push(t);
        else if(c.includes("å±é™º")) s.Danger.push(t);
        else if(c.includes("è­¦å‘Š")) s.Warning.push(t);
        else if(c.includes("æ³¨æ„") && !c.includes("ä½¿ç”¨")) s.Caution.push(t);
        else if(c.includes("ä½¿ç”¨")) s.UsageC.push(t);
        else if(c.includes("å„éƒ¨")) s.Parts.push(t);
        else if(c.includes("ä½¿ç”¨æ–¹æ³•")) s.Usage.push(t);
        else if(c.includes("ãŠæ‰‹å…¥ã‚Œ")) s.Maint.push(t);
        else if(c.includes("å»ƒæ£„")) s.Disp.push(t);
        else if(c.includes("ä»•æ§˜")) s.Spec.push(t);
        else if(r.label.includes("å…±é€šå†’é ­")) s.Intro.push(t);
        else s.Other.push(t);
    });

    const L = [
        "ä½¿ç”¨ç”»åƒãƒªãƒ³ã‚¯",
        `å•†å“åï¼š${pName}`,
        `å‹ç•ªï¼š${mNum}`,
        "è£½å“å†™çœŸ",
        "ã“ã®ãŸã³ã¯ã€æœ¬è£½å“ã‚’ãŠè²·ã„ä¸Šã’ã„ãŸã ãèª ã«ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ã€‚",
        "å®‰å…¨ã«ã”ä½¿ç”¨ã„ãŸã ããŸã‚ã«ã‚‚æœ¬å–æ‰±èª¬æ˜æ›¸ã‚’å¿…ãšãŠèª­ã¿ã«ãªã‚Šã€å†…å®¹ã‚’ç†è§£ã—ã¦ã‹ã‚‰ã”ä½¿ç”¨ãã ã•ã„ã€‚",
        "ã¾ãŸã€æœ¬å–æ‰±èª¬æ˜æ›¸ã¯ã„ã¤ã§ã‚‚ã”è¦§ã«ãªã‚Œã‚‹å ´æ‰€ã«å¤§åˆ‡ã«ä¿ç®¡ã—ã¦ãã ã•ã„ã€‚",
        "æœ¬å–æ‰±èª¬æ˜æ›¸ã®å†…å®¹ã®ä¸€éƒ¨ã‚‚ã—ãã¯å…¨éƒ¨ã‚’ç„¡æ–­ã§è¤‡å†™ã€è»¢è¼‰ã™ã‚‹ã“ã¨ã¯ãŠã‚„ã‚ãã ã•ã„ã€‚",
        "â€»ä¸‡ä¸€ã€è¶³ã‚Šãªã„ã‚‚ã®ãŒã”ã–ã„ã¾ã—ãŸã‚‰ã€å¼Šç¤¾ãŠå•ã„åˆã‚ã›çª“å£ã«ã”é€£çµ¡ãã ã•ã„ã€‚",
        "â€»ãƒ‡ã‚¶ã‚¤ãƒ³åŠã³ä»•æ§˜ã«ã¤ã„ã¦ã¯ã€æ”¹è‰¯ã®ãŸã‚äºˆå‘Šãªã—ã«å¤‰æ›´ã™ã‚‹å ´åˆãŒã”ã–ã„ã¾ã™ã€‚",
        "â€»æœ¬æ›¸ã«è¨˜è¼‰ã—ã¦ã„ã‚‹è£½å“åã€ã‚µãƒ¼ãƒ“ã‚¹åç­‰ã¯å„ç¤¾ã®ç™»éŒ²å•†æ¨™ã§ã™ã€‚",
        ...s.Intro,
        ""
    ];

    L.push("â– å®‰å…¨ä¸Šã®ã”æ³¨æ„");
    if(s.Danger.length)  L.push("<å±é™º>", ...s.Danger.map(t=>"ãƒ»"+t));
    if(s.Warning.length) L.push("<è­¦å‘Š>", ...s.Warning.map(t=>"ãƒ»"+t));
    if(s.Caution.length) L.push("<æ³¨æ„>",  ...s.Caution.map(t=>"ãƒ»"+t));
    L.push("");

    if(s.UsageC.length){
        L.push("â– ä½¿ç”¨ä¸Šã®ã”æ³¨æ„", ...s.UsageC.map(t=>"ãƒ»"+t), "");
    }
    if(s.Giteki.length){
        L.push("â– æŠ€é©ãƒãƒ¼ã‚¯", ...s.Giteki, "");
    }
    if(s.Radio.length){
        L.push("â– é›»æ³¢ã«é–¢ã™ã‚‹æ³¨æ„äº‹é …", ...s.Radio, "");
    }

    L.push(
        "â– å„éƒ¨ã®åç§°",
        "â€»â€»è¡¨è¨˜ãƒ«ãƒ¼ãƒ«æ³¨æ„â€»â€»",
        "ã€Œã‚»ãƒ³ã‚µãƒ¼ã€â†’ã€Œã‚»ãƒ³ã‚µã€",
        "ã€Œãƒ¢ãƒ‹ã‚¿ãƒ¼ã€â†’ã€Œãƒ¢ãƒ‹ã‚¿ã€",
        "ã€Œãƒãƒƒãƒ†ãƒªãƒ¼ã€â†’ã€Œãƒãƒƒãƒ†ãƒªã€",
        "â€»â€»ä½¿ç”¨ã—ãŸç”»åƒã¯åˆ¥é€”ä¿å­˜ã—ã¦ãƒ‡ã‚¶ã‚¤ãƒŠãƒ¼ã¸å…±æœ‰ã™ã‚‹ã“ã¨â€»â€»",
        ...s.Parts.map(t=>"ãƒ»"+t),
        ""
    );

    L.push("â– ä½¿ç”¨æ–¹æ³•", ...s.Usage.map(t=>"ãƒ»"+t), "");

    L.push("â– ãŠæ‰‹å…¥ã‚Œæ–¹æ³•");
    if(s.Maint.length){
        L.push(...s.Maint);
    }else{
        L.push(
            "å¿…ãšæœ¬ä½“ã®é›»æºã‚’ã‚ªãƒ•ã«ã—ã¦ãã ã•ã„ã€‚",
            "æŸ”ã‚‰ã‹ã„å¸ƒã«ã€ãŠæ¹¯ã¾ãŸã¯æ°´ã‚’å«ã¾ã›å›ºãçµã£ã¦ã‹ã‚‰æ‹­ã„ã¦ãã ã•ã„ã€‚",
            "â€»æœ¬è£½å“ã‚’æ°´ã§ã¬ã‚‰ã•ãªã„ã§ãã ã•ã„ã€‚"
        );
    }
    L.push("");

    if(s.Disp.length){
        L.push("â– ã”ä½¿ç”¨æ¸ˆã¿ã®è£½å“ã®å»ƒæ£„ã«é–¢ã—ã¦", ...s.Disp, "");
    }

         L.push(
        "â– ä»•æ§˜",
        "â€»ä»˜å±å“ã¯æœ«å°¾ã«ã—ã¾ã™â€»",
        `å•†å“åï¼š${pName}`,
        `å‹ç•ªï¼š${mNum}`
    );
    // Excel ç”±æ¥ã®ä»•æ§˜æ–‡ï¼ˆs.Specï¼‰ã¯ã“ã“ã§ã¯ä½¿ã‚ãšã€
    // å‚è€ƒãƒãƒ‹ãƒ¥ã‚¢ãƒ«ã‹ã‚‰ AI / å‚è€ƒãƒãƒ‹ãƒ¥ã‚¢ãƒ«ã§å†æ§‹æˆã—ãŸå†…å®¹ã‚’å¾Œã‹ã‚‰æŒ¿å…¥ã™ã‚‹
    L.push("");



    if(s.Other.length){
        L.push("â– ãã®ä»–", ...s.Other.map(t=>"ãƒ»"+t), "");
    }

   // â– ã‚µãƒãƒ¼ãƒˆãƒ»ä¼æ¥­æƒ…å ±
if (SELECTED_COMPANY === "OTHER") {
    // ãã®ä»–åç¾©ï¼šã‚·ãƒ³ãƒ—ãƒ«ãªãƒ–ãƒ­ãƒƒã‚¯
    L.push(
        "â– ã‚µãƒãƒ¼ãƒˆãƒ»ä¼æ¥­æƒ…å ±",
        `ä¿è¨¼æœŸé–“ã€€${warranty}`,
        "",
        "å¯¾è±¡ã®ä¼æ¥­æƒ…å ±ã‚’è¨˜è¼‰"
    );
} else {
    // ã‚¹ãƒªãƒ¼ã‚¢ãƒ¼ãƒ«ï¼ã‚½ãƒªãƒ¥ãƒ¼ã‚·ãƒ§ãƒ³åç¾©ï¼šå¾“æ¥ã©ãŠã‚Š
    L.push(
        "â– ã‚µãƒãƒ¼ãƒˆãƒ»ä¼æ¥­æƒ…å ±",
        `ä¿è¨¼æœŸé–“ã€€${warranty}`,
        "â€»æ³¨æ–‡ç¢ºèªãƒ¡ãƒ¼ãƒ«ã€ã‚ã‚‹ã„ã¯åº—é ­è³¼å…¥ã®å ´åˆã¯è²©å£²åº—ã®ç´å“æ›¸ã‚„ãƒ¬ã‚·ãƒ¼ãƒˆãªã©ã€è³¼å…¥æ—¥ãŒã‚ã‹ã‚‹æ›¸é¢ã®ä¿ç®¡ã‚’ãŠé¡˜ã„è‡´ã—ã¾ã™ã€‚",
        "è£½å“ã«é–¢ã™ã‚‹ãŠå•ã„åˆã‚ã›å…ˆ",
        "ä¸‹è¨˜ãŠå•ã„åˆã‚ã›çª“å£ã‚‚ã—ãã¯è²©å£²åº—ã¸ãŠå•ã„åˆã‚ã›ãã ã•ã„ã€‚"
    );

    if (SELECTED_COMPANY === "3RS") {
        // ã‚½ãƒªãƒ¥ãƒ¼ã‚·ãƒ§ãƒ³åç¾©
        L.push(
            "Mail product-support@3rrr-hd.jp",
            "TEL 092-260-3031",
            "FAX 092-260-4077",
            "â€»è£½å“ã®ä¸å…·åˆã«ã‚ˆã‚‹ãŠå•ã„åˆã‚ã›ã«ã¤ãã¾ã—ã¦ã¯ã€å†…å®¹ç¢ºèªã®ãŸã‚ç”»åƒãŒå¿…è¦ãªå ´åˆãŒã‚ã‚Šã¾ã™ã€‚",
            "ãƒ¡ãƒ¼ãƒ«ã§ãŠå•ã„åˆã‚ã›ã„ãŸã ã‘ã¾ã™ã¨ã‚¹ãƒ ãƒ¼ã‚ºã§ã™ã€‚",
            "ã‚¹ãƒªãƒ¼ã‚¢ãƒ¼ãƒ«ã‚½ãƒªãƒ¥ãƒ¼ã‚·ãƒ§ãƒ³æ ªå¼ä¼šç¤¾",
            "ã€’ 812-0008",
            "ç¦å²¡å¸‚åšå¤šåŒºæ±å…‰äºŒä¸ç›®8-30 é«˜å…‰ç¬¬ä¸€ãƒ“ãƒ«2éš",
            "Web https://3rrr-hd.jp/"
        );
    } else {
        // ã‚¹ãƒªãƒ¼ã‚¢ãƒ¼ãƒ«åç¾©
        L.push(
            "Mail product-support@3rrr-hd.jp",
            "TEL 092-260-3031",
            "FAX 092-260-4077",
            "â€»è£½å“ã®ä¸å…·åˆã«ã‚ˆã‚‹ãŠå•ã„åˆã‚ã›ã«ã¤ãã¾ã—ã¦ã¯ã€å†…å®¹ç¢ºèªã®ãŸã‚ç”»åƒãŒå¿…è¦ãªå ´åˆãŒã‚ã‚Šã¾ã™ã€‚",
            "ãƒ¡ãƒ¼ãƒ«ã§ãŠå•ã„åˆã‚ã›ã„ãŸã ã‘ã¾ã™ã¨ã‚¹ãƒ ãƒ¼ã‚ºã§ã™ã€‚",
            "ã‚¹ãƒªãƒ¼ã‚¢ãƒ¼ãƒ«æ ªå¼ä¼šç¤¾",
            "THREE R CORP. JAPAN",
            "THREE R ãƒ­ã‚´",
            "ã€’ 812-0008",
            "ç¦å²¡å¸‚åšå¤šåŒºæ±å…‰äºŒä¸ç›®8-30 é«˜å…‰ç¬¬ä¸€ãƒ“ãƒ«2éš",
            "Web https://3rrr-hd.jp/"
        );
    }
}

L.push("ç¬¬1ç‰ˆ");


    return L.join("\n");
}

/* ---- AI å‘¼ã³å‡ºã—ï¼ˆãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰çµŒç”±ç‰ˆï¼‰ ---- */
async function callAI(prompt, img) {
  // img ã¯ dataURL ã¾ãŸã¯ null ã‚’æƒ³å®š
  const payload = {
    prompt,
    image: (typeof img === "string" && img.length > 0) ? img : null
  };

  const res = await fetch("/api/manual-ai", {
    method: "POST",
    headers: {
      "Content-Type": "application/json"
    },
    body: JSON.stringify(payload)
  });

  if (!res.ok) {
    const txt = await res.text();
    console.error("[callAI] manual-ai error:", txt);
    throw new Error("manual-ai API error: " + txt);
  }

  const data = await res.json();

  // manual-ai.js ãŒ { text: "ã€œAIã®è¿”äº‹ã€œ" } ã‚’è¿”ã™æƒ³å®š
  if (!data || typeof data.text !== "string") {
    console.error("[callAI] unexpected response:", data);
    throw new Error("manual-ai API response format error");
  }

  return data.text;
}

/* ---- Wordå‡ºåŠ› ---- */
window.exportToWord = async function () {
    try {
        const text = document.getElementById("previewArea").value;
        if (!text) {
            alert("ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãŒç©ºã§ã™");
            return;
        }

        const lines = text.split("\n");
// å‚è€ƒå…ƒä»•æ§˜ãƒ–ãƒ­ãƒƒã‚¯ã‹ã‚‰ã€Œå¼•ç”¨ä»•æ§˜è¡Œã‚»ãƒƒãƒˆã€ã‚’ä½œæˆ
const verbSpec = buildVerbatimSpecFromReference();
const quotedSpecSet = new Set(
    verbSpec
        ? verbSpec.split(/\r?\n/).map(l => l.trim()).filter(Boolean)
        : []
);
        // ç”»åƒ â†’ docx.ImageRun
        const processImg = async (arr, burnBadges) => {
            return Promise.all(arr.map(async img => {
                const c = document.createElement("canvas");
                const ctx = c.getContext("2d");
                const i = new Image();
                await new Promise(r => { i.onload = r; i.src = img.dataUrl || img.data; });

                c.width = i.width;
                c.height = i.height;
                ctx.drawImage(i, 0, 0);

                // å¿…è¦ãªã‚‰ãƒŠãƒ³ãƒãƒªãƒ³ã‚°ã‚’æ›¸ãè¾¼ã‚€
                if (burnBadges && img.badges) {
                    const sX = i.width / 100;
                    const sY = i.height / 100;
                    const r = Math.max(20, i.width * 0.03);
                    ctx.font = `bold ${r}px Arial`;
                    ctx.textAlign = "center";
                    ctx.textBaseline = "middle";
                    img.badges.forEach(b => {
                        ctx.beginPath();
                        ctx.arc(b.x * sX, b.y * sY, r, 0, 2 * Math.PI);
                        ctx.fillStyle = "red";
                        ctx.fill();
                        ctx.fillStyle = "white";
                        ctx.fillText(b.num, b.x * sX, b.y * sY);
                    });
                }

                const blob = await new Promise(r => c.toBlob(r));
                const ab = await blob.arrayBuffer();
                return new docx.ImageRun({
                    data: ab,
                    transformation: {
                        width: 300,
                        height: (300 * i.height) / i.width
                    }
                });
            }));
        };

        const partBlobs  = await processImg(PARTS_IMAGES, true);
        const usageBlobs = await processImg(USAGE_IMAGES, false);


        const children = [];

// â– ä»•æ§˜ å†…ã®çŠ¶æ…‹ç®¡ç†ç”¨ãƒ•ãƒ©ã‚°
let inSpecSection = false;   // ã€Œâ– ä»•æ§˜ã€ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®ä¸­ã‹ã©ã†ã‹
// å¼•ç”¨ä»•æ§˜è¡Œã‹ã©ã†ã‹ã¯ quotedSpecSet ã§åˆ¤å®šã™ã‚‹ã®ã§ inQuotedSpec ã¯å»ƒæ­¢


        for (const line of lines) {
            const trimmed = line.trim();



     // â– è¦‹å‡ºã—è¡Œã®å‡¦ç†
if (trimmed.startsWith("â– ")) {

    // ã€Œâ– ä»•æ§˜ã€é–‹å§‹ï¼çµ‚äº†ã‚’åˆ¤å®š
    if (trimmed === "â– ä»•æ§˜") {
        inSpecSection = true;
    } else {
        // åˆ¥ã®è¦‹å‡ºã—ã«æ¥ãŸã‚‰ä»•æ§˜ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã¯æŠœã‘ã‚‹
        inSpecSection = false;
    }

    // ã€Œâ– å„éƒ¨ã®åç§°ã€ã ã‘ã¯å¾Œã§ç”»åƒã‚’æŒ¿å…¥ã™ã‚‹ã®ã§åˆ¥å‡¦ç†
                if (trimmed.includes("â– å„éƒ¨ã®åç§°")) {
                    // è¦‹å‡ºã—
                    children.push(
                        new docx.Paragraph({
                            children: [
                                new docx.TextRun({
                                    text: trimmed,
                                    font: "Meiryo UI",
                                    bold: true,
                                    size: 24
                                })
                            ],
                            spacing: { before: 200, after: 100 }
                        })
                    );

                    // ç”»åƒ1, ç”»åƒ2...
                    if (partBlobs.length) {
                        partBlobs.forEach((b, index) => {
                            // ãƒ©ãƒ™ãƒ«
                            children.push(
                                new docx.Paragraph({
                                    children: [
                                        new docx.TextRun({
                                            text: `ç”»åƒ${index + 1}`,
                                            font: "Meiryo UI",
                                            bold: true,
                                            size: 21
                                        })
                                    ],
                                    spacing: { after: 50 }
                                })
                            );
                            // ç”»åƒæœ¬ä½“
                            children.push(
                                new docx.Paragraph({
                                    children: [b],
                                    spacing: { after: 200 }
                                })
                            );
                        });
                    }
                    continue; // ã“ã®è¡Œã¯å‡¦ç†æ¸ˆã¿
                }

                // é€šå¸¸ã®è¦‹å‡ºã—
                children.push(
                    new docx.Paragraph({
                        children: [
                            new docx.TextRun({
                                text: trimmed,
                                font: "Meiryo UI",
                                bold: true,
                                size: 24
                            })
                        ],
                        spacing: { before: 200, after: 100 }
                    })
                );
                continue;
            }

            // ã“ã“ã‹ã‚‰å…ˆã¯è¦‹å‡ºã—ä»¥å¤–

            // ç©ºè¡Œ
            if (!trimmed) {
                children.push(new docx.Paragraph({ text: "" }));
                continue;
            }



   // ãƒ†ã‚­ã‚¹ãƒˆãƒ©ãƒ³ã®åŸºæœ¬ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£
const makeRunProps = () => {
    const base = {
        text: trimmed,
        font: "Meiryo UI",
        size: 21
    };

    // â–¼ ã“ã®è¡ŒãŒã€Œå¼•ç”¨ä»•æ§˜ã€ã‹ã©ã†ã‹ã‚’åˆ¤å®š
    // ãƒ»ä»Šã€Œâ– ä»•æ§˜ã€ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®ä¸­ã«ã„ã‚‹ï¼ˆinSpecSection === trueï¼‰
    // ãƒ»ã‹ã¤ quotedSpecSet ã«å«ã¾ã‚Œã¦ã„ã‚‹è¡Œï¼ˆå‚è€ƒä»•æ§˜ãã®ã‚‚ã®ï¼‰
    const isQuotedSpecLine =
        inSpecSection && quotedSpecSet.has(trimmed);

    if (isQuotedSpecLine) {
        base.color = "FF0000";        // èµ¤å­—
        if (trimmed === SPEC_WARNING_LINE) {
            base.bold = true;         // ã“ã®è¡Œã ã‘å¤ªå­—
        }
    }

    return base;
};

            // ç®‡æ¡æ›¸ã
            if (trimmed.startsWith("ãƒ»")) {
                children.push(
                    new docx.Paragraph({
                        children: [
                            new docx.TextRun(makeRunProps())
                        ],
                        spacing: { after: 50 }
                    })
                );
                continue;
            }

            // ã€Œ<å±é™º>ã€ãªã©
            if (trimmed.startsWith("<") && trimmed.endsWith(">")) {
                children.push(
                    new docx.Paragraph({
                        children: [
                            new docx.TextRun({
                                text: trimmed,
                                font: "Meiryo UI",
                                bold: true,
                                size: 22
                            })
                        ],
                        spacing: { before: 100, after: 50 }
                    })
                );
                continue;
            }

            // é€šå¸¸æ–‡
            children.push(
                new docx.Paragraph({
                    children: [
                        new docx.TextRun(makeRunProps())
                    ],
                    spacing: { after: 50 }
                })
            );
        }

        // å‚è€ƒç”»åƒã¯æœ€å¾Œã«ã¾ã¨ã‚ã‚‹
        if (usageBlobs.length) {
            children.push(
                new docx.Paragraph({
                    children: [
                        new docx.TextRun({
                            text: "ã€å‚è€ƒç”»åƒã€‘",
                            font: "Meiryo UI",
                            bold: true
                        })
                    ],
                    pageBreakBefore: true
                })
            );

            usageBlobs.forEach((b, index) => {
                children.push(
                    new docx.Paragraph({
                        children: [
                            new docx.TextRun({
                                text: `å‚è€ƒç”»åƒ${index + 1}`,
                                font: "Meiryo UI",
                                bold: true,
                                size: 21
                            })
                        ],
                        spacing: { after: 50 }
                    })
                );
                children.push(
                    new docx.Paragraph({
                        children: [b],
                        spacing: { after: 200 }
                    })
                );
            });
        }

        const doc = new docx.Document({ sections:[{ children }] });
        const blob = await docx.Packer.toBlob(doc);

        const pName = document.getElementById("productName").value.trim();
        const mNum  = document.getElementById("modelNumber").value.trim();

        let fileName = "manual.docx";
        if (mNum && pName) {
            fileName = `${mNum} ${pName}.docx`;
        } else if (mNum || pName) {
            fileName = `${mNum || pName}.docx`;
        }

        saveAs(blob, fileName);
        showToast("Wordãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä¿å­˜ã—ã¾ã—ãŸ");
    } catch (e) {
        console.error(e);
        alert("Wordå‡ºåŠ›ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: " + e.message);
    }
};

/* ---- ãã®ä»– UI ---- */
function toggleGroup(el){
    const body = el.parentElement.nextElementSibling;
    const checks = body.querySelectorAll("input[type='checkbox']");
    checks.forEach(c => c.checked = false);   // è§£é™¤ã®ã¿
}

function clearChecks(id){
    document.getElementById(id).querySelectorAll("input[type='checkbox']")
        .forEach(c => c.checked = false);
}
function filterFunc(v){
    document.querySelectorAll("#funcArea .checkbox-card").forEach(c => {
        c.style.display = c.innerText.includes(v) ? "flex" : "none";
    });
}
</script>
</body>
</html>
